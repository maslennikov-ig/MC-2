# MegaCampus Production Deployment Guide

## Overview

MegaCampus uses a GitOps-based deployment approach with GitHub Actions for CI/CD. The production environment is hosted on a dedicated server with Docker Compose orchestration.

## Production Server

- **Host**: 95.81.98.230 (ai.megacampus.ru)
- **SSH Access**: `ssh megacampus-prod` (using claude-deploy user)
- **Deploy Path**: `/opt/megacampus`
- **Repository**: https://github.com/maslennikov-ig/MC-2.git
- **Branch**: master

## Architecture

The production stack consists of the following services:

1. **Web** (Next.js 15) - Port 3000 (internal)
2. **API** (Express + tRPC) - Port 4000 (internal)
3. **Worker** (BullMQ) - Background job processing
4. **Redis** - Queue and cache storage - Port 6379 (internal)
5. **Docling MCP** - Document processing service - Port 8000 (internal)
6. **Nginx Proxy** - Docling MCP proxy

All services are behind Nginx reverse proxy (managed separately) on ports 80/443.

## Container Images

Images are stored in GitHub Container Registry (ghcr.io):

- `ghcr.io/maslennikov-ig/mc-2/web:latest` - Web application
- `ghcr.io/maslennikov-ig/mc-2/api:latest` - API server and worker
- `ghcr.io/maslennikov-ig/mc-2/docling-mcp:latest` - Document processing (built manually)

## Deployment Methods

### 1. Automatic Deployment (Recommended)

Push to master branch triggers automatic deployment:

```bash
git push origin master
```

GitHub Actions workflow:
1. Waits for CI checks to pass
2. Builds Docker images
3. Pushes images to ghcr.io
4. Deploys to production server via SSH
5. Performs health checks
6. Rolls back on failure

### 2. Manual Deployment

For urgent fixes or manual intervention:

```bash
# Connect to server
ssh megacampus-prod

# Navigate to deployment directory
cd /opt/megacampus

# Run deployment script
GITHUB_TOKEN=<token> GITHUB_ACTOR=<username> bash scripts/deploy.sh production latest
```

The deploy script will:
- Pull latest code from git
- Pull latest Docker images
- Perform rolling update (zero downtime)
- Run health checks
- Create backups

### 3. Rollback

If deployment fails, automatic rollback is triggered. For manual rollback:

```bash
ssh megacampus-prod
cd /opt/megacampus
bash scripts/rollback.sh
```

## GitHub Actions Configuration

### Required Secrets

The following secrets must be configured in GitHub repository settings (Settings > Secrets and variables > Actions):

**Deployment:**
- `DEPLOY_SSH_KEY` - SSH private key for claude-deploy user

**Application (Supabase):**
- `SUPABASE_URL` - Supabase project URL
- `SUPABASE_ANON_KEY` - Public anon key
- `SUPABASE_SERVICE_KEY` - Service role key (admin access)
- `SUPABASE_JWT_SECRET` - JWT signing secret

**External Services:**
- `QDRANT_URL` - Vector database URL
- `QDRANT_API_KEY` - Qdrant API key
- `JINA_API_KEY` - Jina AI embedding API key
- `OPENROUTER_API_KEY` - LLM provider API key
- `ENCRYPTION_KEY` - Data encryption key (32+ characters)

### Workflow Files

- `.github/workflows/ci.yml` - CI pipeline (lint, test, build)
- `.github/workflows/deploy.yml` - CD pipeline (deploy to production)

## Server Setup

### Initial Setup

```bash
# Connect to server
ssh megacampus-prod

# Verify git configuration
cd /opt/megacampus/repo
git remote -v
git branch

# Create deployment directories
mkdir -p /opt/megacampus/{backups,logs,data/uploads,config,scripts}

# Copy docker-compose and scripts
cp repo/docker-compose.production.yml /opt/megacampus/
cp repo/nginx-docling-proxy.conf /opt/megacampus/
cp repo/scripts/*.sh /opt/megacampus/scripts/
chmod +x /opt/megacampus/scripts/*.sh
```

### Environment Variables

Environment variables are managed via `.env.production` file on the server. This file is automatically generated by GitHub Actions during deployment.

**Never commit `.env.production` to git!**

## Deployment Process

### Zero-Downtime Rolling Update

1. **Backup**: Current container IDs and images saved
2. **Pull**: Latest code and Docker images fetched
3. **Update Infrastructure**: Redis updated if needed
4. **Update API**: API container recreated with health check
5. **Update Worker**: Worker container recreated
6. **Update Web**: Web container recreated with health check
7. **Cleanup**: Old images removed

Health checks ensure new containers are healthy before old ones are removed.

## Health Checks

### Endpoints

- **Web**: `http://localhost:3000/api/health`
- **API**: `http://localhost:4000/health`
- **Public**: `https://ai.megacampus.ru/api/health`

### Monitoring

```bash
# Check container status
ssh megacampus-prod "docker ps"

# Check container logs
ssh megacampus-prod "docker logs -f megacampus-web"
ssh megacampus-prod "docker logs -f megacampus-api"
ssh megacampus-prod "docker logs -f megacampus-worker"

# Check health status
ssh megacampus-prod "docker inspect --format='{{.State.Health.Status}}' megacampus-web"
```

## Troubleshooting

### Deployment Failed

1. Check GitHub Actions logs for errors
2. Check container logs on server
3. Verify secrets are configured correctly
4. Check disk space: `ssh megacampus-prod "df -h"`
5. Check memory: `ssh megacampus-prod "free -h"`

### Container Unhealthy

```bash
# Restart specific service
ssh megacampus-prod "cd /opt/megacampus && docker compose -f docker-compose.production.yml restart <service>"

# View logs
ssh megacampus-prod "docker logs --tail 100 megacampus-<service>"
```

### Cannot Pull Images

```bash
# Login to GitHub Container Registry
echo $GITHUB_TOKEN | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

# Verify token has packages:read permission
```

### Git Issues on Server

```bash
# Reset to clean state
ssh megacampus-prod "cd /opt/megacampus/repo && git fetch origin && git reset --hard origin/master"

# Verify remote
ssh megacampus-prod "cd /opt/megacampus/repo && git remote -v"
```

## Security Best Practices

1. **SSH Keys**: Use dedicated deploy keys, not personal keys
2. **Secrets**: Never commit secrets to git, use GitHub Secrets
3. **Container Registry**: Private registry with token authentication
4. **Network**: Services bound to localhost, only Nginx publicly exposed
5. **Updates**: Regular security updates for base images
6. **Backups**: Automated backups before each deployment

## Manual Operations

### Pull Latest Code Manually

```bash
ssh megacampus-prod
cd /opt/megacampus/repo
git fetch origin
git reset --hard origin/master
```

### Restart All Services

```bash
ssh megacampus-prod
cd /opt/megacampus
docker compose -f docker-compose.production.yml restart
```

### View Service Logs

```bash
# Follow logs
ssh megacampus-prod "docker compose -f /opt/megacampus/docker-compose.production.yml logs -f"

# View specific service
ssh megacampus-prod "docker logs -f megacampus-web"
```

### Clean Up Old Images

```bash
ssh megacampus-prod "docker system prune -a -f"
```

## CI/CD Pipeline Details

### CI Pipeline (Triggered on Push/PR)

1. **Setup**: Install dependencies, cache node_modules
2. **Lint**: ESLint checks
3. **Type Check**: TypeScript compilation
4. **Build**: Build all packages
5. **Test**: Run test suites
6. **Security**: pnpm audit
7. **Docker Smoke Test**: Verify Docker images build and start

### CD Pipeline (Triggered on Push to Master)

1. **CI Check**: Wait for CI Success job
2. **Build Images**: Build and push Docker images to ghcr.io
3. **Deploy**:
   - Copy files to server
   - Generate .env.production from secrets
   - Execute deploy.sh script
   - Verify health checks
4. **Rollback**: Automatic rollback on failure
5. **Notify**: Deployment status notification

## Quick Reference

```bash
# Check deployment status
gh run list --workflow=deploy.yml --limit 5

# View workflow logs
gh run view <run-id> --log

# Trigger manual deployment
gh workflow run deploy.yml

# Check server status
ssh megacampus-prod "docker ps && docker compose -f /opt/megacampus/docker-compose.production.yml ps"

# View deployment logs
ssh megacampus-prod "ls -lth /opt/megacampus/backups/"
```

## Migration from Old Repository

The server has been migrated from `MegaCampusAI` to `MC-2` repository:

```bash
# Old remote (deprecated)
https://github.com/maslennikov-ig/MegaCampusAI.git

# New remote (current)
https://github.com/maslennikov-ig/MC-2.git
```

Migration steps completed:
1. Changed git remote on server
2. Updated GitHub Actions workflows (main â†’ master)
3. Updated deploy scripts for branch detection
4. Updated docker-compose.production.yml image paths
5. Verified all secrets and configurations

## Next Steps

1. Set up proper monitoring (Prometheus/Grafana)
2. Configure automated backups for data volumes
3. Set up log aggregation (ELK/Loki)
4. Implement blue-green deployment for zero-downtime migrations
5. Add smoke tests to deployment pipeline
6. Configure alerting for deployment failures
