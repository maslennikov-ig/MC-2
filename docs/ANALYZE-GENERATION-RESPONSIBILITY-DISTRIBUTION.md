# –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É Stage 4 (Analyze) –∏ Stage 5 (Generation)

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-11-20
**–°—Ç–∞—Ç—É—Å**: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
**–¶–µ–ª—å**: –ü–æ–Ω—è—Ç—å —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

---

## Executive Summary

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤—É—Ö—Å—Ç–∞–¥–∏–π–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫—É—Ä—Å–æ–≤:

- **Stage 4 (Analyze)**: –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö ‚Üí –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞
- **Stage 5 (Generation)**: –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —É—Ä–æ–∫–æ–≤ ‚Üí –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞

### –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ**:
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∞–Ω–∞–ª–∏–∑–æ–º –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –Ω–∞—É—á–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö (Perplexity Research: RT-001, RT-002)
- Hybrid Specialization Model (78.5% success rate vs 66.2% –¥–ª—è LLM-only)
- –ü—Ä–æ–¥—É–º–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (qwen3-max –¥–ª—è —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π, Gemini –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤)

‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**:
- –í–æ–∑–º–æ–∂–Ω—ã–π –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥ –≤ —Å–ª–æ–µ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (5 —Å–ª–æ–µ–≤ + 3 —É—Ä–æ–≤–Ω—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –º–µ–∂–¥—É —Å—Ç–∞–¥–∏—è–º–∏
- –ù–µ–ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (deprecated scope_instructions –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- RAG Planning –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω (–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –≤ ANALYZE-ENHANCEMENT-UNIFIED)

---

## 1. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Stage 4 (Analyze)

### 1.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ä–æ–ª—å

**–§–∏–ª–æ—Å–æ—Ñ–∏—è**: "Extract and Structure" - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π —Å –±–æ–ª—å—à–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –æ–∫–Ω–æ–º (Gemini 2.5 Flash - 1M tokens)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∑–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ (no chunking)
- –§–æ–∫—É—Å –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –º–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –í—ã–≤–æ–¥: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

### 1.2 –†–µ–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (7 —Ñ–∞–∑)

–°–æ–≥–ª–∞—Å–Ω–æ –∫–æ–¥—É `analysis-orchestrator.ts`:

```
Phase 0 (Pre-Flight): Stage 3 barrier validation (0-10%)
Phase 1: Basic Classification (10-20%) - –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∫—É—Ä—Å–∞, —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è
Phase 2: Scope Analysis (20-35%) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–∫–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º—É–º–∞ 10 lessons
Phase 3: Deep Expert Analysis (35-60%) - –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑
Phase 4: Document Synthesis (60-75%) - —Å–∏–Ω—Ç–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
Phase 6: RAG Planning (75-85%) - mapping –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∫ —Å–µ–∫—Ü–∏—è–º (PLANNED, –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
Phase 5: Final Assembly (85-100%) - —Å–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ AnalysisResult
```

### 1.3 –ß—Ç–æ –≤—ã–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–µ

**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** (`AnalysisResult`):

```typescript
{
  course_category: { primary, secondary, rationale },
  contextual_language: { ... },
  pedagogical_strategy: {
    teaching_style, interaction_type, content_delivery, assessment_approach
  },
  recommended_structure: {
    total_lessons, total_sections, estimated_content_hours, difficulty_level
  },
  sections_breakdown: [
    {
      area, estimated_lessons, importance, learning_objectives,
      key_topics, pedagogical_approach, difficulty_progression,
      section_id, estimated_duration_hours, difficulty, prerequisites // –ù–û–í–´–ï –ü–û–õ–Ø
    }
  ],
  expansion_areas: [...], // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã
  research_flags: [...],  // –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
  scope_instructions: string, // DEPRECATED - –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ generation_guidance
  metadata: { total_tokens, total_cost_usd, model_usage, ... }
}
```

**–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è** (–∏–∑ ANALYZE-ENHANCEMENT-UNIFIED.md):

1. **pedagogical_patterns** - –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è (theory/practice ratio, assessment types)
2. **generation_guidance** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è Generation (tone, analogies, visuals, exercises)
3. **document_relevance_mapping** - RAG plan –¥–ª—è Generation (–∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –∫–∞–∫–∏–º —Å–µ–∫—Ü–∏—è–º)
4. **document_analysis** - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (themes, complexity, coverage)

### 1.4 –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç Analyze

‚ùå **–ù–µ —Å–æ–∑–¥–∞–µ—Ç**:
- –î–µ—Ç–∞–ª—å–Ω—ã–µ lesson-level —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ section-level)
- Specific prompts –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Ä–æ–∫–æ–≤
- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏ –∑–∞–¥–∞–Ω–∏—è
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ö–µ–º—ã –¥–ª—è Stage 6 (content generation)
- JSON repair –Ω–∞ —É—Ä–æ–≤–Ω–µ Generation (—ç—Ç–æ —É–∂–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å UnifiedRegenerator –≤ Generation)

---

## 2. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Stage 5 (Generation)

### 2.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ä–æ–ª—å

**–§–∏–ª–æ—Å–æ—Ñ–∏—è**: "Reason and Create" - —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –∏ –¥–µ—Ç–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º–∏ reasoning —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏ (qwen3-max, OSS 120B)
- –†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤—Ö–æ–¥–æ–º –æ—Ç Analyze (–Ω–µ —Å raw documents)
- –§–æ–∫—É—Å –Ω–∞ pedagogical reasoning –∏ creative synthesis
- –í—ã–≤–æ–¥: –≥–æ—Ç–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—É—Ä—Å–∞ —Å lessons

### 2.2 –†–µ–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (5 —Ñ–∞–∑ LangGraph)

–°–æ–≥–ª–∞—Å–Ω–æ –∫–æ–¥—É `generation-orchestrator.ts`:

```
Phase 1: validate_input - –ø—Ä–æ–≤–µ—Ä–∫–∞ schema analysis_result
Phase 2: generate_metadata - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–∞ (MetadataGenerator)
Phase 3: generate_sections - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ü–∏–π –∏ —É—Ä–æ–∫–æ–≤ (SectionBatchGenerator)
Phase 4: validate_quality - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ (QualityValidator, threshold 0.75)
Phase 5: validate_lessons - –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º—É–º–∞ 10 —É—Ä–æ–∫–æ–≤
```

**LangGraph StateGraph**:
- –õ–∏–Ω–µ–π–Ω—ã–π workflow (no conditional branching)
- Immutable state updates
- Retry tracking per phase
- Token usage tracking
- Model selection tracking

### 2.3 –ß—Ç–æ –≤—ã–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–µ

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞** (`GenerationResult`):

```typescript
{
  course_structure: {
    title, description,
    learning_outcomes: [...],
    difficulty_level, estimated_duration_hours,
    prerequisites: [...],
    target_audience,
    sections: [
      {
        section_id, title, description,
        lessons: [
          {
            lesson_id, title, description,
            learning_objectives: [...],
            topics: [...],
            estimated_duration_minutes,
            difficulty_level,
            exercises: [...],
            interactive_elements: [...]
          }
        ],
        section_metadata: { ... }
      }
    ]
  },
  generation_metadata: {
    total_tokens: { metadata, sections, validation, total },
    cost_usd,
    quality_scores: { metadata_similarity, sections_similarity, overall },
    model_used: { metadata, sections, validation },
    batch_count,
    retry_count: { metadata, sections }
  }
}
```

### 2.4 –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç Generation

‚ùå **–ù–µ —Å–æ–∑–¥–∞–µ—Ç**:
- –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—É–∂–µ —Å–¥–µ–ª–∞–Ω –≤ Analyze)
- Holistic pattern detection (Analyze —É–∂–µ –∏–∑–≤–ª–µ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)
- Document-level understanding (Analyze –∏–º–µ–µ—Ç full context)
- RAG –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (—ç—Ç–æ Stage 3 - Document Processing)

---

## 3. –ö–ª—é—á–µ–≤—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ —Ä–µ—à–µ–Ω–∏—è

### 3.1 Perplexity Research: Multi-Stage Architecture

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `docs/research/008-generation/Optimal Multi-Stage Architecture for AI Course Generation.md`

**–ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏**:

1. **Hybrid Specialization Model**: 78.5% success rate
   - Single-stage: 29.2%
   - LLM-only multi-stage: 66.2%
   - **Hybrid (–Ω–∞—à –ø–æ–¥—Ö–æ–¥): 78.5%** ‚úÖ

2. **Division of Labor –ø—Ä–∏–Ω—Ü–∏–ø**:
   - Analyze: "comprehensive extraction and high-level structuring"
   - Generation: "intelligent reasoning and detailed content creation"

3. **–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è granularity**:
   - Analyze: Section-level (3-7 sections)
   - Generation: Lesson-level (3-5 lessons per section)

4. **Full-context vs RAG**:
   - Full-context (Analyze): 47.25 F1 score
   - RAG: 34.26 F1 score
   - **–í—ã–≤–æ–¥**: Full-context –ø–µ—Ä–≤–∏—á–Ω–æ, RAG - optional enhancement

5. **Scope instructions guidance**:
   - ‚ùå Too detailed: —Å–Ω–∏–∂–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞ 15-30% (over-constrains reasoning)
   - ‚úÖ Architectural blueprints: objectives, constraints, success criteria
   - ‚ùå Too vague: "generate good content"

**–¶–∏—Ç–∞—Ç–∞ –∏–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è**:
> "Critical: Analyze should NOT generate specific lesson prompts or paragraph-level content instructions. Research shows this over-constrains downstream reasoning models, reducing quality by 15-30%. Instead, provide objectives, constraints, and success criteria - the 'what' not the 'how.'"

### 3.2 Production Evidence: RudderStack Case Study

**–ò—Å—Ç–æ—á–Ω–∏–∫**: –¢–æ—Ç –∂–µ research document

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:
- Batch preprocessing layer (parallel: Analyze)
- Smart reasoning layer (parallel: Generation)

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
- 95% triage time reduction
- 90%+ first-pass accuracy
- Clear debugging paths

**–í—ã–≤–æ–¥**: Separation of concerns —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production

---

## 4. –¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

### 4.1 –ú–∞—Ç—Ä–∏—Ü–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

| –ó–∞–¥–∞—á–∞ | Analyze (Stage 4) | Generation (Stage 5) | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|--------|-------------------|----------------------|-------------|
| **–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** | ‚úÖ –í–õ–ê–î–ï–õ–ï–¶ | ‚ùå –ù–ï–¢ | Large-context window (1M tokens) |
| **Pattern detection** | ‚úÖ –í–õ–ê–î–ï–õ–ï–¶ | ‚ùå –ù–ï–¢ | Holistic understanding |
| **Pedagogical strategy** | ‚úÖ –í–õ–ê–î–ï–õ–ï–¶ | ‚ùå –ù–ï–¢ | Based on document analysis |
| **Section structure** | ‚úÖ –í–õ–ê–î–ï–õ–ï–¶ | ‚úÖ REFINEMENT | Analyze: high-level, Generation: detailed |
| **Lesson breakdown** | ‚ùå –ù–ï–¢ | ‚úÖ –í–õ–ê–î–ï–õ–ï–¶ | Reasoning strength |
| **Learning objectives** | ‚úÖ Section-level | ‚úÖ Lesson-level | Division of granularity |
| **Exercise generation** | ‚ùå –ù–ï–¢ | ‚úÖ –í–õ–ê–î–ï–õ–ï–¶ | Creative synthesis |
| **Prompts for Stage 6** | ‚ùå –ù–ï–¢ | ‚úÖ –í–õ–ê–î–ï–õ–ï–¶ | Downstream requirements understanding |
| **JSON repair (auto)** | ‚úÖ Layer 1-2 | ‚úÖ Layer 1-5 | UnifiedRegenerator –≤ –æ–±–µ–∏—Ö —Å—Ç–∞–¥–∏—è—Ö |
| **Quality validation** | ‚ùå –ù–ï–¢ | ‚úÖ –í–õ–ê–î–ï–õ–ï–¶ | Phase 4 in Generation |
| **RAG planning** | ‚úÖ –ü–õ–ê–ù–ò–†–£–ï–¢–°–Ø | ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–¢ | Analyze —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞–Ω, Generation –∏—Å–ø–æ–ª—å–∑—É–µ—Ç |
| **Token tracking** | ‚úÖ –î–ê | ‚úÖ –î–ê | –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ |
| **Cost tracking** | ‚úÖ –î–ê | ‚úÖ –î–ê | –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ |

### 4.2 Data Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Stage 3: Document Processing                               ‚îÇ
‚îÇ - Docling PDF extraction                                   ‚îÇ
‚îÇ - Hierarchical chunking (400 tokens child, 1500 parent)    ‚îÇ
‚îÇ - Vectorization (Qdrant) FROM ORIGINAL DOCUMENTS           ‚îÇ
‚îÇ - Summary generation (if needed for Analyze budget)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ document_summaries (or full text)
                      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Stage 4: ANALYZE (Gemini 2.5 Flash 1M context)             ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ Phase 0: Barrier validation (Stage 3 complete?)            ‚îÇ
‚îÇ Phase 1: Classification (course_category, target_audience) ‚îÇ
‚îÇ Phase 2: Scope Analysis (min 10 lessons check)             ‚îÇ
‚îÇ Phase 3: Expert Analysis (pedagogical_strategy)            ‚îÇ
‚îÇ Phase 4: Document Synthesis                                ‚îÇ
‚îÇ Phase 6: RAG Planning (document-to-section mapping) üîÑ WIP ‚îÇ
‚îÇ Phase 5: Assembly (AnalysisResult)                         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ Output: analysis_result (JSONB, 3-5K tokens)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ AnalysisResult
                      ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Stage 5: GENERATION (qwen3-max 128K context)               ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ Phase 1: Validate Input (schema check)                     ‚îÇ
‚îÇ Phase 2: Generate Metadata (MetadataGenerator)             ‚îÇ
‚îÇ Phase 3: Generate Sections (SectionBatchGenerator)         ‚îÇ
‚îÇ         - Optional: RAG context retrieval üîÑ WIP           ‚îÇ
‚îÇ         - Batch processing (parallel sections)             ‚îÇ
‚îÇ Phase 4: Validate Quality (0.75 threshold)                 ‚îÇ
‚îÇ Phase 5: Validate Lessons (min 10 lessons)                 ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ Output: course_structure (JSONB, 100-200K tokens)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:

1. **Analyze** –ø–æ–ª—É—á–∞–µ—Ç summaries –ò–õ–ò full text (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç token budget)
2. **–í–µ–∫—Ç–æ—Ä—ã** –í–°–ï–ì–î–ê –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–≤ (–Ω–µ –∏–∑ summaries) - –¥–ª—è RAG quality
3. **RAG Planning** (Phase 6) –ø–æ–∫–∞ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
4. **Generation** –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAG (–Ω–æ —ç—Ç–æ optional, –ø–æ–∫–∞ WIP)

---

## 5. –°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (UnifiedRegenerator)

### 5.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `docs/REGENERATION-STRATEGY.md`

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–∞ —Ç–∏–ø–∞ –æ—à–∏–±–æ–∫
1. Context Overflow (input too large) ‚Üí Emergency Phase (Grok/Gemini)
2. Quality/Validation Failure ‚Üí UnifiedRegenerator (5 layers)

### 5.2 –ü—è—Ç—å —Å–ª–æ–µ–≤ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

| Layer | Strategy | Cost | Success Rate | Use Case |
|-------|----------|------|--------------|----------|
| **Layer 1** | Auto-repair (jsonrepair + field-name-fix) | **FREE** | **95-98%** | Malformed JSON, camelCase‚Üísnake_case |
| **Layer 2** | Critique-revise (LLM feedback loop) | 1x cost | +2-3% | Logical errors, missing fields |
| **Layer 3** | Partial regeneration (field-level atomic repair) | 0.5x cost | +5-10% | Specific field validation failures |
| **Layer 4** | Model escalation (20B ‚Üí 120B) | 6x cost | +10-15% | Complex reasoning failures |
| **Layer 5** | Quality fallback (Kimi K2) | 2x cost | +5-8% | Last resort, high quality needed |

### 5.3 –¢—Ä–∏ —É—Ä–æ–≤–Ω—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**Tier 1: Preprocessing** (FREE, instant, 60-80% success)
- Lowercase + trim
- Fix typos (hyphen ‚Üí underscore)
- Map synonyms ('analysis' ‚Üí 'case_study')

**Tier 2: Semantic Matching** ($0.00002, 50ms, 12-15% success)
- Embeddings (OpenAI text-embedding-3-small)
- Cosine similarity > 0.85
- **Status**: Implemented but NOT integrated yet

**Tier 3: Warning Fallback** (Stage 4 only)
- Accept invalid value with warning
- Mark: `validated: false`
- **ONLY for Stage 4 advisory fields** (Stage 5 must be strict for database integrity)

### 5.4 –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**Analyze (Stage 4)**:
- All phases (1-4) use UnifiedRegenerator
- Configuration: `allowWarningFallback: true` (advisory fields OK)
- Layers 1-5 enabled

**Generation (Stage 5)**:
- Metadata generation uses UnifiedRegenerator
- Section generation uses UnifiedRegenerator
- Configuration: `allowWarningFallback: false` (strict database validation)
- Layers 1-5 enabled

---

## 6. –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–∏—Å–∫–∏

### 6.1 –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥

#### 6.1.1 –ü—è—Ç—å —Å–ª–æ–µ–≤ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ - —ç—Ç–æ –º–Ω–æ–≥–æ?

**–ê—Ä–≥—É–º–µ–Ω—Ç—ã "–ó–ê" —Å–ª–æ–∂–Ω–æ—Å—Ç—å**:
- ‚úÖ Layer 1 (free) –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 95-98% —Å–ª—É—á–∞–µ–≤ - —ç—Ç–æ —Ö–æ—Ä–æ—à–æ
- ‚úÖ Layers 2-5 —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ä–µ–¥–∫–æ (<5%) - –¥–æ–±–∞–≤–ª—è—é—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ Production evidence: 95%+ success rate
- ‚úÖ Cost analysis: $2,700 annual savings (96% cost reduction)

**–ê—Ä–≥—É–º–µ–Ω—Ç—ã "–ü–†–û–¢–ò–í" —Å–ª–æ–∂–Ω–æ—Å—Ç—å**:
- ‚ö†Ô∏è 5 —Å–ª–æ–µ–≤ + 3 tier validation = 8 —É—Ä–æ–≤–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- ‚ö†Ô∏è Debugging complexity: –∫–∞–∫–æ–π —Å–ª–æ–π —Å—Ä–∞–±–æ—Ç–∞–ª? –ü–æ—á–µ–º—É?
- ‚ö†Ô∏è Maintenance overhead: 8 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- ‚ö†Ô∏è Over-abstraction: –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º —Ä–µ—à–∞–µ—Ç Layer 1

**–ú–æ—ë –º–Ω–µ–Ω–∏–µ**:
- Layers 1-2: –∞–±—Å–æ–ª—é—Ç–Ω–æ –æ–ø—Ä–∞–≤–¥–∞–Ω—ã
- Layers 3-4: –æ–ø—Ä–∞–≤–¥–∞–Ω—ã –¥–ª—è production
- Layer 5: questionable (Kimi K2 - –¥–æ—Ä–æ–≥–æ, +5-8% marginal improvement)
- Tier 2 (Semantic Matching): –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω ‚Üí –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –Ω—É–∂–µ–Ω?

#### 6.1.2 RAG Planning - –¥–æ–±–∞–≤–ª—è–µ—Ç –ª–∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å?

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å**: Planned (ANALYZE-ENHANCEMENT-UNIFIED), –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

**–û–±–µ—â–∞–Ω–∏—è**:
- +$0.068/course savings (no extra Planning LLM call)
- +20% RAG quality (targeted retrieval)
- Solves full-text document token budget problem

**–†–∏—Å–∫–∏**:
- ‚ö†Ô∏è Analyze —É–∂–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω (7 phases)
- ‚ö†Ô∏è Phase 6 (RAG Planning) - —ç—Ç–æ 8-—è —Ñ–∞–∑–∞ –ø–æ —Ñ–∞–∫—Ç—É
- ‚ö†Ô∏è Generation –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ RAG (MVP functional)
- ‚ö†Ô∏è –°–ª–æ–∂–Ω–æ—Å—Ç—å: document-to-section mapping —Ç—Ä–µ–±—É–µ—Ç reasoning

**–ú–æ—ë –º–Ω–µ–Ω–∏–µ**:
- –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ optional enhancement (Phase 2)
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç production launch
- A/B —Ç–µ—Å—Ç –ø–æ–∫–∞–∂–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å

### 6.2 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: UnifiedRegenerator –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –û–ë–ï–ò–• —Å—Ç–∞–¥–∏—è—Ö

**–ü–ª—é—Å—ã**:
- ‚úÖ Consistent error handling
- ‚úÖ Shared infrastructure

**–ú–∏–Ω—É—Å—ã**:
- ‚ö†Ô∏è Duplication: –∫–∞–∂–¥–∞—è —Å—Ç–∞–¥–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç regenerator –æ—Ç–¥–µ–ª—å–Ω–æ
- ‚ö†Ô∏è Configuration drift: allowWarningFallback —Ä–∞–∑–Ω—ã–π
- ‚ö†Ô∏è Maintenance: –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 6.3 Deprecated fields

**–ü—Ä–æ–±–ª–µ–º–∞**: `scope_instructions` (string) –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ü–ª–∞–Ω**: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `generation_guidance` (structured)

**–°—Ç–∞—Ç—É—Å**: ANALYZE-ENHANCEMENT-UNIFIED (approved, not implemented)

**–†–∏—Å–∫**: Technical debt, backward compatibility burden

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (Phase 1 implementation)

### 6.4 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ**: INV-2025-11-19-002-stage5-architecture-cleanup.md

**–ü—Ä–æ–±–ª–µ–º–∞**: Duplicate folders
- Active: `/services/stage5/` (15 files)
- Unused: `/orchestrator/services/generation/` (3 files, abandoned refactoring)

**–°—Ç–∞—Ç—É—Å**: READY FOR EXECUTION (cleanup pending)

**–†–∏—Å–∫**: Developer confusion, wasted effort

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –£–¥–∞–ª–∏—Ç—å duplicate ASAP + —Å–æ–∑–¥–∞—Ç—å STAGE5-ARCHITECTURE.md

---

## 7. –ú–æ–µ –º–Ω–µ–Ω–∏–µ: –µ—Å—Ç—å –ª–∏ –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥?

### 7.1 –ß—Ç–æ –•–û–†–û–®–û —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ

1. **Hybrid Specialization Model** - –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω (78.5% vs 66.2%)
2. **Division of Labor** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: Analyze = structure, Generation = details
3. **Section vs Lesson granularity** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏
4. **Model routing** - –∏—Å–ø–æ–ª—å–∑—É–µ–º strengths –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
5. **Layer 1-2 regeneration** - free + effective, –æ–ø—Ä–∞–≤–¥–∞–Ω

### 7.2 –ß—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã ‚ö†Ô∏è

#### 7.2.1 –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–ª–æ–µ–≤

**–¢–µ–∫—É—â–µ–µ**: 5 layers + 3 tiers = 8 —É—Ä–æ–≤–Ω–µ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–æ 4 —É—Ä–æ–≤–Ω–µ–π
```
Layer 1: Auto-repair (jsonrepair + field-name-fix) - FREE, 95-98%
Layer 2: Critique-revise - 1x cost, +2-3%
Layer 3: Partial regeneration - 0.5x cost, +5-10%
Layer 4: Model escalation (20B ‚Üí 120B) - 6x cost, +10-15%
[REMOVE] Layer 5: Kimi K2 - marginal value, high cost
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:
- Layer 4 (120B) —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ—â–Ω—ã–π
- Layer 5 –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ +5-8% –ø—Ä–∏ 2x cost
- Production 99.5% success rate –¥–æ—Å—Ç–∏–∂–∏–º —Å 4 —Å–ª–æ—è–º–∏

**Tier 2 (Semantic Matching)**:
- ‚ùå –ù–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤
- ‚ùå –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –Ω—É–∂–µ–Ω (Layer 1 –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 95-98%)
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –£–¥–∞–ª–∏—Ç—å –ò–õ–ò –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏

#### 7.2.2 Analyze: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ñ–∞–∑?

**–¢–µ–∫—É—â–µ–µ**: 7 phases (0, 1, 2, 3, 4, 6, 5)

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –§–∞–∑—ã 0, 6, 5 - —ç—Ç–æ auxiliary logic, –Ω–µ core analysis
- Phase numbering: –ø–æ—á–µ–º—É Phase 6 –º–µ–∂–¥—É 4 –∏ 5?
- Phase 0 (barrier check) - —ç—Ç–æ validation, –Ω–µ analysis

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
```
Pre-Flight Validation (barrier check)
Phase 1: Classification
Phase 2: Scope Analysis
Phase 3: Expert Analysis
Phase 4: Document Synthesis
Phase 5: Final Assembly
[OPTIONAL] RAG Planning (future enhancement)
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**: –£–±–∏—Ä–∞–µ—Ç confusion, –¥–µ–ª–∞–µ—Ç workflow –ø–æ–Ω—è—Ç–Ω–µ–µ

#### 7.2.3 RAG Planning - –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è?

**–°—Ç–∞—Ç—É—Å**: Planned, –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

**–û–±–µ—â–∞–Ω–∏—è**: +20% RAG quality, $0.068 savings

**–†–µ–∞–ª—å–Ω–æ—Å—Ç—å**:
- Generation —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ RAG (MVP functional)
- RAG - optional enhancement, –Ω–µ core requirement
- –î–æ–±–∞–≤–ª—è–µ—Ç complexity –≤ Analyze (—É–∂–µ 7 —Ñ–∞–∑)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: DEFER to Phase 2
- –ó–∞–ø—É—Å—Ç–∏—Ç—å production –ë–ï–ó RAG Planning
- A/B —Ç–µ—Å—Ç: –Ω—É–∂–µ–Ω –ª–∏ RAG –≤–æ–æ–±—â–µ?
- –ï—Å–ª–∏ –Ω—É–∂–µ–Ω: –¥–æ–±–∞–≤–∏—Ç—å RAG Planning –ø–æ–∑–∂–µ

### 7.3 –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**–û–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥?**

**–î–∞, –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã:**
- ‚úÇÔ∏è Layer 5 regeneration - –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å
- ‚úÇÔ∏è Tier 2 (Semantic Matching) - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —É–¥–∞–ª–∏—Ç—å
- ‚úÇÔ∏è RAG Planning - –æ—Ç–ª–æ–∂–∏—Ç—å –¥–æ Phase 2

**–ù–µ—Ç, core –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è:**
- ‚úÖ Hybrid Specialization Model - –æ–±–æ—Å–Ω–æ–≤–∞–Ω
- ‚úÖ Division of Labor - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
- ‚úÖ Layers 1-4 regeneration - –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è production
- ‚úÖ Multi-phase orchestration - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ø—Ä–æ—â–µ–Ω–∏—é**:

1. **–ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ (1-2 –Ω–µ–¥–µ–ª–∏)**:
   - –£–¥–∞–ª–∏—Ç—å duplicate folder (`/orchestrator/services/generation/`)
   - –°–æ–∑–¥–∞—Ç—å STAGE5-ARCHITECTURE.md
   - –£–¥–∞–ª–∏—Ç—å Tier 2 (Semantic Matching) –µ—Å–ª–∏ –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Layer 5 –∫–∞–∫ optional (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å)

2. **–°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ (1-2 –º–µ—Å—è—Ü–∞)**:
   - –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `scope_instructions` ‚Üí `generation_guidance`
   - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å Analyze phases –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
   - A/B —Ç–µ—Å—Ç: Layer 5 vs without Layer 5

3. **–î–æ–ª–≥–∏–π —Å—Ä–æ–∫ (3-6 –º–µ—Å—è—Ü–µ–≤)**:
   - A/B —Ç–µ—Å—Ç: RAG Planning –Ω—É–∂–µ–Ω –∏–ª–∏ –Ω–µ—Ç?
   - –ï—Å–ª–∏ –Ω—É–∂–µ–Ω: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
   - –ï—Å–ª–∏ –Ω–µ—Ç: —É–¥–∞–ª–∏—Ç—å –∏–∑ roadmap

---

## 8. –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### 8.1 –¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ ‚úÖ

**Analyze (Stage 4)**:
- ‚úÖ Extract comprehensive structure from full documents
- ‚úÖ Provide high-level pedagogical guidance
- ‚úÖ Section-level breakdown (not lesson-level)
- ‚úÖ Objectives, constraints, success criteria

**Generation (Stage 5)**:
- ‚úÖ Elaborate structure into detailed lessons
- ‚úÖ Reason about pedagogy and content
- ‚úÖ Generate exercises, prompts, assessments
- ‚úÖ Quality validation

**Separation of concerns**: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è, –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –Ω–∞—É—á–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö

### 8.2 –£–ø—Ä–æ—â–µ–Ω–∏—è –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è complexity

**High Priority** (—Å–¥–µ–ª–∞—Ç—å –≤ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏):

1. ‚úÇÔ∏è –£–¥–∞–ª–∏—Ç—å duplicate folder `/orchestrator/services/generation/`
2. ‚úÇÔ∏è –£–¥–∞–ª–∏—Ç—å Tier 2 (Semantic Matching) –ò–õ–ò –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å (decision point)
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å STAGE5-ARCHITECTURE.md

**Medium Priority** (1-2 –º–µ—Å—è—Ü–∞):

4. ‚úÇÔ∏è –°–¥–µ–ª–∞—Ç—å Layer 5 (Kimi K2) optional (config flag)
5. ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `scope_instructions` ‚Üí `generation_guidance`
6. ‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å Analyze phases –¥–ª—è clarity

**Low Priority** (3-6 –º–µ—Å—è—Ü–µ–≤):

7. üî¨ A/B —Ç–µ—Å—Ç: RAG Planning - –Ω—É–∂–µ–Ω –∏–ª–∏ –Ω–µ—Ç?
8. üî¨ A/B —Ç–µ—Å—Ç: Layer 5 regeneration - –¥–æ–±–∞–≤–ª—è–µ—Ç –ª–∏ value?
9. ‚úÖ Production metrics: track regeneration layer usage

### 8.3 –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (—Ö–æ—Ä–æ—à–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ)

‚úÖ **Hybrid Specialization Model** - —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å
‚úÖ **Division of Labor** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –Ω–µ –º–µ–Ω—è—Ç—å
‚úÖ **Layers 1-4 regeneration** - –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã, –æ—Å—Ç–∞–≤–∏—Ç—å
‚úÖ **Multi-phase orchestration** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç complexity, –æ—Å—Ç–∞–≤–∏—Ç—å
‚úÖ **LangGraph StateGraph** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è Generation, –æ—Å—Ç–∞–≤–∏—Ç—å

---

## 9. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥**: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö, –Ω–æ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –æ–≤–µ—Ä–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥–∞ –≤ –¥–µ—Ç–∞–ª—è—Ö (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–ª–æ–µ–≤ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ features).

**Action Items**:

1. ‚úÇÔ∏è –£–ø—Ä–æ—Å—Ç–∏—Ç—å: —É–¥–∞–ª–∏—Ç—å Layer 5, Tier 2, duplicate folders
2. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å: STAGE5-ARCHITECTURE.md, –º–∏–≥—Ä–∞—Ü–∏—è scope_instructions
3. üî¨ –ò–∑–º–µ—Ä–∏—Ç—å: A/B —Ç–µ—Å—Ç—ã –¥–ª—è RAG Planning –∏ Layer 5
4. ‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å core –∫–∞–∫ –µ—Å—Ç—å: Hybrid Specialization –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è

**–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞**: **7/10** (—Ö–æ—Ä–æ—à–æ, –Ω–æ –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å)

---

**–ê–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞**: Claude Code (Sonnet 4.5)
**–î–∞—Ç–∞**: 2025-11-20
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏**:
- Research documents: RT-001, RT-002, Perplexity Multi-Stage Architecture
- Code: analysis-orchestrator.ts, generation-orchestrator.ts
- Investigations: INV-2025-11-19-002, REGENERATION-STRATEGY.md
- Specs: ANALYZE-ENHANCEMENT-UNIFIED.md
