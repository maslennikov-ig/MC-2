# Migration Guide: T055 Unified Stage 4/Stage 5 Schemas

**Date**: 2025-11-12
**Status**: COMPLETE
**Related**: SPEC-2025-11-12-001-unify-stage4-stage5-schemas.md

---

## Overview

T055 unified the AnalysisResult schema between Stage 4 (Analyze) and Stage 5 (Generation), eliminating information loss and enabling rich pedagogical context in generation prompts.

**Before**: Stage 5 used simplified flat schema (category: string, difficulty: enum, etc.)
**After**: Stage 5 uses full nested schema from Stage 4 with 4 REQUIRED enhancement fields

---

## What Changed

### Schema Changes

#### 1. **Nested Objects (Already Existed, Now Enforced)**

| Old Field (Flat) | New Field (Nested) | Type |
|------------------|-------------------|------|
| `category: string` | `course_category: { primary, confidence, reasoning, secondary? }` | Object |
| `difficulty: enum` | `topic_analysis.target_audience: 'beginner' \| 'intermediate' \| 'advanced'` | Enum (nested) |
| `contextual_language: string` | `contextual_language: { 6 fields }` | Object |
| `pedagogical_strategy: string` | `pedagogical_strategy: { 5 fields }` | Object |

#### 2. **NEW: 4 REQUIRED Enhancement Fields**

All 4 fields are **REQUIRED** in schema (production Best Practice):

| Field | Type | Description | Generated By |
|-------|------|-------------|--------------|
| `pedagogical_patterns` | Object | Primary strategy, theory:practice ratio, assessment types, key patterns | Analyze (ALWAYS) |
| `generation_guidance` | Object | Tone, analogies, jargon to avoid, visuals, exercise types, real-world examples | Analyze (ALWAYS) |
| `document_relevance_mapping` | Record<string, object> | RAG planning per section (empty for title-only) | Analyze (ALWAYS) |
| `document_analysis` | Object | Source materials, main themes, complexity, estimated hours | Analyze (ALWAYS) |

**CRITICAL**: Analyze ALWAYS generates ALL 4 fields, even if input was title-only. Generation receives ALL fields and decides whether to use RAG.

---

## Breaking Changes

### 1. **AnalysisResultSchema in generation-job.ts**

**Before**:
```typescript
// Simplified flat schema
export const AnalysisResultSchema = z.object({
  category: z.string(),
  difficulty: z.enum(['beginner', 'intermediate', 'advanced']),
  contextual_language: z.string(),
  pedagogical_strategy: z.string(),
  // ...
});
```

**After**:
```typescript
// Imports full unified schema
import {
  AnalysisResultSchema as FullAnalysisResultSchema,
  type AnalysisResult as FullAnalysisResult
} from '../../course-gen-platform/src/types/analysis-result';

export const AnalysisResultSchema = FullAnalysisResultSchema;
export type AnalysisResult = FullAnalysisResult;
```

### 2. **Test Fixtures**

**Before** (per-file custom fixtures):
```typescript
// ❌ OLD: Simplified flat schema
const mockAnalysisResult = {
  category: 'technical',
  difficulty: 'intermediate',
  contextual_language: 'en',
  pedagogical_strategy: 'Hands-on learning',
  // ... missing 4 REQUIRED fields
};
```

**After** (centralized fixture):
```typescript
// ✅ NEW: Import from centralized fixture
import { createFullAnalysisResult } from '../fixtures/analysis-result-fixture';

const mockAnalysisResult = createFullAnalysisResult('Course Title');
```

---

## Migration Steps

### For Test Code

**Step 1**: Import centralized fixture
```typescript
import { createFullAnalysisResult } from '../fixtures/analysis-result-fixture';
// Or for backward compatibility:
import { createMinimalAnalysisResult } from '../fixtures/analysis-result-fixture';
```

**Step 2**: Replace custom fixtures
```typescript
// ❌ OLD
const analysis_result = {
  category: 'professional',
  difficulty: 'intermediate',
  contextual_language: 'English',
  pedagogical_strategy: 'Mixed approach',
  // ...
};

// ✅ NEW
const analysis_result = createFullAnalysisResult('Machine Learning Basics');
```

**Files Updated**:
- `tests/contract/generation.test.ts`
- `tests/unit/stage5/metadata-generator.test.ts`
- `tests/unit/stage5/section-batch-generator.test.ts`
- `tests/integration/stage5-generation-worker.test.ts`

---

### For Service Code

**Step 1**: Import helper functions
```typescript
import {
  getDifficultyFromAnalysis,
  getCategoryFromAnalysis,
  formatCourseCategoryForPrompt,
  formatContextualLanguageForPrompt,
  formatPedagogicalStrategyForPrompt,
  formatPedagogicalPatternsForPrompt,
  formatGenerationGuidanceForPrompt,
} from './analysis-formatters';
```

**Step 2**: Replace flat field access with helpers

**Example 1: Accessing difficulty**
```typescript
// ❌ OLD (flat field doesn't exist)
const difficulty = input.analysis_result.difficulty;

// ✅ NEW (maps from topic_analysis.target_audience)
const difficulty = getDifficultyFromAnalysis(input.analysis_result);
```

**Example 2: Accessing category**
```typescript
// ❌ OLD (flat field doesn't exist)
const category = input.analysis_result.category;

// ✅ NEW (extracts course_category.primary)
const category = getCategoryFromAnalysis(input.analysis_result);
```

**Example 3: Formatting for prompts**
```typescript
// ❌ OLD (tries to stringify object)
prompt += `Category: ${input.analysis_result.category}`;

// ✅ NEW (formatted with confidence and reasoning)
const category = formatCourseCategoryForPrompt(input.analysis_result.course_category);
prompt += `Category: ${category}`;
// Result: "Professional (95% confidence)\nReasoning: This course teaches..."
```

**Files Updated**:
- `src/services/stage5/section-batch-generator.ts`
- `src/services/stage5/metadata-generator.ts`
- `src/services/stage5/generation-phases.ts`
- `src/services/stage5/quality-validator.ts`
- `src/services/stage5/validators/validation-orchestrator.ts`

---

## Helper Functions Reference

Location: `packages/course-gen-platform/src/services/stage5/analysis-formatters.ts`

### 1. `getDifficultyFromAnalysis(analysis)`

Maps `topic_analysis.target_audience` to difficulty level.

**Input**: `AnalysisResult`
**Output**: `'beginner' | 'intermediate' | 'advanced'`

**Example**:
```typescript
const difficulty = getDifficultyFromAnalysis(analysis);
// Returns: 'intermediate' (from topic_analysis.target_audience)
```

---

### 2. `getCategoryFromAnalysis(analysis)`

Extracts primary category and capitalizes it.

**Input**: `AnalysisResult`
**Output**: `string` (capitalized category)

**Example**:
```typescript
const category = getCategoryFromAnalysis(analysis);
// Returns: 'Professional' (from course_category.primary)
```

---

### 3. `formatCourseCategoryForPrompt(category)`

Formats category with confidence and reasoning for LLM prompts.

**Input**: `AnalysisResult['course_category']`
**Output**: `string` (multi-line formatted)

**Example**:
```typescript
const formatted = formatCourseCategoryForPrompt(analysis.course_category);
// Returns:
// "Professional (95% confidence)
//  Reasoning: This course teaches essential skills for software developers
//  Secondary Category: Academic"
```

---

### 4. `formatContextualLanguageForPrompt(contextual, strategy?, specificFields?)`

Formats contextual_language object with 3 strategies.

**Input**:
- `contextual`: `AnalysisResult['contextual_language']`
- `strategy`: `'full' | 'summary' | 'specific'` (default: 'full')
- `specificFields`: Array of field names (for 'specific' strategy)

**Output**: `string`

**Example 1** (full strategy - all 6 fields):
```typescript
const formatted = formatContextualLanguageForPrompt(analysis.contextual_language);
// Returns multi-line formatted text with all 6 fields
```

**Example 2** (summary strategy - concatenated):
```typescript
const formatted = formatContextualLanguageForPrompt(analysis.contextual_language, 'summary');
// Returns single paragraph with all fields concatenated
```

**Example 3** (specific fields):
```typescript
const formatted = formatContextualLanguageForPrompt(
  analysis.contextual_language,
  'specific',
  ['why_matters_context', 'motivators']
);
// Returns only selected fields
```

---

### 5. `formatPedagogicalStrategyForPrompt(strategy)`

Formats pedagogical_strategy object with all 5 fields.

**Input**: `AnalysisResult['pedagogical_strategy']`
**Output**: `string` (5-line formatted)

**Example**:
```typescript
const formatted = formatPedagogicalStrategyForPrompt(analysis.pedagogical_strategy);
// Returns:
// "Teaching Style: mixed
//  Assessment Approach: Combination of quizzes and projects
//  Practical Focus: medium
//  Progression Logic: Build from fundamentals to advanced topics
//  Interactivity Level: medium"
```

---

### 6. `formatPedagogicalPatternsForPrompt(patterns)`

Formats NEW pedagogical_patterns enhancement field (T055).

**Input**: `AnalysisResult['pedagogical_patterns']`
**Output**: `string`

**Example**:
```typescript
const formatted = formatPedagogicalPatternsForPrompt(analysis.pedagogical_patterns);
// Returns:
// "Primary Strategy: mixed
//  Theory:Practice Ratio: 40:60
//  Assessment Types: coding, quizzes, projects
//  Key Patterns: learn by doing, incremental complexity, real-world examples"
```

---

### 7. `formatGenerationGuidanceForPrompt(guidance)`

Formats NEW generation_guidance enhancement field (T055).

**Input**: `AnalysisResult['generation_guidance']`
**Output**: `string`

**Example**:
```typescript
const formatted = formatGenerationGuidanceForPrompt(analysis.generation_guidance);
// Returns multi-line formatted text with:
// - Tone, Use Analogies
// - Specific Analogies (array)
// - Avoid Jargon (array)
// - Include Visuals (array)
// - Exercise Types (array)
// - Contextual Language Hints
// - Real-World Examples (array)
```

---

## Architecture Principles (Validated)

✅ **Analyze (Stage 4) ALWAYS generates ALL 4 fields** - Even if input was title-only
✅ **Generation (Stage 5) ALWAYS receives full data** - 100% of cases, ALL fields REQUIRED
✅ **ALL 4 enhancement fields REQUIRED** - No .optional() (production Best Practice)
✅ **RAG usage is logic-level decision** - Generation decides, not schema

---

## Rollback Procedure

If issues arise, revert commits in reverse order:

```bash
git revert a82e6d4  # Phase 3: Test fixtures
git revert 9539b2a  # Phase 2: Stage 5 services
git revert a1e7a17  # Phase 1: Schema unification
```

**Warning**: Reverting will restore flat schema - Stage 4 → Stage 5 will fail validation.

---

## Support

**Issues**: Report in GitHub issue tracker
**Questions**: Reference SPEC-2025-11-12-001-unify-stage4-stage5-schemas.md
**Architecture**: See `specs/008-generation-generation-json/dependencies/schema-unification/ARCHITECTURE-SUMMARY.md`

---

**Created**: 2025-11-12
**Author**: T055 Schema Unification Team
**Status**: Production Ready
