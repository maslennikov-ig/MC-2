# Investigation: Duration Fields Architecture Fix

**Created**: 2025-11-19
**Status**: COMPLETED
**Priority**: HIGH (blocking test t053)

---

## Executive Summary

**Problem**: LLM is generating `estimated_duration_minutes` field, causing validation errors when it exceeds 45 minutes. This violates the architectural principle that duration should be controlled by frontend, not generated by models.

**Root Cause**: Same pattern as previous `id` and `language` field issues - models generating architectural constraints that should come from external sources.

**Solution**: Apply the same pattern used for UUID/language fix - exclude duration from LLM schema, inject from `frontend_parameters` after generation.

---

## Key Findings

### 1. Duration Source: `frontend_parameters.lesson_duration_minutes`

**Location**: User inputs this value on the frontend, passed through the entire pipeline:

1. **Frontend Input** →
2. **`StructureAnalysisJob.input.lesson_duration_minutes`** (`packages/course-gen-platform/src/types/analysis-job.ts:95`)
3. **`AnalysisResult.frontend_parameters.lesson_duration_minutes`** (`packages/course-gen-platform/src/types/analysis-result.ts:76`)
4. **`GenerationJobInput.frontend_parameters.lesson_duration_minutes`** (passed to Stage 5)

**Value Range**: 3-45 minutes (validated at input level)

**Example Usage**:
```typescript
// From analysis-job.ts:95
lesson_duration_minutes: z.number().int().min(3).max(45)

// From routers/generation.ts:998
lesson_duration_minutes: (course.settings as any)?.lesson_duration_minutes
```

### 2. Lesson Assembly Code Location

**File**: `packages/course-gen-platform/src/services/stage5/section-batch-generator.ts`

**Key Points**:
- Line 204: Already extracts `language` from `frontend_parameters` (same pattern we need for duration)
- Lines 240-245: Calls `generateWithRetry()` which generates lessons
- **Injection Point Needed**: After LLM generation, before final validation (like metadata-generator.ts:286-295)

### 3. Section Duration Analysis

**Current Situation**:
```typescript
// SectionSchema (generation-result.ts:579-582)
estimated_duration_minutes: z.number()
  .int()
  .positive()
  .describe('Total estimated duration for all lessons in this section')
```

**User's Question**: "Мы и так знаем, что если в секции 10 уроков, и каждый урок по 5 минут, то это 50 минут. Зачем это нужно?"

**Decision**: **Section duration should be CALCULATED** (sum of lesson durations), NOT generated by LLM or injected separately.

**Rationale**:
- Lesson duration is the atomic constraint (fixed by user)
- Section duration is a derived value (sum of lessons)
- No need to store/generate redundant data
- Simpler architecture: one source of truth (lesson duration)

### 4. `validateDurationProportionality` Analysis

**Current Function** (`generation-result.ts:285-292`):

```typescript
function validateDurationProportionality(lesson: {
  key_topics: string[];
  lesson_objectives: unknown[];
  estimated_duration_minutes: number;
  difficulty_level?: 'beginner' | 'intermediate' | 'advanced';
}): { passed: boolean; issues?: string[] }
```

**Purpose**: Validates that lesson duration matches the content complexity (topic count, objective count, difficulty level).

**Problem**: If we inject a FIXED duration (e.g., always 15 minutes), this validation becomes:
- ❌ Irrelevant: We're not validating LLM's judgment anymore
- ❌ Counterproductive: Could reject valid content if user picks a very short/long duration
- ❌ Architectural mismatch: User controls duration as a constraint, not as a variable

**Decision**: **REMOVE this refinement entirely**

**Rationale**:
1. Duration is now a fixed constraint, not a generated value
2. LLM should generate MORE/FEWER lessons to fit duration, not vary duration
3. Validation should focus on content quality, not duration proportionality
4. User has agency to choose any duration (3-45 min) - we shouldn't second-guess

---

## Architecture Comparison

### Before (CURRENT - BROKEN)
```
Frontend Input → Analysis → Generation
                                ↓
                    LLM generates duration (BAD!)
                                ↓
                    Validation fails if >45 min
```

### After (NEW - FIXED)
```
Frontend Input (lesson_duration_minutes=15)
      ↓
Analysis (frontend_parameters.lesson_duration_minutes=15)
      ↓
Generation (LLM generates content WITHOUT duration)
      ↓
Code injects duration=15 AFTER generation
      ↓
Final validation (with injected duration)
```

---

## Implementation Plan

### Phase 2: Schema Changes

**File**: `packages/shared-types/src/generation-result.ts`

1. **Create `LessonBaseSchema` without `.refine()`** (lines 520-546):
   ```typescript
   const LessonBaseSchema = z.object({
     lesson_number: z.number().int().positive(),
     lesson_title: z.string().min(10).max(600),
     // ... all fields INCLUDING estimated_duration_minutes
   });
   // NO .refine() here!
   ```

2. **Create `LessonWithoutInjectedFieldsSchema`**:
   ```typescript
   export const LessonWithoutInjectedFieldsSchema = LessonBaseSchema.omit({
     estimated_duration_minutes: true
   });
   ```

3. **Keep full `LessonSchema` for final validation**:
   ```typescript
   export const LessonSchema = LessonBaseSchema;
   // REMOVE .refine() with validateDurationProportionality
   ```

4. **Update `SectionSchema`** to calculate duration:
   ```typescript
   export const SectionSchema = z.object({
     section_number: z.number().int().positive(),
     section_title: z.string().min(10).max(600),
     section_description: z.string().min(20).max(2000),
     learning_objectives: z.array(z.string().min(10).max(600)).min(1).max(5),

     // REMOVE estimated_duration_minutes field entirely
     // It will be calculated as sum(lessons.estimated_duration_minutes)

     lessons: z.array(LessonSchema).min(1).max(10),
   })
   .transform((section) => ({
     ...section,
     // Calculate section duration from lesson durations
     estimated_duration_minutes: section.lessons.reduce(
       (sum, lesson) => sum + lesson.estimated_duration_minutes,
       0
     ),
   }));
   ```

### Phase 3: Service Layer Changes

**File**: `packages/course-gen-platform/src/services/stage5/section-batch-generator.ts`

1. **Extract duration from frontend_parameters** (line ~204):
   ```typescript
   const language = input.frontend_parameters.language || 'en';
   const lessonDuration = input.frontend_parameters.lesson_duration_minutes || 15;
   ```

2. **Update prompt schema** (search for `zodToPromptSchema`):
   ```typescript
   // OLD: Uses full LessonSchema
   const schemaDescription = zodToPromptSchema(SectionBatchSchema);

   // NEW: Uses schema without duration
   const SectionBatchWithoutInjectedFieldsSchema = z.object({
     section_number: z.number(),
     section_title: z.string(),
     section_description: z.string(),
     learning_objectives: z.array(z.string()),
     lessons: z.array(LessonWithoutInjectedFieldsSchema), // WITHOUT duration
   });
   const schemaDescription = zodToPromptSchema(SectionBatchWithoutInjectedFieldsSchema);
   ```

3. **Inject duration AFTER generation** (add after LLM response parsing):
   ```typescript
   // AFTER generation, BEFORE final validation
   if (result.data.lessons && Array.isArray(result.data.lessons)) {
     result.data.lessons = result.data.lessons.map((lesson: any) => ({
       ...lesson,
       estimated_duration_minutes: lessonDuration, // Inject from frontend_parameters
     }));
   }

   // Then validate with FULL SectionSchema (includes duration)
   validated = SectionSchema.parse(result.data);
   ```

4. **Remove duration from prompts**:
   - Search for "duration" in prompt templates
   - Remove any instructions about generating duration
   - Keep token budget and context size references (unrelated)

### Phase 4: Section Duration Handling

**Approach**: Calculated field via `.transform()`

Section duration will be automatically calculated when `SectionSchema.parse()` runs, using the `.transform()` we added in Phase 2.

**No additional code needed** - Zod handles it automatically.

---

## Files Modified

1. ✅ `packages/shared-types/src/generation-result.ts` - Schema changes
2. ✅ `packages/course-gen-platform/src/services/stage5/section-batch-generator.ts` - Service layer injection
3. ❓ Prompts in section-batch-generator.ts (search needed)

---

## Validation Checklist

- [ ] Build shared-types: `cd packages/shared-types && pnpm build`
- [ ] Type-check: `pnpm type-check:course-gen-platform`
- [ ] Run test: `pnpm test tests/e2e/t053-synergy-sales-course.test.ts`

**Success Criteria**:
- ✅ No "Duration too long" errors
- ✅ No "estimated_duration_minutes" in LLM prompts
- ✅ Duration injected at `lessonDuration` value (from frontend)
- ✅ Section duration calculated correctly
- ✅ All type-checks pass
- ✅ Test t053 passes

---

## Risks & Mitigations

### Risk 1: Database Schema Dependency
**Impact**: If DB expects `estimated_duration_minutes`, removal might break queries.
**Mitigation**: We're NOT removing from final schema, only from LLM generation. DB still gets the field.

### Risk 2: Existing Generated Courses
**Impact**: Old courses have LLM-generated durations, new courses have injected durations.
**Mitigation**: Both produce valid `estimated_duration_minutes` - no migration needed.

### Risk 3: Section Duration Calculation Performance
**Impact**: `.transform()` runs on every parse.
**Mitigation**: Calculation is O(n) where n = lessons (max 10), negligible performance impact.

---

## Related Fixes

1. **UUID/Language Fix** - Same pattern: exclude from LLM → inject from code
2. **exercise_type Migration** - Different pattern: changed enum to freeform

This fix follows **Pattern 1** (UUID/Language).

---

## Next Steps

1. ✅ Investigation complete
2. ⏭️ Implement Phase 2 (Schema Changes)
3. ⏭️ Implement Phase 3 (Service Layer)
4. ⏭️ Implement Phase 4 (Section Duration)
5. ⏭️ Run validation tests

**Estimated Time**: 1-2 hours total implementation + testing
