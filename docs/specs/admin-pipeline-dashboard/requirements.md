# Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ: ĞĞ´Ğ¼Ğ¸Ğ½ÑĞºĞ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ¾Ğ¼ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

## 1. ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ

### 1.1 Ğ¦ĞµĞ»ÑŒ
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ´Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹ MegaCampus, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚:
- ĞŸÑ€Ğ¾ÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºÑƒÑ€ÑĞ¾Ğ² (Ğ²ÑĞµ 6 ÑÑ‚Ğ°Ğ¿Ğ¾Ğ²)
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸ĞµĞ¹ LLM-Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ„Ğ°Ğ·Ñ‹
- Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ
- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ñ OpenRouter API

### 1.2 Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ñ Ñ€Ğ¾Ğ»ÑŒÑ `superadmin`. Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ñ€Ğ¾Ğ»ĞµĞ¹ (admin, instructor, student).

### 1.3 Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
- URL: `/admin/pipeline`
- Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°, Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Ğ¾Ğ±Ñ‰ÑƒÑ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºÑƒ

---

## 2. Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 2.1 ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

ĞŸĞ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ¸Ğ· 6 ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² (stages), Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡ĞµÑ€ĞµĞ· BullMQ:

| Ğ­Ñ‚Ğ°Ğ¿ | ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Ğ¤Ğ°Ğ¹Ğ» handler |
|------|----------|----------|--------------|
| Stage 1 | Document Upload | Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ tRPC) | `stages/stage1-document-upload/handler.ts` |
| Stage 2 | Document Processing | ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Docling, Ñ‡Ğ°Ğ½ĞºĞ¸Ğ½Ğ³, ÑĞ¼Ğ±ĞµĞ´Ğ´Ğ¸Ğ½Ğ³Ğ¸, Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ² Qdrant | `stages/stage2-document-processing/handler.ts` |
| Stage 3 | Classification | ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° | `stages/stage3-classification/handler.ts` |
| Stage 4 | Analysis | ĞœĞ½Ğ¾Ğ³Ğ¾Ñ„Ğ°Ğ·Ğ½Ñ‹Ğ¹ LLM-Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° | `stages/stage4-analysis/handler.ts` |
| Stage 5 | Generation | Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ ĞºÑƒÑ€ÑĞ° | `stages/stage5-generation/handler.ts` |
| Stage 6 | Lesson Content | Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° ÑƒÑ€Ğ¾ĞºĞ¾Ğ² | `stages/stage6-lesson-content/handler.ts` |

### 2.2 ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹

**Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ‘Ğ”**: `llm_model_config`

```sql
-- Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°
id: uuid
config_type: text  -- 'global' | 'course_override'
course_id: uuid (nullable)
phase_name: text   -- 'phase_1_classification', 'phase_2_scope', 'phase_3_expert', 'phase_4_synthesis', 'emergency'
model_id: text     -- OpenRouter model ID (e.g., 'openai/gpt-oss-20b')
fallback_model_id: text (nullable)
temperature: numeric (0-2)
max_tokens: integer (1-200000)
created_at, updated_at: timestamptz
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ñ„Ğ°Ğ·Ñ‹ Ğ¸ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸** (Ğ¸Ğ· `langchain-models.ts:178-218`):

| Ğ¤Ğ°Ğ·Ğ° | ĞœĞ¾Ğ´ĞµĞ»ÑŒ | Temperature | Max Tokens | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------|--------|-------------|------------|------------|
| phase_1_classification | openai/gpt-oss-20b | 0.7 | 4096 | ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ (Ğ¿Ñ€Ğ¾ÑÑ‚Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°) |
| phase_2_scope | openai/gpt-oss-20b | 0.7 | 4096 | ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ scope |
| phase_3_expert | openai/gpt-oss-120b | 0.5 | 8000 | Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°) |
| phase_4_synthesis | openai/gpt-oss-20b | 0.7 | 6000 | Ğ¡Ğ¸Ğ½Ñ‚ĞµĞ· Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² |
| phase_6_rag_planning | openai/gpt-oss-20b | 0.7 | 4096 | ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ RAG |
| emergency | x-ai/grok-4-fast | 0.7 | 30000 | ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ² |
| quality_fallback | moonshotai/kimi-k2-0905 | 0.3 | 16000 | Fallback Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ |

### 2.3 ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹

**Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ñ€Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ**: ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ğ·Ğ°Ñ…Ğ°Ñ€Ğ´ĞºĞ¾Ğ¶ĞµĞ½Ñ‹ Ğ² TypeScript Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ….

**ĞŸĞĞ›ĞĞ«Ğ™ Ğ¡ĞŸĞ˜Ğ¡ĞĞš ĞŸĞ ĞĞœĞŸĞ¢ĞĞ’ Ğ’ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ• (~18 ÑˆÑ‚ÑƒĞº)**:

| Stage | Ğ¤Ğ°Ğ¹Ğ» | ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚/Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|-------|------|----------------|------------|
| **Stage 3** | `phases/phase-classification.ts` | Classification Prompt | ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ°Ğ¼ (CORE/IMPORTANT/SUPPLEMENTARY) |
| **Stage 3** | `utils/tournament-classification.ts` | Tournament Prompt | Ğ¢ÑƒÑ€Ğ½Ğ¸Ñ€Ğ½Ğ°Ñ ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ >100K Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² |
| **Stage 4** | `phases/phase-1-classifier.ts` | `buildClassificationPrompt()` | ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ĞºÑƒÑ€ÑĞ° Ğ¿Ğ¾ 6 ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼, contextual language |
| **Stage 4** | `phases/phase-2-scope.ts` | Scope Prompt | ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ scope ĞºÑƒÑ€ÑĞ° |
| **Stage 4** | `phases/phase-3-expert.ts` | Expert Analysis Prompt | Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· (ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ´Ğ»Ñ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°) |
| **Stage 4** | `phases/phase-4-synthesis.ts` | Synthesis Prompt | Ğ¡Ğ¸Ğ½Ñ‚ĞµĞ· Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ²ÑĞµÑ… Ñ„Ğ°Ğ· |
| **Stage 4** | `phases/phase-6-rag-planning.ts` | RAG Planning Prompt | ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ RAG-ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´Ğ»Ñ ÑƒÑ€Ğ¾ĞºĞ¾Ğ² |
| **Stage 5** | `utils/metadata-generator.ts` | Metadata Prompt | Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºÑƒÑ€ÑĞ° |
| **Stage 5** | `utils/section-batch-generator.ts` | Section Generation Prompt | Ğ‘Ğ°Ñ‚Ñ‡ĞµĞ²Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞµĞºÑ†Ğ¸Ğ¹ ĞºÑƒÑ€ÑĞ° |
| **Stage 5** | `phases/phase3-v2-spec-generator.ts` | V2 Spec Prompt | Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ V2 ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¹ ÑƒÑ€Ğ¾ĞºĞ¾Ğ² |
| **Stage 6** | `utils/prompt-templates.ts` | `buildPlannerPrompt()` | Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ outline ÑƒÑ€Ğ¾ĞºĞ° |
| **Stage 6** | `utils/prompt-templates.ts` | `buildExpanderPrompt()` | Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ ÑĞµĞºÑ†Ğ¸Ğ¹ Ğ² Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ |
| **Stage 6** | `utils/prompt-templates.ts` | `buildAssemblerPrompt()` | Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ÑĞµĞºÑ†Ğ¸Ğ¹ Ğ² ÑƒÑ€Ğ¾Ğº |
| **Stage 6** | `utils/prompt-templates.ts` | `buildSmootherPrompt()` | ĞŸĞ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¾Ğ² Ğ¸ ÑÑ‚Ğ¸Ğ»Ñ |
| **Stage 6** | `judge/prompt-cache.ts` | JUDGE_STATIC_PROMPTS.rubric | OSCQR Ñ€ÑƒĞ±Ñ€Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ğ¾Ñ†ĞµĞ½ĞºĞ¸ (~2000 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²) |
| **Stage 6** | `judge/prompt-cache.ts` | JUDGE_STATIC_PROMPTS.instructions | Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Judge (~500 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²) |
| **Stage 6** | `judge/prompt-cache.ts` | JUDGE_STATIC_PROMPTS.fewShotExamples | Few-shot Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¾Ñ†ĞµĞ½ĞºĞ¸ (~1500 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²) |
| **Stage 6** | `judge/fix-templates.ts` | Fix Templates | Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° Ğ¿Ğ¾ feedback |
| **Stage 6** | `judge/refinement-loop.ts` | Refinement Prompt | Refinement ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Judge |

**Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²** (Context-First XML strategy):
```xml
<lesson_context>
  <metadata>...</metadata>
  <learning_objectives>...</learning_objectives>
  ...
</lesson_context>

<task>
  Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ LLM...
</task>
```

**ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… stages**:
- **Stage 3**: ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ inline Ğ² Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ñ document metadata
- **Stage 4**: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ `SystemMessage` + `HumanMessage` Ğ¸Ğ· LangChain
- **Stage 5**: ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ñ token budget management
- **Stage 6**: Context-First XML strategy + Judge system Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼

### 2.4 OpenRouter Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ

- Base URL: `https://openrouter.ai/api/v1`
- API Key: `OPENROUTER_API_KEY` (env variable)
- Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: `shared/llm/langchain-models.ts`

### 2.5 Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹

- Layout: `packages/web/app/admin/layout.tsx` (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° role === 'admin' || 'superadmin')
- Generation History: `/admin/generation/history`
- Generation Details: `/admin/generation/[courseId]`

---

## 3. Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### 3.1 Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

**FR-1**: Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑŒÑ `superadmin`
**FR-2**: ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ±ĞµĞ· Ğ¿Ñ€Ğ°Ğ² - Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
**FR-3**: Ğ’ÑĞµ Ğ¼ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² `admin_audit_logs`

### 3.2 Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° "ĞĞ±Ğ·Ğ¾Ñ€ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ°" (Pipeline Overview)

**FR-4**: ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒ Ğ²ÑĞµ 6 ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ° Ğ² Ğ²Ğ¸Ğ´Ğµ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑ…ĞµĞ¼Ñ‹/Ñ‚Ğ°Ğ¹Ğ¼Ğ»Ğ°Ğ¹Ğ½Ğ°

**FR-5**: Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ:
- ĞĞ¾Ğ¼ĞµÑ€ Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ğ°
- ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚)
- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ (Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½/Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½)
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ (ÑÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Models)
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ (ÑÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Prompts)
- Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ (Ğ¸Ğ· `generation_trace`)
- Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ (Ğ¸Ğ· `generation_trace`)

**FR-6**: ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ°:
- ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´
- Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ñ…/Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ½Ñ‹Ñ…
- ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ
- Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

### 3.3 Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° "ĞœĞ¾Ğ´ĞµĞ»Ğ¸" (Models Configuration)

**FR-7**: ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ¸Ğ· `llm_model_config`

**FR-8**: Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ„Ğ°Ğ·Ñ‹ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ:
- ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ·Ñ‹ (human-readable)
- Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ (model_id)
- Fallback Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
- Temperature
- Max tokens
- Ğ’ĞµÑ€ÑĞ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
- Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ

**FR-9**: Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:
- Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ° OpenRouter (FR-13)
- Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ temperature (slider 0-2)
- Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ max_tokens (input Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹)
- Ğ’Ñ‹Ğ±Ğ¾Ñ€ fallback Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸

**FR-10**: Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ course-specific override:
- Ğ’Ñ‹Ğ±Ğ¾Ñ€ ĞºÑƒÑ€ÑĞ°
- Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ñ„Ğ°Ğ·Ñ‹
- ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²

**FR-11**: Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğº Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ÑĞ¼ (hardcoded fallbacks)

**FR-12**: ĞŸÑ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ - Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² OpenRouter

**FR-12a**: Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹:
- ĞŸÑ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ (Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ñ‚ÑŒ)
- Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸
- Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
- ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ diff Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ²ĞµÑ€ÑĞ¸ÑĞ¼Ğ¸

**FR-12b**: Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ· Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸:
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `stage_3_classification` - ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `stage_5_metadata` - Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `stage_5_sections` - Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞµĞºÑ†Ğ¸Ğ¹
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `stage_6_judge` - Ğ¾Ñ†ĞµĞ½ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° Judge
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `stage_6_refinement` - refinement ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°
- ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ constraint Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ `llm_model_config`

### 3.4 Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ OpenRouter API

**FR-13**: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ñ‡ĞµÑ€ĞµĞ· OpenRouter API:
- Endpoint: `GET https://openrouter.ai/api/v1/models`
- ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° 1 Ñ‡Ğ°Ñ (Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ñ€ĞµĞ´ĞºĞ¾ Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ)
- ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ: Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€, context length, pricing

**FR-14**: Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒ:
- ID Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ (Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°)
- ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (human-readable)
- ĞŸÑ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€ (OpenAI, Anthropic, etc.)
- Context window size
- Ğ¦ĞµĞ½Ğ° Ğ·Ğ° 1M input/output tokens
- ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ features (vision, function calling, etc.)

**FR-15**: Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹:
- ĞŸĞ¾ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñƒ
- ĞŸĞ¾ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñƒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° (min/max)
- ĞŸĞ¾ Ñ†ĞµĞ½Ğµ
- Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº

### 3.5 Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° "ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹" (Prompts Editor)

**FR-16**: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ `prompt_templates` Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ² Ğ² Ğ‘Ğ”

**FR-17**: Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ `prompt_templates`:
```sql
id: uuid PRIMARY KEY
stage: text NOT NULL  -- 'stage_2', 'stage_3', 'stage_4', 'stage_5', 'stage_6'
prompt_key: text NOT NULL  -- ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡: 'planner', 'expander', 'assembler', 'smoother'
prompt_name: text NOT NULL  -- Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ
prompt_description: text  -- Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°
prompt_template: text NOT NULL  -- ÑĞ°Ğ¼ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ° Ñ Ğ¿Ğ»ĞµĞ¹ÑÑ…Ğ¾Ğ»Ğ´ĞµÑ€Ğ°Ğ¼Ğ¸
variables: jsonb  -- ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…: [{name: 'lessonTitle', type: 'string', required: true}]
is_active: boolean DEFAULT true
version: integer DEFAULT 1
created_at: timestamptz DEFAULT now()
updated_at: timestamptz DEFAULT now()
created_by: uuid REFERENCES users(id)

UNIQUE(stage, prompt_key, version)
```

**FR-18**: ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ² Ğ¸Ğ· ĞºĞ¾Ğ´Ğ° Ğ² Ğ‘Ğ” (seed script)

**FR-19**: ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ², ÑĞ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ°Ğ¼

**FR-20**: Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ:
- ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
- Ğ­Ñ‚Ğ°Ğ¿ (stage)
- Ğ’ĞµÑ€ÑĞ¸Ñ
- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ (active/inactive)
- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸
- Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ

**FR-21**: Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²:
- Textarea Ñ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ¾Ğ¹ ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸ÑĞ° (XML)
- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ¿Ñ€Ğ°Ğ²Ğ°
- Preview Ñ Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¾Ğ¹ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ XML ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹

**FR-22**: Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²:
- ĞŸÑ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ - ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
- Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
- Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸

**FR-23**: Fallback Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°:
- Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ‘Ğ” - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ hardcoded Ğ¸Ğ· ĞºĞ¾Ğ´Ğ°
- Ğ¤Ğ»Ğ°Ğ³ "use_database_prompts" Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğµ (Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°)

### 3.6 Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸

**FR-24**: Ğ¡ĞµĞºÑ†Ğ¸Ñ "Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ°":
- RAG token budget (default: 20000)
- Quality threshold Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸
- Retry attempts per phase
- Timeout per phase

**FR-25**: Ğ¡ĞµĞºÑ†Ğ¸Ñ "Feature flags":
- use_database_prompts: boolean (fallback to code)
- enable_quality_validation: boolean
- enable_cost_tracking: boolean

### 3.7 Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚/Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸

**FR-26**: Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ²ÑĞµĞ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ² JSON:
- Ğ’ÑĞµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸)
- Ğ’ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸)
- Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸ feature flags
- ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° (Ğ´Ğ°Ñ‚Ğ°, Ğ²ĞµÑ€ÑĞ¸Ñ, Ğ°Ğ²Ñ‚Ğ¾Ñ€)

**FR-27**: Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°:
```json
{
  "export_metadata": {
    "version": "1.0",
    "exported_at": "2025-12-03T12:00:00Z",
    "exported_by": "superadmin@example.com",
    "platform_version": "0.22.2"
  },
  "model_configs": [...],
  "prompt_templates": [...],
  "global_settings": {...},
  "feature_flags": {...}
}
```

**FR-28**: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· JSON:
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ÑÑ…ĞµĞ¼Ñ‹ JSON Ğ¿ĞµÑ€ĞµĞ´ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ¼
- Preview Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸ĞµĞ¼
- Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ (Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸/Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹/Ğ²ÑĞµ)
- Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ backup Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿ĞµÑ€ĞµĞ´ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ¼
- Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° (rollback)

**FR-29**: Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°/Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°:
- Ğ‘ÑĞºĞ°Ğ¿ Ğ¿ĞµÑ€ĞµĞ´ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑĞ¼Ğ¸
- ĞŸĞµÑ€ĞµĞ½Ğ¾Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸ÑĞ¼Ğ¸ (dev â†’ staging â†’ prod)
- Ğ¨Ğ°Ñ€Ğ¸Ğ½Ğ³ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼Ğ¸

---

## 4. ĞĞµÑ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### 4.1 ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

**NFR-1**: Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒÑÑ < 2 ÑĞµĞºÑƒĞ½Ğ´
**NFR-2**: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ OpenRouter ĞºÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° 1 Ñ‡Ğ°Ñ
**NFR-3**: Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ² Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ñ Ñ‚ĞµĞºÑÑ‚Ğ°Ğ¼Ğ¸ Ğ´Ğ¾ 10000 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² Ğ±ĞµĞ· Ğ»Ğ°Ğ³Ğ¾Ğ²

### 4.2 Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

**NFR-4**: Ğ’ÑĞµ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ñ‹ `superadminProcedure`
**NFR-5**: Ğ’ÑĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² `admin_audit_logs`
**NFR-6**: API ĞºĞ»ÑÑ‡ OpenRouter Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚
**NFR-7**: Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ²Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ (Zod schemas)

### 4.3 UX/UI

**NFR-8**: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ shadcn/ui
**NFR-9**: ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½ (desktop-first, Ğ½Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ½Ğ° Ğ¿Ğ»Ğ°Ğ½ÑˆĞµÑ‚Ğ°Ñ…)
**NFR-10**: Toast ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ñ…/Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ÑÑ…
**NFR-11**: Confirmation dialogs Ğ´Ğ»Ñ Ğ´ĞµÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹

### 4.4 Ğ¡Ğ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ

**NFR-12**: ĞĞ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: ĞºĞ¾Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ² Ğ² Ğ‘Ğ” (fallback)
**NFR-13**: Gradual rollout: Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒ/Ğ²Ñ‹ĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒ DB prompts per stage

---

## 5. Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### 5.1 Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

```
packages/web/app/admin/pipeline/
â”œâ”€â”€ page.tsx                    # Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
â”œâ”€â”€ layout.tsx                  # Layout Ñ superadmin guard
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ pipeline-overview.tsx   # Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Ğ¾Ğ±Ğ·Ğ¾Ñ€Ğ°
â”‚   â”œâ”€â”€ models-config.tsx       # Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹
â”‚   â”œâ”€â”€ prompts-editor.tsx      # Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²
â”‚   â”œâ”€â”€ model-selector.tsx      # ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
â”‚   â”œâ”€â”€ prompt-editor.tsx       # Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°
â”‚   â””â”€â”€ stats-cards.tsx         # ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸

packages/course-gen-platform/src/
â”œâ”€â”€ server/routers/
â”‚   â””â”€â”€ pipeline-admin.ts       # tRPC Ñ€Ğ¾ÑƒÑ‚ĞµÑ€ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ¸ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ°
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ openrouter-models.ts    # Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ OpenRouter API
â”‚   â””â”€â”€ prompt-service.ts       # Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°Ğ¼Ğ¸
â””â”€â”€ shared/
    â””â”€â”€ prompts/
        â””â”€â”€ prompt-loader.ts    # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ñ‡Ğ¸Ğº Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ² (DB -> fallback to code)

packages/shared-types/src/
â”œâ”€â”€ prompt-template.ts          # Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²
â””â”€â”€ openrouter-models.ts        # Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ OpenRouter
```

### 5.2 tRPC Endpoints

```typescript
// pipeline-admin.ts
export const pipelineAdminRouter = router({
  // Pipeline Overview
  getStagesInfo: superadminProcedure.query(),
  getPipelineStats: superadminProcedure.input(z.object({
    startDate: z.date().optional(),
    endDate: z.date().optional(),
  })).query(),

  // Models Configuration
  listModelConfigs: superadminProcedure.query(),
  updateModelConfig: superadminProcedure.input(ModelConfigUpdateSchema).mutation(),
  resetModelConfigToDefault: superadminProcedure.input(z.object({
    phase: PhaseNameSchema,
  })).mutation(),
  getModelConfigHistory: superadminProcedure.input(z.object({
    phase: PhaseNameSchema,
  })).query(),
  revertModelConfigToVersion: superadminProcedure.input(z.object({
    phase: PhaseNameSchema,
    version: z.number(),
  })).mutation(),

  // OpenRouter Models
  listOpenRouterModels: superadminProcedure.query(),  // cached
  refreshOpenRouterModels: superadminProcedure.mutation(),  // force refresh cache

  // Prompts
  listPromptTemplates: superadminProcedure.query(),
  getPromptTemplate: superadminProcedure.input(z.object({
    stage: StageSchema,
    promptKey: z.string(),
  })).query(),
  updatePromptTemplate: superadminProcedure.input(PromptTemplateUpdateSchema).mutation(),
  revertPromptToVersion: superadminProcedure.input(z.object({
    id: z.string().uuid(),
    version: z.number(),
  })).mutation(),
  getPromptHistory: superadminProcedure.input(z.object({
    stage: StageSchema,
    promptKey: z.string(),
  })).query(),

  // Global Settings
  getGlobalSettings: superadminProcedure.query(),
  updateGlobalSettings: superadminProcedure.input(GlobalSettingsSchema).mutation(),

  // Export/Import
  exportConfiguration: superadminProcedure.query(),  // returns full JSON export
  validateImport: superadminProcedure.input(z.object({
    configJson: z.string(),  // JSON string to validate
  })).mutation(),  // returns validation result + preview
  importConfiguration: superadminProcedure.input(z.object({
    configJson: z.string(),
    importModels: z.boolean().default(true),
    importPrompts: z.boolean().default(true),
    importSettings: z.boolean().default(true),
    createBackup: z.boolean().default(true),
  })).mutation(),
  listBackups: superadminProcedure.query(),
  restoreFromBackup: superadminProcedure.input(z.object({
    backupId: z.string().uuid(),
  })).mutation(),
});
```

### 5.3 OpenRouter API Integration

```typescript
// openrouter-models.ts
interface OpenRouterModel {
  id: string;                    // e.g., "openai/gpt-4"
  name: string;                  // e.g., "GPT-4"
  description: string;
  context_length: number;        // e.g., 128000
  pricing: {
    prompt: string;              // e.g., "0.00003" per token
    completion: string;          // e.g., "0.00006" per token
  };
  top_provider: {
    context_length: number;
    max_completion_tokens: number;
  };
  architecture: {
    modality: string;            // "text->text" | "text+image->text"
    tokenizer: string;
    instruct_type: string;
  };
}

// ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Redis Ğ¸Ğ»Ğ¸ in-memory Ñ TTL 1 hour
async function fetchOpenRouterModels(): Promise<OpenRouterModel[]>;
```

### 5.4 Database Migration

```sql
-- Migration 1: create_prompt_templates_table

CREATE TABLE prompt_templates (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  stage text NOT NULL CHECK (stage IN ('stage_2', 'stage_3', 'stage_4', 'stage_5', 'stage_6')),
  prompt_key text NOT NULL,
  prompt_name text NOT NULL,
  prompt_description text,
  prompt_template text NOT NULL,
  variables jsonb DEFAULT '[]'::jsonb,
  is_active boolean DEFAULT true,
  version integer DEFAULT 1,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES users(id),

  UNIQUE(stage, prompt_key, version)
);

-- Index for fast lookups
CREATE INDEX idx_prompt_templates_stage_key ON prompt_templates(stage, prompt_key) WHERE is_active = true;

-- RLS
ALTER TABLE prompt_templates ENABLE ROW LEVEL SECURITY;

-- Only superadmins can read/write
CREATE POLICY "Superadmins can manage prompt_templates"
  ON prompt_templates
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'superadmin'
    )
  );

COMMENT ON TABLE prompt_templates IS 'LLM prompt templates for course generation pipeline. Supports versioning and fallback to hardcoded prompts.';

-- Migration 2: extend_llm_model_config_phases

-- Ğ Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ñ‹Ñ… Ñ„Ğ°Ğ·
ALTER TABLE llm_model_config DROP CONSTRAINT IF EXISTS llm_model_config_phase_name_check;
ALTER TABLE llm_model_config ADD CONSTRAINT llm_model_config_phase_name_check
  CHECK (phase_name = ANY (ARRAY[
    'phase_1_classification',
    'phase_2_scope',
    'phase_3_expert',
    'phase_4_synthesis',
    'phase_6_rag_planning',
    'emergency',
    'quality_fallback',
    'stage_3_classification',
    'stage_5_metadata',
    'stage_5_sections',
    'stage_6_judge',
    'stage_6_refinement'
  ]::text[]));

-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² llm_model_config
ALTER TABLE llm_model_config ADD COLUMN IF NOT EXISTS version integer DEFAULT 1;
ALTER TABLE llm_model_config ADD COLUMN IF NOT EXISTS is_active boolean DEFAULT true;

-- ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ constraint Ğ´Ğ»Ñ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
ALTER TABLE llm_model_config DROP CONSTRAINT IF EXISTS llm_model_config_config_type_phase_name_key;
CREATE UNIQUE INDEX idx_llm_model_config_active
  ON llm_model_config(config_type, phase_name, course_id)
  WHERE is_active = true;

COMMENT ON COLUMN llm_model_config.version IS 'Version number for configuration history';
COMMENT ON COLUMN llm_model_config.is_active IS 'Only one version per phase should be active';

-- Migration 3: create_config_backups_table

CREATE TABLE config_backups (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  backup_name text NOT NULL,
  backup_data jsonb NOT NULL,
  created_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES users(id),
  description text,
  backup_type text CHECK (backup_type IN ('manual', 'auto_pre_import', 'scheduled'))
);

ALTER TABLE config_backups ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Superadmins can manage config_backups"
  ON config_backups
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'superadmin'
    )
  );

COMMENT ON TABLE config_backups IS 'Backups of pipeline configuration for rollback and disaster recovery.';
```

### 5.5 Seed Script

```typescript
// seed-prompts.ts
// Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ğ¸Ğ· TypeScript Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ğ‘Ğ”
// Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğµ

const PROMPTS_TO_SEED = [
  // Stage 3 - Document Classification
  {
    stage: 'stage_3',
    prompt_key: 'document_classification',
    prompt_name: 'Document Classification',
    prompt_description: 'Classifies documents by priority (CORE/IMPORTANT/SUPPLEMENTARY)',
    source_file: 'stages/stage3-classification/phases/phase-classification.ts',
  },
  {
    stage: 'stage_3',
    prompt_key: 'tournament_classification',
    prompt_name: 'Tournament Classification',
    prompt_description: 'Two-stage classification for large document sets (>100K tokens)',
    source_file: 'stages/stage3-classification/utils/tournament-classification.ts',
  },

  // Stage 4 - Analysis Phases
  {
    stage: 'stage_4',
    prompt_key: 'phase_1_classifier',
    prompt_name: 'Phase 1: Course Classification',
    prompt_description: 'Classifies course into 6 categories, generates contextual language',
    source_file: 'stages/stage4-analysis/phases/phase-1-classifier.ts',
  },
  {
    stage: 'stage_4',
    prompt_key: 'phase_2_scope',
    prompt_name: 'Phase 2: Scope Definition',
    prompt_description: 'Defines course scope and boundaries',
    source_file: 'stages/stage4-analysis/phases/phase-2-scope.ts',
  },
  {
    stage: 'stage_4',
    prompt_key: 'phase_3_expert',
    prompt_name: 'Phase 3: Expert Analysis',
    prompt_description: 'Deep expert analysis (quality-critical)',
    source_file: 'stages/stage4-analysis/phases/phase-3-expert.ts',
  },
  {
    stage: 'stage_4',
    prompt_key: 'phase_4_synthesis',
    prompt_name: 'Phase 4: Synthesis',
    prompt_description: 'Synthesizes results from all phases',
    source_file: 'stages/stage4-analysis/phases/phase-4-synthesis.ts',
  },
  {
    stage: 'stage_4',
    prompt_key: 'phase_6_rag_planning',
    prompt_name: 'Phase 6: RAG Planning',
    prompt_description: 'Plans RAG context retrieval for lessons',
    source_file: 'stages/stage4-analysis/phases/phase-6-rag-planning.ts',
  },

  // Stage 5 - Generation
  {
    stage: 'stage_5',
    prompt_key: 'metadata_generator',
    prompt_name: 'Course Metadata Generator',
    prompt_description: 'Generates course metadata and descriptions',
    source_file: 'stages/stage5-generation/utils/metadata-generator.ts',
  },
  {
    stage: 'stage_5',
    prompt_key: 'section_batch_generator',
    prompt_name: 'Section Batch Generator',
    prompt_description: 'Generates course sections in batches',
    source_file: 'stages/stage5-generation/utils/section-batch-generator.ts',
  },
  {
    stage: 'stage_5',
    prompt_key: 'v2_spec_generator',
    prompt_name: 'V2 Lesson Specification Generator',
    prompt_description: 'Generates V2 lesson specifications',
    source_file: 'stages/stage5-generation/phases/phase3-v2-spec-generator.ts',
  },

  // Stage 6 - Lesson Content
  {
    stage: 'stage_6',
    prompt_key: 'planner',
    prompt_name: 'Lesson Planner',
    prompt_description: 'Generates lesson outline from specification',
    source_file: 'stages/stage6-lesson-content/utils/prompt-templates.ts',
  },
  {
    stage: 'stage_6',
    prompt_key: 'expander',
    prompt_name: 'Section Expander',
    prompt_description: 'Expands section outline into full content',
    source_file: 'stages/stage6-lesson-content/utils/prompt-templates.ts',
  },
  {
    stage: 'stage_6',
    prompt_key: 'assembler',
    prompt_name: 'Lesson Assembler',
    prompt_description: 'Assembles sections into complete lesson',
    source_file: 'stages/stage6-lesson-content/utils/prompt-templates.ts',
  },
  {
    stage: 'stage_6',
    prompt_key: 'smoother',
    prompt_name: 'Content Smoother',
    prompt_description: 'Polishes transitions and style',
    source_file: 'stages/stage6-lesson-content/utils/prompt-templates.ts',
  },

  // Stage 6 - Judge System
  {
    stage: 'stage_6',
    prompt_key: 'judge_rubric',
    prompt_name: 'OSCQR Rubric',
    prompt_description: 'OSCQR evaluation rubric (~2000 tokens)',
    source_file: 'stages/stage6-lesson-content/judge/prompt-cache.ts',
  },
  {
    stage: 'stage_6',
    prompt_key: 'judge_instructions',
    prompt_name: 'Judge Instructions',
    prompt_description: 'Instructions for content evaluation (~500 tokens)',
    source_file: 'stages/stage6-lesson-content/judge/prompt-cache.ts',
  },
  {
    stage: 'stage_6',
    prompt_key: 'judge_few_shot',
    prompt_name: 'Judge Few-Shot Examples',
    prompt_description: 'Few-shot examples for evaluation (~1500 tokens)',
    source_file: 'stages/stage6-lesson-content/judge/prompt-cache.ts',
  },
  {
    stage: 'stage_6',
    prompt_key: 'fix_templates',
    prompt_name: 'Content Fix Templates',
    prompt_description: 'Templates for fixing content based on judge feedback',
    source_file: 'stages/stage6-lesson-content/judge/fix-templates.ts',
  },
];

// Total: 18 prompts across 4 stages
```

---

## 6. UI Wireframes (Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ)

### 6.1 Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° `/admin/pipeline`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Dashboard > Pipeline Configuration                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Overview]  [Models]  [Prompts]  [Settings]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  (Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸)                              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pipeline Statistics (Last 30 days)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ 1,234    â”‚ â”‚ 95.2%    â”‚ â”‚ $45.67   â”‚ â”‚ 12m 34s  â”‚       â”‚
â”‚  â”‚ Total    â”‚ â”‚ Success  â”‚ â”‚ Cost     â”‚ â”‚ Avg Time â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Pipeline Stages                                            â”‚
â”‚                                                             â”‚
â”‚  [1]â”€â”€>[2]â”€â”€>[3]â”€â”€>[4]â”€â”€>[5]â”€â”€>[6]                         â”‚
â”‚  Upload Process Class  Analyze Generate Content             â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Stage 4: Analysis                                    â”‚   â”‚
â”‚  â”‚ Multi-phase LLM analysis with quality validation     â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ Models: phase_1 â†’ gpt-oss-20b                       â”‚   â”‚
â”‚  â”‚         phase_2 â†’ gpt-oss-20b                       â”‚   â”‚
â”‚  â”‚         phase_3 â†’ gpt-oss-120b (critical)           â”‚   â”‚
â”‚  â”‚         phase_4 â†’ gpt-oss-20b                       â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ Prompts: 4 active templates                          â”‚   â”‚
â”‚  â”‚ Avg time: 3m 45s | Avg cost: $0.12                  â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ [Configure Models] [Edit Prompts]                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Models

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Model Configuration                        [Refresh Models]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase               â”‚ Model          â”‚ Temp â”‚ Tokens â”‚ Act â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”‚
â”‚  Phase 1 Classif.    â”‚ gpt-oss-20b    â”‚ 0.7  â”‚ 4096   â”‚ [âœ] â”‚
â”‚  Phase 2 Scope       â”‚ gpt-oss-20b    â”‚ 0.7  â”‚ 4096   â”‚ [âœ] â”‚
â”‚  Phase 3 Expert      â”‚ gpt-oss-120b   â”‚ 0.5  â”‚ 8000   â”‚ [âœ] â”‚
â”‚  Phase 4 Synthesis   â”‚ gpt-oss-20b    â”‚ 0.7  â”‚ 6000   â”‚ [âœ] â”‚
â”‚  Emergency           â”‚ grok-4-fast    â”‚ 0.7  â”‚ 30000  â”‚ [âœ] â”‚
â”‚  Quality Fallback    â”‚ kimi-k2-0905   â”‚ 0.3  â”‚ 16000  â”‚ [âœ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Available OpenRouter Models              [Filter â–¼] [ğŸ”]   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ openai/gpt-4o          â”‚ 128K ctx â”‚ $5/$15 per 1M  â”‚   â”‚
â”‚  â”‚ anthropic/claude-3.5   â”‚ 200K ctx â”‚ $3/$15 per 1M  â”‚   â”‚
â”‚  â”‚ openai/gpt-oss-120b    â”‚ 128K ctx â”‚ $0.5/$1 per 1M â”‚   â”‚
â”‚  â”‚ ...                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° Prompts

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Templates                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Stage: [All â–¼]  Status: [Active â–¼]              [+ New]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stages        â”‚ Prompt Editor                               â”‚
â”‚               â”‚                                             â”‚
â”‚ â–¼ Stage 4     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â—‹ Phase 1   â”‚ â”‚ Lesson Planner (stage_6/planner)       â”‚â”‚
â”‚   â—‹ Phase 2   â”‚ â”‚ Version: 3 | Active | Last: 2025-12-01 â”‚â”‚
â”‚   â—‹ Phase 3   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚   â—‹ Phase 4   â”‚ â”‚ <lesson_context>                       â”‚â”‚
â”‚               â”‚ â”‚   <metadata>                           â”‚â”‚
â”‚ â–¼ Stage 6     â”‚ â”‚     <lesson_id>{{lessonId}}</lesson_id>â”‚â”‚
â”‚   â— Planner   â”‚ â”‚     <title>{{title}}</title>           â”‚â”‚
â”‚   â—‹ Expander  â”‚ â”‚     ...                                â”‚â”‚
â”‚   â—‹ Assembler â”‚ â”‚   </metadata>                          â”‚â”‚
â”‚   â—‹ Smoother  â”‚ â”‚   ...                                  â”‚â”‚
â”‚               â”‚ â”‚ </lesson_context>                      â”‚â”‚
â”‚               â”‚ â”‚                                        â”‚â”‚
â”‚               â”‚ â”‚ <task>                                 â”‚â”‚
â”‚               â”‚ â”‚   Create a detailed lesson outline...  â”‚â”‚
â”‚               â”‚ â”‚ </task>                                â”‚â”‚
â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚               â”‚ Variables:                                â”‚
â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚               â”‚ â”‚ lessonSpec: LessonSpecificationV2 [req]â”‚â”‚
â”‚               â”‚ â”‚ ragChunks: RAGChunk[] [req]            â”‚â”‚
â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                             â”‚
â”‚               â”‚ [Preview] [History] [Save] [Revert]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸ĞµĞ¼ĞºĞ¸

### 7.1 ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ (MVP)

- [ ] Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ superadmin
- [ ] ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ±Ğ·Ğ¾Ñ€ Ğ²ÑĞµÑ… 6 ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ° Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ÑĞ¼Ğ¸
- [ ] ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ (Ğ²ÑĞµ ~12 Ñ„Ğ°Ğ·)
- [ ] Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
- [ ] Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ Ñ OpenRouter API Ğ¸ ĞºÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ÑÑ
- [ ] Ğ’ÑĞµ ~18 Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ² Ğ¼Ğ¸Ğ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ² Ğ‘Ğ” Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· UI
- [ ] Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ² Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹ Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°
- [ ] Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ fallback Ğ½Ğ° hardcoded Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹/Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
- [ ] Ğ’ÑĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² audit log
- [ ] JSON ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ + Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ + Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸)
- [ ] JSON Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸ preview Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

### 7.2 Ğ–ĞµĞ»Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ (Nice-to-have)

- [ ] Preview Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ° Ñ Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¾Ğ¹ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- [ ] Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ°Ğ¼ (Ğ¸Ğ· generation_trace)
- [ ] Diff Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ²ĞµÑ€ÑĞ¸ÑĞ¼Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¹
- [ ] A/B Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²
- [ ] Bulk operations (Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹/Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²)

---

## 8. Ğ Ğ¸ÑĞºĞ¸ Ğ¸ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ

### 8.1 Ğ Ğ¸ÑĞºĞ¸

| Ğ Ğ¸ÑĞº | Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ | Ğ’Ğ»Ğ¸ÑĞ½Ğ¸Ğµ | ĞœĞ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ |
|------|-------------|---------|-----------|
| OpenRouter API Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | ĞĞ¸Ğ·ĞºĞ¾Ğµ | ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ + Ğ¿Ğ¾ĞºĞ°Ğ· Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ |
| ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ»Ğ¾Ğ¼Ğ°ĞµÑ‚ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ | Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ | Fallback Ğ½Ğ° ĞºĞ¾Ğ´ + Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ + preview |
| ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ² Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ | Ğ¢Ñ‰Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ seed script |

### 8.2 ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ

- ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Stage 1 Ğ½Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹ (Ñ‚Ğ°Ğ¼ Ğ½ĞµÑ‚ LLM Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²)
- ĞŸĞµÑ€Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ±ĞµĞ· A/B Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- ĞĞµÑ‚ real-time collaboration (Ğ¾Ğ´Ğ¸Ğ½ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾)

---

## 9. Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

### 9.1 Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğµ
- OpenRouter API (`https://openrouter.ai/api/v1/models`)
- Supabase (Ğ‘Ğ” + Auth)

### 9.2 Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ
- `packages/web` - Next.js Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´
- `packages/course-gen-platform` - tRPC backend
- `packages/shared-types` - Ğ¾Ğ±Ñ‰Ğ¸Ğµ Ñ‚Ğ¸Ğ¿Ñ‹
- Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ shadcn/ui

---

## 10. Ğ“Ğ»Ğ¾ÑÑĞ°Ñ€Ğ¸Ğ¹

| Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½ | ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ |
|--------|-------------|
| Stage | Ğ­Ñ‚Ğ°Ğ¿ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (1-6) |
| Phase | Ğ¤Ğ°Ğ·Ğ° Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ÑÑ‚Ğ°Ğ¿Ğ° (Ğ½Ğ°Ğ¿Ñ€. phase_1_classification Ğ² Stage 4) |
| Prompt Template | Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ° Ñ Ğ¿Ğ»ĞµĞ¹ÑÑ…Ğ¾Ğ»Ğ´ĞµÑ€Ğ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… |
| Fallback | Ğ—Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ |
| OpenRouter | ĞĞ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€ API Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… LLM Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ¾Ğ² |

---

## 11. Ğ¡ÑÑ‹Ğ»ĞºĞ¸

### ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°
- Admin layout: `packages/web/app/admin/layout.tsx`
- Admin router: `packages/course-gen-platform/src/server/routers/admin.ts`
- Authorization middleware: `packages/course-gen-platform/src/server/middleware/authorize.ts`

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹
- Model selector service: `packages/course-gen-platform/src/shared/llm/langchain-models.ts`
- DB table: `llm_model_config`

### Stage 3 - Classification
- Phase classification: `packages/course-gen-platform/src/stages/stage3-classification/phases/phase-classification.ts`
- Tournament classification: `packages/course-gen-platform/src/stages/stage3-classification/utils/tournament-classification.ts`

### Stage 4 - Analysis
- Phase 1 classifier: `packages/course-gen-platform/src/stages/stage4-analysis/phases/phase-1-classifier.ts`
- Phase 2 scope: `packages/course-gen-platform/src/stages/stage4-analysis/phases/phase-2-scope.ts`
- Phase 3 expert: `packages/course-gen-platform/src/stages/stage4-analysis/phases/phase-3-expert.ts`
- Phase 4 synthesis: `packages/course-gen-platform/src/stages/stage4-analysis/phases/phase-4-synthesis.ts`
- Phase 6 RAG planning: `packages/course-gen-platform/src/stages/stage4-analysis/phases/phase-6-rag-planning.ts`

### Stage 5 - Generation
- Metadata generator: `packages/course-gen-platform/src/stages/stage5-generation/utils/metadata-generator.ts`
- Section batch generator: `packages/course-gen-platform/src/stages/stage5-generation/utils/section-batch-generator.ts`
- V2 spec generator: `packages/course-gen-platform/src/stages/stage5-generation/phases/phase3-v2-spec-generator.ts`

### Stage 6 - Lesson Content
- Prompt templates: `packages/course-gen-platform/src/stages/stage6-lesson-content/utils/prompt-templates.ts`
- Judge prompt cache: `packages/course-gen-platform/src/stages/stage6-lesson-content/judge/prompt-cache.ts`
- Fix templates: `packages/course-gen-platform/src/stages/stage6-lesson-content/judge/fix-templates.ts`
- Refinement loop: `packages/course-gen-platform/src/stages/stage6-lesson-content/judge/refinement-loop.ts`

### ĞĞ±Ñ‰Ğ¸Ğµ Ñ‚Ğ¸Ğ¿Ñ‹
- Model config types: `packages/shared-types/src/model-config.ts`
- Analysis schemas: `packages/shared-types/src/analysis-schemas.ts`
