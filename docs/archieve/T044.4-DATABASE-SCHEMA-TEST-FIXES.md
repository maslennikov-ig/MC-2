# Database Schema Test Fixes - Complete Guide

## Current Status

- **File**: `tests/integration/database-schema.test.ts`
- **Issue**: Python script removed `.from()` calls, breaking syntax
- **Solution**: Manual reconstruction required OR git revert + careful manual fixes

## Root Cause Analysis

The database schema tests are failing due to **missing `id` fields** in INSERT statements. PostgreSQL error code `23502` indicates "NOT NULL constraint violation" on the `id` column.

### Database Schema Requirements

From `supabase/migrations/20250110_initial_schema.sql`:

```sql
-- Organizations: id has DEFAULT gen_random_uuid()
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ...
);

-- Users: id DEFAULT auth.uid() - REQUIRES explicit ID when using service role
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT auth.uid(),
    ...
);

-- Courses: id has DEFAULT gen_random_uuid()
CREATE TABLE courses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ...
);
```

**KEY INSIGHT**: The `users` table has `DEFAULT auth.uid()` which doesn't work with service role client. We MUST provide explicit IDs.

## Fix Strategy

### Step 1: Restore File (if broken)

```bash
# If file is damaged by Python script:
cd tests/integration
git checkout HEAD -- database-schema.test.ts

# OR restore from last known good state
```

### Step 2: Add Missing Fields Systematically

**Pattern for Organizations**:

```typescript
// BEFORE (BROKEN):
const { data: org } = await supabase
  .from('organizations')
  .insert({
    name: uniqueName('test_org'),
  })
  .select()
  .single();

// AFTER (FIXED):
const { data: org } = await supabase
  .from('organizations')
  .insert({
    id: randomUUID(), // ← ADD THIS
    name: uniqueName('test_org'),
    tier: 'free', // ← ADD THIS
    storage_quota_bytes: 10485760, // ← ADD THIS
    storage_used_bytes: 0, // ← ADD THIS
  })
  .select()
  .single();
```

**Pattern for Users**:

```typescript
// BEFORE (BROKEN):
const { data: user } = await supabase
  .from('users')
  .insert({
    email: 'test@example.com',
    organization_id: orgId,
    role: 'instructor',
  })
  .select()
  .single();

// AFTER (FIXED):
const { data: user } = await supabase
  .from('users')
  .insert({
    id: randomUUID(), // ← ADD THIS
    email: 'test@example.com',
    organization_id: orgId,
    role: 'instructor',
  })
  .select()
  .single();
```

**Pattern for Courses**:

```typescript
// BEFORE (BROKEN):
const { data: course } = await supabase
  .from('courses')
  .insert({
    title: 'Test Course',
    slug: 'test-course',
    user_id: userId,
    organization_id: orgId,
  })
  .select()
  .single();

// AFTER (FIXED):
const { data: course } = await supabase
  .from('courses')
  .insert({
    id: randomUUID(), // ← ADD THIS
    title: 'Test Course',
    slug: 'test-course',
    user_id: userId,
    organization_id: orgId,
    status: 'draft', // ← ADD THIS (optional but recommended)
  })
  .select()
  .single();
```

### Step 3: Use Helper Functions

The file already has helper functions defined at the top. Use them instead of inline inserts:

```typescript
// Instead of inline inserts:
const { data: org } = await supabase.from('organizations').insert({...}).select().single();

// Use the helper:
const org = await createTestOrg();  // Returns org with all required fields
createdOrgs.push(org.id);

// Similarly for users and courses:
const user = await createTestUser(org.id, 'instructor');
createdUsers.push(user.id);

const course = await createTestCourse(org.id, user.id);
createdCourses.push(course.id);
```

### Step 4: Fix Specific Failing Tests

#### Test: "should enforce unique user emails" (Line ~457)

**Current (Broken)**:

```typescript
const { data: org } = await supabase.insert({
  // ← MISSING .from('organizations')
  id: randomUUID(),
  name: uniqueName('org_unique_email'),
});
```

**Fixed**:

```typescript
const org = await createTestOrg();
createdOrgs.push(org.id);

const email = `unique_${randomUUID()}@test.com`;
const { data: user1 } = await supabase
  .from('users')
  .insert({
    id: randomUUID(), // ← ADD THIS
    email,
    organization_id: org.id,
    role: 'student',
  })
  .select()
  .single();
```

#### Test: "should enforce unique course slugs per organization" (Line ~498)

**Fixed**:

```typescript
const org = await createTestOrg();
createdOrgs.push(org.id);

const user = await createTestUser(org.id, 'instructor');
createdUsers.push(user.id);

const slug = uniqueName('unique-slug');
const { data: course1 } = await supabase
  .from('courses')
  .insert({
    id: randomUUID(), // ← ADD THIS
    title: 'Course 1',
    slug,
    user_id: user.id,
    organization_id: org.id,
  })
  .select()
  .single();
```

#### Test: "should allow same slug in different organizations" (Line ~555)

**Fixed**:

```typescript
const org1 = await createTestOrg();
const org2 = await createTestOrg();
createdOrgs.push(org1.id, org2.id);

const user1 = await createTestUser(org1.id, 'instructor');
const user2 = await createTestUser(org2.id, 'instructor');
createdUsers.push(user1.id, user2.id);

const sharedSlug = 'shared-slug';
const { data: course1, error: error1 } = await supabase
  .from('courses')
  .insert({
    id: randomUUID(), // ← ADD THIS
    title: 'Org1 Course',
    slug: sharedSlug,
    user_id: user1.id,
    organization_id: org1.id,
  })
  .select()
  .single();
```

#### Tests in "Test 6: Check constraints validate data integrity"

**All tests in this section need**:

1. Add `id: randomUUID()` to all organizations inserts
2. Add `id: randomUUID()` to all users inserts
3. Add `id: randomUUID()` to all courses inserts
4. OR use helper functions instead

Example for "should enforce sections.order_index > 0":

```typescript
const org = await createTestOrg();
createdOrgs.push(org.id);

const user = await createTestUser(org.id, 'instructor');
createdUsers.push(user.id);

const course = await createTestCourse(org.id, user.id);
createdCourses.push(course.id);

// Test section constraints...
```

#### Tests in "Additional Data Integrity Tests"

Same pattern - replace inline inserts with helper functions:

```typescript
// "should properly handle enum values for course_status"
const org = await createTestOrg();
createdOrgs.push(org.id);

const user = await createTestUser(org.id, 'instructor');
createdUsers.push(user.id);

const validStatuses = ['draft', 'published', 'archived'] as const;
for (const status of validStatuses) {
  const { data, error } = await supabase
    .from('courses')
    .insert({
      id: randomUUID(), // ← ADD THIS
      title: `Course ${status}`,
      slug: uniqueName(`course-${status}`),
      user_id: user.id,
      organization_id: org.id,
      status,
    })
    .select()
    .single();

  expect(error).toBeNull();
  expect(data?.status).toBe(status);
  if (data?.id) createdCourses.push(data.id);
}
```

## Complete List of Fixes Needed

| Test Name                                                   | Line  | Fix Required                                                    |
| ----------------------------------------------------------- | ----- | --------------------------------------------------------------- |
| "should enforce unique user emails"                         | ~457  | Add `.from('organizations')` + `id` field                       |
| "should enforce unique course slugs per organization"       | ~498  | Add `.from('organizations')` + `id` field to org, user, courses |
| "should allow same slug in different organizations"         | ~555  | Add `.from('organizations')` + `id` fields, or use helpers      |
| "should enforce unique enrollment per user-course pair"     | ~632  | Add `.from('organizations')` + `id` fields                      |
| "should enforce storage_used_bytes >= 0"                    | ~711  | Add `.from('organizations')` + `id` field                       |
| "should enforce sections.order_index > 0"                   | ~737  | Add `.from('organizations')` + `id` fields for org/user/course  |
| "should enforce lessons.order_index > 0"                    | ~816  | Add `.from('organizations')` + `id` fields for org/user/course  |
| "should enforce lessons.duration_minutes > 0 when not null" | ~895  | Add `.from('organizations')` + `id` fields                      |
| "should enforce file_catalog.file_size > 0"                 | ~1009 | Add `.from('organizations')` + `id` field                       |
| "should properly handle enum values for course_status"      | ~1076 | Add `.from('organizations')` + `id` fields                      |
| "should properly handle enum values for lesson_type"        | ~1124 | Add `.from('organizations')` + `id` fields                      |
| "should properly handle enrollment_status enum values"      | ~1192 | Add `.from('organizations')` + `id` fields                      |

## Recommended Approach

Given the extensive damage to the file, the fastest approach is:

1. **Git restore** the file to undo Python script damage
2. **Manually add** `id: randomUUID()` to the 10-12 specific failing test cases
3. **Run tests** to verify each fix
4. **Use helper functions** wherever possible to reduce code duplication

## Alternative: Complete Rewrite Using Helpers

Replace ALL inline inserts with helper functions:

```typescript
// Current problematic pattern (repeated ~30 times in file):
const { data: org } = await supabase.from('organizations').insert({...}).select().single();
const { data: user } = await supabase.from('users').insert({...}).select().single();
const { data: course } = await supabase.from('courses').insert({...}).select().single();

// Better pattern (consistent, less error-prone):
const org = await createTestOrg();
createdOrgs.push(org.id);

const user = await createTestUser(org.id, 'instructor');
createdUsers.push(user.id);

const course = await createTestCourse(org.id, user.id);
createdCourses.push(course.id);
```

This would reduce the file from ~1400 lines to ~1000 lines and eliminate most NOT NULL errors.

## Verification

After fixes, run:

```bash
pnpm test tests/integration/database-schema.test.ts
```

Expected result:

```
✓ Test 1: Organizations table enforces tier enum values (2/2)
✓ Test 2: Organizations table enforces storage quota constraints (6/6)
✓ Test 3: Users table enforces role enum values (2/2)
✓ Test 4: Foreign key constraints work correctly (3/3)
✓ Test 5: Unique constraints prevent duplicates (5/5)
✓ Test 6: Check constraints validate data integrity (5/5)
✓ Additional Data Integrity Tests (3/3)

Test Files  1 passed (1)
     Tests  26 passed (26)
```

## Summary

The database schema tests require explicit `id` fields because:

1. The `users` table uses `DEFAULT auth.uid()` which doesn't work with service role
2. Even though organizations and courses have `DEFAULT gen_random_uuid()`, Supabase JS client doesn't always trigger defaults
3. Explicitly providing IDs ensures test isolation and prevents conflicts

The solution is systematic: add `id: randomUUID()` to every INSERT for organizations, users, and courses tables.
