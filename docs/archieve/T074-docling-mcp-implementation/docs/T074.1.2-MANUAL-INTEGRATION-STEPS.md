# T074.1.2: Manual Integration Steps

This document outlines the manual steps required to complete the Docling MCP integration.

## Step 1: Register Document Processing Handler

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/src/orchestrator/worker.ts`

### Add Import (Line ~23)

```typescript
import { documentProcessingHandler } from './handlers/document-processing.js';
```

### Register Handler (Line ~45)

```typescript
const jobHandlers: Record<string, BaseJobHandler<JobData>> = {
  [JobType.TEST_JOB]: testJobHandler,
  [JobType.INITIALIZE]: initializeJobHandler,
  [JobType.DOCUMENT_PROCESSING]: documentProcessingHandler,  // ← Add this line
  // TODO (Stage 1+): Register additional handlers
  // [JobType.SUMMARY_GENERATION]: summaryGenerationHandler,
  // ...
};
```

**Full diff**:

```diff
import { testJobHandler } from './handlers/test-handler';
import { initializeJobHandler } from './handlers/initialize';
+import { documentProcessingHandler } from './handlers/document-processing';
import { handleJobFailure } from './handlers/error-handler';

...

const jobHandlers: Record<string, BaseJobHandler<JobData>> = {
  [JobType.TEST_JOB]: testJobHandler,
  [JobType.INITIALIZE]: initializeJobHandler,
+ [JobType.DOCUMENT_PROCESSING]: documentProcessingHandler,
  // TODO (Stage 1+): Register additional handlers
```

---

## Step 2: Add Environment Variables

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/.env`

Add these lines (already added to `.env.example`):

```bash
# Docling MCP Server Configuration
DOCLING_MCP_URL=http://docling-mcp:8000/mcp
DOCLING_MCP_TIMEOUT=300000
```

For **local development** (if not using Docker):
```bash
DOCLING_MCP_URL=http://localhost:8000/mcp
```

---

## Step 3: Build and Start Docling MCP Server

### Option A: Docker (Recommended)

```bash
# Navigate to service directory
cd /home/me/code/megacampus2/services/docling-mcp

# Build image
docker compose build

# Start service
docker compose up -d

# Verify health
curl http://localhost:8000/health

# Check logs
docker logs -f docling-mcp-server
```

### Option B: Native Python (Development Only)

**Prerequisites**:
```bash
sudo apt install python3.12-venv libgl1-mesa-glx libglib2.0-0
```

**Setup**:
```bash
cd /home/me/code/megacampus2/services/docling-mcp
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install "docling-mcp>=1.3.2"

# Run server
docling-mcp-server --transport streamable-http --host 0.0.0.0 --port 8000
```

---

## Step 4: Verify MCP Client Connection

Create a test script to verify the connection:

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/scripts/test-docling-connection.ts`

```typescript
import { getDoclingClient } from '../src/shared/mcp';

async function testConnection() {
  console.log('Testing Docling MCP connection...');

  const client = getDoclingClient();

  try {
    await client.connect();
    console.log('✓ Connected to Docling MCP server');

    const tools = await client.listTools();
    console.log('✓ Available tools:', tools.map(t => t.name));

    await client.disconnect();
    console.log('✓ Disconnected successfully');

    process.exit(0);
  } catch (error) {
    console.error('✗ Connection failed:', error);
    process.exit(1);
  }
}

testConnection();
```

**Run**:
```bash
cd /home/me/code/megacampus2/packages/course-gen-platform
tsx scripts/test-docling-connection.ts
```

**Expected output**:
```
Testing Docling MCP connection...
✓ Connected to Docling MCP server
✓ Available tools: [ 'convert_document' ]
✓ Disconnected successfully
```

---

## Step 5: Test End-to-End Document Processing

### 5.1: Prepare Test Document

```bash
# Create test directory
mkdir -p /home/me/code/megacampus2/packages/course-gen-platform/uploads/test-org/test-course

# Copy a sample PDF (or create a simple one)
cp /path/to/sample.pdf /home/me/code/megacampus2/packages/course-gen-platform/uploads/test-org/test-course/test-doc.pdf
```

### 5.2: Create Test Job

Create a test script:

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/scripts/test-document-processing.ts`

```typescript
import { addJob } from '../src/orchestrator/queue';
import { JobType } from '@megacampus/shared-types';

async function testDocumentProcessing() {
  console.log('Creating DOCUMENT_PROCESSING job...');

  const job = await addJob(JobType.DOCUMENT_PROCESSING, {
    organizationId: '00000000-0000-0000-0000-000000000000',
    courseId: '00000000-0000-0000-0000-000000000000',
    userId: '00000000-0000-0000-0000-000000000000',
    jobType: JobType.DOCUMENT_PROCESSING,
    createdAt: new Date().toISOString(),
    fileId: 'test-file-id',  // Must exist in file_catalog
    filePath: 'test-org/test-course/test-doc.pdf',
    mimeType: 'application/pdf',
    chunkSize: 512,
    chunkOverlap: 50,
  });

  console.log('Job created:', {
    id: job.id,
    name: job.name,
    status: await job.getState(),
  });

  console.log('Monitor job status with:');
  console.log(`  curl http://localhost:3000/api/trpc/jobs.getJobStatus?input={"jobId":"${job.id}"}`);
}

testDocumentProcessing().catch(console.error);
```

**Run**:
```bash
tsx scripts/test-document-processing.ts
```

### 5.3: Monitor Job Progress

```bash
# Check BullMQ Board UI
open http://localhost:3000/admin/queues

# Or use tRPC endpoint
curl http://localhost:3000/api/trpc/jobs.getJobStatus?input='{"jobId":"job-id-here"}'
```

---

## Step 6: Verify Database Updates

After job completes, check file_catalog:

```sql
SELECT
  id,
  file_path,
  vector_status,
  parsed_content IS NOT NULL as has_parsed_content,
  (parsed_content->'metadata'->'page_count')::int as page_count,
  metadata->'docling' as docling_metadata
FROM file_catalog
WHERE id = 'your-file-id';
```

**Expected**:
- `vector_status` = 'indexing'
- `has_parsed_content` = true
- `page_count` > 0
- `docling_metadata` contains processing info

---

## Step 7: Create Unit Tests

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/tests/shared/mcp/docling-client.test.ts`

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { getDoclingClient, DoclingErrorCode } from '@/shared/mcp';

describe('DoclingClient', () => {
  let client: ReturnType<typeof getDoclingClient>;

  beforeAll(async () => {
    client = getDoclingClient();
    await client.connect();
  });

  afterAll(async () => {
    await client.disconnect();
  });

  it('should connect to MCP server', () => {
    expect(client.isConnectedToServer()).toBe(true);
  });

  it('should list available tools', async () => {
    const tools = await client.listTools();
    expect(tools).toHaveLength(1);
    expect(tools[0].name).toBe('convert_document');
  });

  // Add more tests as needed
});
```

**Run tests**:
```bash
npm test -- docling-client.test.ts
```

---

## Step 8: Integration with File Upload (T057)

When a file is uploaded, create a DOCUMENT_PROCESSING job:

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/src/server/routers/files.ts`

Add after file is saved to disk:

```typescript
// After successful file upload
const fileRecord = await supabase
  .from('file_catalog')
  .insert({
    id: fileId,
    organization_id: organizationId,
    course_id: courseId,
    file_path: relativePath,
    file_name: filename,
    mime_type: mimeType,
    file_size: fileSize,
    vector_status: 'pending',
  })
  .select()
  .single();

// Create document processing job
await addJob(JobType.DOCUMENT_PROCESSING, {
  organizationId,
  courseId,
  userId,
  jobType: JobType.DOCUMENT_PROCESSING,
  createdAt: new Date().toISOString(),
  fileId,
  filePath: relativePath,
  mimeType,
  chunkSize: 512,
  chunkOverlap: 50,
});
```

---

## Step 9: Update Docker Compose (Production)

**File**: `/home/me/code/megacampus2/docker-compose.yml` or `docker-compose.prod.yml`

Add Docling MCP service:

```yaml
services:
  # ... existing services ...

  docling-mcp:
    build: ./services/docling-mcp
    container_name: docling-mcp-server
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./packages/course-gen-platform/uploads:/app/uploads:ro
      - docling-cache:/app/cache
      - docling-models:/app/models
    environment:
      - DOCLING_CACHE_DIR=/app/cache
      - DOCLING_MODELS_PATH=/app/models
      - DOCLING_LOG_LEVEL=INFO
    networks:
      - megacampus-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

volumes:
  # ... existing volumes ...
  docling-cache:
  docling-models:

networks:
  megacampus-network:
    driver: bridge
```

---

## Step 10: Monitoring Setup (Optional)

Add Prometheus metrics and Grafana dashboard:

**Metrics to collect**:
- Document processing time (histogram)
- Success/failure rate (counter)
- Active jobs (gauge)
- Queue depth (gauge)

**Example Prometheus scrape config**:
```yaml
scrape_configs:
  - job_name: 'bullmq'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/metrics'
```

---

## Checklist

- [ ] Step 1: Register handler in worker.ts
- [ ] Step 2: Add environment variables to .env
- [ ] Step 3: Build and start Docling MCP server
- [ ] Step 4: Verify MCP client connection
- [ ] Step 5: Test end-to-end document processing
- [ ] Step 6: Verify database updates
- [ ] Step 7: Create unit tests
- [ ] Step 8: Integrate with file upload (T057)
- [ ] Step 9: Update Docker Compose for production
- [ ] Step 10: Set up monitoring (optional)

---

## Troubleshooting

### Issue: "Connection refused" when testing client

**Solution**: Ensure Docling MCP server is running:
```bash
docker ps | grep docling-mcp
# OR
curl http://localhost:8000/health
```

### Issue: "Cannot find module '@modelcontextprotocol/sdk'"

**Solution**: Install dependencies:
```bash
cd /home/me/code/megacampus2/packages/course-gen-platform
pnpm install
```

### Issue: "File not found" in MCP server

**Solution**: Check volume mount in docker-compose.yml:
```yaml
volumes:
  - ./packages/course-gen-platform/uploads:/app/uploads:ro
```

Verify file exists:
```bash
ls -la /home/me/code/megacampus2/packages/course-gen-platform/uploads/test-org/test-course/
```

### Issue: Worker not picking up jobs

**Solution**:
1. Check worker is running
2. Check Redis connection
3. Verify handler is registered in worker.ts

```bash
# Check BullMQ Board
open http://localhost:3000/admin/queues
```

---

## Next Steps After Completion

1. **T075: Document Chunking** - Read parsed_content, create chunks
2. **T076: Embedding Generation** - Generate embeddings for chunks
3. **T077: Vector Indexing** - Insert embeddings into Qdrant
4. **Performance testing** - Benchmark with various document sizes
5. **Load testing** - Test concurrent processing capacity

---

**Document Version**: 1.0
**Last Updated**: 2025-10-13
**Author**: Infrastructure Setup Specialist
