# T044.15: Fix and Enable Skipped Tests

**Priority**: P0 - Critical (RLS policies have zero test coverage)
**Status**: üü° **PHASE 1 COMPLETE** (Verification done, critical finding)
**Created**: 2025-10-12
**Updated**: 2025-10-12
**Parent Task**: T044 (Testing Infrastructure)
**Impact**: **Security vulnerability - RLS policies untested**

---

## ‚úÖ VERIFICATION COMPLETE (2025-10-12)

**Phase 1 Status**: COMPLETED
**Duration**: 30 minutes
**Critical Finding**: ‚ö†Ô∏è **RLS policies have ZERO test coverage**

### Key Findings

1. ‚ùå **pgTAP tests DON'T exist** - `supabase/tests/` directory is missing
2. ‚ùå **TypeScript RLS tests are non-functional** - require auth infrastructure (test_set_jwt)
3. ‚ùå **Zero RLS test coverage** - Critical security vulnerability
4. ‚ö†Ô∏è **Production deployment blocked** - Cannot verify security policies

**Detailed Report**: [`T044.15-VERIFICATION-REPORT.md`](/docs/T044.15-VERIFICATION-REPORT.md)

**Recommendation**: Create **T044.16: Implement pgTAP RLS Tests** (P0 - Critical, 4-6 hours)

---

## üìã Executive Summary

Currently **178/186 tests pass** (96%), with **8 tests skipped** and **1 test file marked as deprecated**. This task analyzes skipped tests and determines appropriate actions: enable them, replace them with better alternatives, or document why they should remain skipped.

### Current Test Status

```
Test Files:  11 passed | 1 skipped (12)
Tests:       178 passed | 8 skipped (186)
Duration:    ~120s
```

**Breakdown**:

- ‚úÖ **178 passing tests** - All functional tests work correctly
- ‚è≠Ô∏è **8 skipped tests** - All from deprecated `rls-policies.test.ts`
- ‚è≠Ô∏è **1 skipped file** - `rls-policies.test.ts` (DEPRECATED)

---

## üîç Analysis of Skipped Tests

### 1. Deprecated RLS Tests (8 tests)

**File**: `tests/integration/rls-policies.test.ts`
**Status**: `describe.skip` (all tests skipped)
**Reason**: Marked as DEPRECATED - RLS tests moved to pgTAP

**Tests skipped**:

1. Admin user queries courses ‚Üí returns all organization courses
2. Instructor user queries courses ‚Üí returns only own courses
3. Student user queries courses ‚Üí returns only enrolled courses
4. Instructor cannot delete courses owned by other instructors
5. Student cannot create courses (403 error)
6. Student cannot insert any course even with different user_id
7. Complete data isolation between organizations
8. Prevent cross-organization enrollment attempts

**Deprecation note from file**:

```
/**
 * DEPRECATED: RLS tests moved to pgTAP
 * See: supabase/tests/database/001-rls-policies.test.sql
 *
 * Reason: pgTAP is best practice for RLS testing per Supabase documentation
 * - Transaction isolation (BEGIN...ROLLBACK for automatic cleanup)
 * - Faster execution (no HTTP overhead)
 * - No infrastructure dependencies (no Dashboard configuration needed)
 * - Works everywhere (local, CI, production)
 * - Recommended by Supabase: https://supabase.com/docs/guides/local-development/testing/overview
 *
 * To run RLS tests:
 *   pnpm test:rls
 */
```

### 2. Conditional Skips (Redis Version)

**Files**: `bullmq.test.ts`, `job-cancellation.test.ts`
**Status**: `describe.skipIf(shouldSkipTests)`
**Condition**: Redis version < 5.0.0

**Current Redis version**: 7.4.6 ‚úÖ (all tests run)

These are NOT actually skipped in our environment - they run successfully. The `skipIf` is a safety check for environments with old Redis versions.

---

## üéØ Tasks and Recommendations

### Task 1: Verify pgTAP RLS Tests Exist and Work ‚ö†Ô∏è

**Priority**: P1 - High
**Status**: üî¥ NEEDS VERIFICATION

**Check**:

```bash
# Check if pgTAP tests exist
ls -la packages/course-gen-platform/supabase/tests/database/

# Run pgTAP tests
pnpm test:rls
```

**Expected**: pgTAP test file `001-rls-policies.test.sql` should exist and cover all 8 scenarios from deprecated tests.

**If pgTAP tests DON'T exist**:

- ‚ùå **CRITICAL**: RLS policies have ZERO test coverage
- ‚ö†Ô∏è Need to either:
  1. Create pgTAP tests (recommended by Supabase)
  2. Re-enable TypeScript RLS tests temporarily

**If pgTAP tests DO exist**:

- ‚úÖ Verify they run: `pnpm test:rls`
- ‚úÖ Verify coverage of all 8 scenarios
- ‚úÖ Document in README how to run them

### Task 2: Delete or Archive Deprecated RLS Tests

**Priority**: P3 - Low
**Status**: üü° OPTIONAL

**Options**:

**Option A: Delete entirely** (Recommended)

```bash
rm packages/course-gen-platform/tests/integration/rls-policies.test.ts
```

**Pros**: Clean codebase, no confusion
**Cons**: Lose reference implementation

**Option B: Move to archive**

```bash
mkdir -p packages/course-gen-platform/tests/archive
mv packages/course-gen-platform/tests/integration/rls-policies.test.ts \
   packages/course-gen-platform/tests/archive/rls-policies.test.ts.backup
```

**Pros**: Keep for reference
**Cons**: More files to maintain

**Recommendation**: **Option A (Delete)** - pgTAP is the source of truth now

### Task 3: Add Missing Test Coverage (Optional)

**Priority**: P3 - Low
**Status**: üü° OPTIONAL

**Areas that could use more tests**:

1. **Edge cases in job-status-tracker.ts**:
   - Concurrent updates to same job
   - Database connection failures during updates
   - Retry logic edge cases

2. **Error handling in worker.ts**:
   - Worker crashes during job processing
   - Redis connection loss during job
   - Database unavailable during status update

3. **Integration tests for complete flows**:
   - End-to-end course generation flow
   - Multiple users processing jobs concurrently
   - Job cancellation during different phases

4. **Performance tests**:
   - High concurrency (100+ jobs)
   - Large document processing
   - Memory leak detection

### Task 4: Add Test Coverage Reporting

**Priority**: P2 - Medium
**Status**: üü° RECOMMENDED

**Add coverage tooling**:

```bash
pnpm add -D @vitest/coverage-v8
```

**Update package.json**:

```json
{
  "scripts": {
    "test:coverage": "vitest run --coverage",
    "test:coverage:ui": "vitest run --coverage --ui"
  }
}
```

**Target coverage**:

- ‚úÖ Statements: 80%+
- ‚úÖ Branches: 75%+
- ‚úÖ Functions: 80%+
- ‚úÖ Lines: 80%+

---

## üìä Implementation Plan

### Phase 1: Verification (30 minutes)

**Step 1**: Check if pgTAP tests exist

```bash
# Check for pgTAP test files
find packages/course-gen-platform/supabase/tests -name "*.sql"

# Check for test:rls script
grep -r "test:rls" packages/course-gen-platform/package.json
```

**Step 2**: Run pgTAP tests (if they exist)

```bash
cd packages/course-gen-platform
pnpm test:rls
```

**Step 3**: Document findings

- Create verification report
- List all pgTAP test scenarios
- Compare with deprecated TypeScript tests

### Phase 2: Cleanup (15 minutes)

**If pgTAP tests exist and pass**:

```bash
# Remove deprecated test file
git rm packages/course-gen-platform/tests/integration/rls-policies.test.ts

# Commit
git add .
git commit -m "chore: remove deprecated RLS tests (moved to pgTAP)"
```

**Update documentation**:

```markdown
# Running Tests

## RLS Policy Tests

RLS policies are tested using pgTAP (PostgreSQL native testing):

\`\`\`bash
pnpm test:rls
\`\`\`

See: supabase/tests/database/001-rls-policies.test.sql
```

### Phase 3: Coverage (Optional, 1-2 hours)

```bash
# Install coverage tools
pnpm add -D @vitest/coverage-v8

# Run coverage
pnpm test:coverage

# View coverage report
open coverage/index.html
```

---

## ‚úÖ Acceptance Criteria

### Must Have (P1) - PHASE 1 COMPLETE ‚úÖ

- ‚úÖ Verify pgTAP RLS tests exist ‚Üí **FOUND: They DON'T exist (critical)**
- ‚ùå Run pgTAP tests successfully ‚Üí **BLOCKED: Tests don't exist**
- ‚úÖ Document location and how to run RLS tests ‚Üí **DOCUMENTED: Missing**

### Should Have (P2) - DEFERRED

- ‚è∏Ô∏è Remove or archive deprecated `rls-policies.test.ts` ‚Üí **DEFERRED: Kept as reference for pgTAP**
- ‚úÖ All tests still pass after cleanup: 178/178 ‚Üí **VERIFIED: 178 tests passing**
- ‚è∏Ô∏è Update README with current test status ‚Üí **DEFERRED: Waiting for pgTAP**

### Nice to Have (P3) - DEFERRED

- ‚è∏Ô∏è Add test coverage reporting ‚Üí **DEFERRED: Focus on security first**
- ‚è∏Ô∏è Coverage > 80% for critical paths ‚Üí **DEFERRED: RLS coverage = 0%**
- ‚è∏Ô∏è Add performance tests for high concurrency ‚Üí **DEFERRED: Security > performance**

---

## üéØ Phase 1 Completion Summary

**What Was Done**:

1. ‚úÖ Checked if pgTAP tests exist (verified directory structure)
2. ‚úÖ Analyzed skipped TypeScript tests (8 tests from deprecated file)
3. ‚úÖ Attempted to re-enable TypeScript tests (failed - auth infrastructure missing)
4. ‚úÖ Documented critical security gap (zero RLS test coverage)
5. ‚úÖ Created comprehensive verification report

**Critical Discovery**:

- ‚ùå RLS policies have **ZERO test coverage** (neither pgTAP nor TypeScript)
- ‚ö†Ô∏è This is a **security vulnerability** blocking production deployment

**Next Action Required**:

- üö® **Create T044.16: Implement pgTAP RLS Tests** (P0 - Critical, 4-6 hours)

---

## üîç Risk Assessment

### Low Risk ‚úÖ

- **pgTAP tests exist and work**: Simply remove deprecated file
- **Test count remains high**: 178 passing tests provide good coverage
- **No production impact**: Testing infrastructure only

### Medium Risk ‚ö†Ô∏è

- **pgTAP tests don't exist**: Need to create them or re-enable TypeScript tests
- **pgTAP tests incomplete**: Missing some scenarios from deprecated tests

### High Risk ‚ùå

- **No RLS test coverage at all**: Security vulnerability
- **Can't run pgTAP tests**: Infrastructure missing

---

## üìö Related Files

### To Check

- `/packages/course-gen-platform/supabase/tests/database/001-rls-policies.test.sql` (should exist)
- `/packages/course-gen-platform/tests/integration/rls-policies.test.ts` (deprecated)
- `/packages/course-gen-platform/package.json` (check for test:rls script)

### To Possibly Delete

- `/packages/course-gen-platform/tests/integration/rls-policies.test.ts` (if pgTAP tests exist)

### To Update

- `/packages/course-gen-platform/README.md` (document RLS testing)
- `/packages/course-gen-platform/package.json` (add coverage scripts)

---

## üìù Notes

### Why pgTAP is Better for RLS Testing

1. **Transaction Isolation**: Tests run in transactions that auto-rollback (no cleanup needed)
2. **Performance**: No HTTP overhead (direct PostgreSQL)
3. **Portability**: Works everywhere (local, CI, production)
4. **Recommended**: Official Supabase best practice
5. **Simplicity**: No auth setup complexity

### Comparison: TypeScript vs pgTAP

| Aspect          | TypeScript Tests     | pgTAP Tests          |
| --------------- | -------------------- | -------------------- |
| **Setup**       | Complex (auth, HTTP) | Simple (SQL only)    |
| **Speed**       | Slow (HTTP calls)    | Fast (direct DB)     |
| **Cleanup**     | Manual (delete data) | Automatic (ROLLBACK) |
| **CI/CD**       | Requires Dashboard   | Works anywhere       |
| **Maintenance** | High                 | Low                  |

**Verdict**: pgTAP is objectively better for RLS testing ‚úÖ

---

## üéØ Success Metrics

### Before Cleanup

```
Test Files:  12 total (11 passed, 1 skipped)
Tests:       186 total (178 passed, 8 skipped)
RLS Tests:   0 active (8 deprecated)
```

### After Cleanup (Target)

```
Test Files:  11 total (11 passed, 0 skipped)
Tests:       178 total (178 passed, 0 skipped)
RLS Tests:   8+ active (pgTAP)
Coverage:    80%+ (optional)
```

---

**Created By**: Claude Code (Anthropic)
**Analysis Duration**: 30 minutes
**Priority**: P2 - Medium (working, but needs cleanup)
**Complexity**: Low (mostly verification and cleanup)
**Estimated Effort**: 1-2 hours (verification + cleanup + documentation)
