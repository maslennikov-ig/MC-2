# T044.3: Fix Remaining Test Suite Failures

**Date**: 2025-10-11
**Status**: üîß Ready for Implementation
**Priority**: Medium
**Previous Task**: T044.2 (Completed - 5/5 job cancellation tests passing)

---

## Executive Summary

After successfully fixing job cancellation tests (T044.2), a full test suite run revealed **35 failing tests out of 186 total tests** (127 passing). The failures are primarily concentrated in:

1. **`tests/orchestrator/worker.test.ts`** - Foreign key constraint violations
2. **`tests/integration/bullmq.test.ts`** - Timeouts and missing test data

**Current Test Results:**

```
Test Files  7 failed | 6 passed (13)
Tests       35 failed | 127 passed | 2 skipped (186)
Success Rate: 68% (should be 100%)
```

**Root Cause**: Test fixtures (organizations, users, courses) are not properly set up before tests run, causing foreign key violations and missing data errors.

---

## Problem Analysis

### Issue 1: Foreign Key Constraint Violations

**File**: `tests/orchestrator/worker.test.ts`

**Error Pattern**:

```
insert or update on table "job_status" violates foreign key constraint "job_status_organization_id_fkey"
```

**Why This Happens**:

- Tests create jobs with `organizationId` that don't exist in the database
- The `job_status` table requires valid organization_id (foreign key to organizations table)
- Tests don't set up test organizations before adding jobs

**Affected Tests**:

- "should process a test job successfully"
- "should handle job failures and retries"
- All worker tests that create jobs

**Example from logs**:

```typescript
// Test tries to create job with non-existent org:
jobData: {
  organizationId: '550e8400-e29b-41d4-a716-446655440000', // ‚ùå Doesn't exist
  userId: 'test-user-id',
  // ...
}

// Result: Foreign key constraint violation
```

---

### Issue 2: Test Timeouts

**File**: `tests/integration/bullmq.test.ts`

**Error Pattern**:

```
Timeout waiting for job 1039 to reach DB state(s): completed. Current state: active
Timeout waiting for job 1049 to reach DB state(s): failed. Current state: not found in DB
```

**Why This Happens**:

1. Jobs get stuck in "active" state and never complete
2. Some jobs never get created in database at all ("not found in DB")
3. Likely related to missing test organizations/courses/users

**Affected Tests**:

- "should add a test job and process it successfully"
- "should retry failed jobs with exponential backoff"

---

### Issue 3: Missing Test Data Initialization

**Root Problem**: Tests assume organizations, users, and courses exist, but they're not created in `beforeAll` hooks.

**What's Missing**:

- Test organizations (Premium, Free tiers)
- Test users (admin, instructors, students)
- Test courses
- Proper cleanup between tests

---

## Solution: Implement Test Fixtures

### Step 1: Create Shared Test Fixtures Module

**File**: `tests/fixtures/index.ts` (NEW)

Create a centralized module for test data setup:

```typescript
import { getSupabaseAdmin } from '../../src/shared/supabase/admin';

export interface TestOrganization {
  id: string;
  name: string;
  tier: 'free' | 'premium' | 'enterprise';
}

export interface TestUser {
  id: string;
  email: string;
  role: 'admin' | 'instructor' | 'student';
  organizationId: string;
}

export interface TestCourse {
  id: string;
  name: string;
  organizationId: string;
  userId: string; // instructor who owns it
}

// Predefined test data (stable IDs for consistency)
export const TEST_ORGS: Record<string, TestOrganization> = {
  premium: {
    id: '759ba851-3f16-4294-9627-dc5a0a366c8e', // Already used in cancellation tests
    name: 'Test Premium Org',
    tier: 'premium',
  },
  free: {
    id: '850e8400-e29b-41d4-a716-446655440001',
    name: 'Test Free Org',
    tier: 'free',
  },
};

export const TEST_USERS: Record<string, TestUser> = {
  admin: {
    id: '00000000-0000-0000-0000-000000000011',
    email: 'admin@test.com',
    role: 'admin',
    organizationId: TEST_ORGS.premium.id,
  },
  instructor1: {
    id: '00000000-0000-0000-0000-000000000012',
    email: 'instructor1@test.com',
    role: 'instructor',
    organizationId: TEST_ORGS.premium.id,
  },
  instructor2: {
    id: '00000000-0000-0000-0000-000000000013',
    email: 'instructor2@test.com',
    role: 'instructor',
    organizationId: TEST_ORGS.premium.id,
  },
  student: {
    id: '00000000-0000-0000-0000-000000000014',
    email: 'student@test.com',
    role: 'student',
    organizationId: TEST_ORGS.premium.id,
  },
};

export const TEST_COURSES: Record<string, TestCourse> = {
  course1: {
    id: '00000000-0000-0000-0000-000000000021',
    name: 'Test Course 1',
    organizationId: TEST_ORGS.premium.id,
    userId: TEST_USERS.instructor1.id,
  },
  course2: {
    id: '00000000-0000-0000-0000-000000000022',
    name: 'Test Course 2',
    organizationId: TEST_ORGS.premium.id,
    userId: TEST_USERS.instructor2.id,
  },
};

/**
 * Initialize all test fixtures
 * Call this in beforeAll hooks
 */
export async function setupTestFixtures(): Promise<void> {
  const supabase = getSupabaseAdmin();

  // 1. Create organizations
  for (const org of Object.values(TEST_ORGS)) {
    await supabase.from('organizations').upsert(
      {
        id: org.id,
        name: org.name,
        tier: org.tier,
      },
      { onConflict: 'id' }
    );
  }

  // 2. Create users
  for (const user of Object.values(TEST_USERS)) {
    await supabase.from('users').upsert(
      {
        id: user.id,
        email: user.email,
        role: user.role,
        organization_id: user.organizationId,
      },
      { onConflict: 'id' }
    );
  }

  // 3. Create courses
  for (const course of Object.values(TEST_COURSES)) {
    await supabase.from('courses').upsert(
      {
        id: course.id,
        name: course.name,
        organization_id: course.organizationId,
        user_id: course.userId,
        // Add other required fields based on schema
      },
      { onConflict: 'id' }
    );
  }
}

/**
 * Clean up all test fixtures
 * Call this in afterAll hooks
 */
export async function cleanupTestFixtures(): Promise<void> {
  const supabase = getSupabaseAdmin();

  // Delete in reverse order (respect foreign keys)
  await supabase
    .from('courses')
    .delete()
    .in(
      'id',
      Object.values(TEST_COURSES).map(c => c.id)
    );
  await supabase
    .from('users')
    .delete()
    .in(
      'id',
      Object.values(TEST_USERS).map(u => u.id)
    );
  await supabase
    .from('organizations')
    .delete()
    .in(
      'id',
      Object.values(TEST_ORGS).map(o => o.id)
    );
}

/**
 * Clean up test jobs only (keep fixtures)
 * Call this in afterEach hooks
 */
export async function cleanupTestJobs(): Promise<void> {
  const supabase = getSupabaseAdmin();

  // Only clean up test job types
  await supabase.from('job_status').delete().eq('job_type', 'test_job');
  await supabase.from('job_status').delete().eq('job_type', 'initialize');
}
```

---

### Step 2: Update worker.test.ts

**File**: `tests/orchestrator/worker.test.ts`

**Changes Needed**:

```typescript
import { describe, it, expect, beforeAll, afterAll, afterEach } from 'vitest';
import {
  setupTestFixtures,
  cleanupTestFixtures,
  cleanupTestJobs,
  TEST_ORGS,
  TEST_USERS,
  TEST_COURSES,
} from '../fixtures';
// ... other imports

describe('BullMQ Worker', () => {
  let worker: any;

  beforeAll(async () => {
    // ‚≠ê ADD: Initialize test fixtures
    await setupTestFixtures();

    // Connect Redis
    const redis = getRedisClient();
    await redis.connect();

    // Start worker
    worker = getWorker(1);
  }, 15000);

  afterEach(async () => {
    // ‚≠ê ADD: Clean up jobs after each test
    await cleanupTestJobs();
    await cleanupAllJobs(); // BullMQ queue cleanup
  });

  afterAll(async () => {
    // Stop worker
    await stopWorker(false);
    await closeQueue();

    const redis = getRedisClient();
    await redis.quit();

    // ‚≠ê ADD: Clean up test fixtures
    await cleanupTestFixtures();
  }, 10000);

  describe('should process a test job successfully', () => {
    it('processes test job', async () => {
      const jobData: TestJobData = {
        jobType: JobType.TEST_JOB,
        organizationId: TEST_ORGS.premium.id, // ‚≠ê USE: Existing org
        courseId: TEST_COURSES.course1.id, // ‚≠ê USE: Existing course
        userId: TEST_USERS.instructor1.id, // ‚≠ê USE: Existing user
        message: 'Test message',
        createdAt: new Date().toISOString(),
      };

      const job = await addJob(JobType.TEST_JOB, jobData);
      // ... rest of test
    });
  });

  // ‚≠ê UPDATE: All other tests to use TEST_ORGS, TEST_USERS, TEST_COURSES
});
```

---

### Step 3: Update bullmq.test.ts

**File**: `tests/integration/bullmq.test.ts`

**Changes Needed**:

```typescript
import {
  setupTestFixtures,
  cleanupTestFixtures,
  cleanupTestJobs,
  TEST_ORGS,
  TEST_USERS,
  TEST_COURSES,
} from '../fixtures';

describe('BullMQ Orchestration System', () => {
  beforeAll(async () => {
    // ‚≠ê ADD: Initialize test fixtures
    await setupTestFixtures();

    // ... existing setup
  });

  afterEach(async () => {
    // ‚≠ê ADD: Clean up jobs after each test
    await cleanupTestJobs();
  });

  afterAll(async () => {
    // ‚≠ê ADD: Clean up test fixtures
    await cleanupTestFixtures();

    // ... existing cleanup
  });

  // ‚≠ê UPDATE: All tests to use TEST_ORGS, TEST_USERS, TEST_COURSES
});
```

---

### Step 4: Refactor job-cancellation.test.ts (DRY)

**File**: `tests/integration/job-cancellation.test.ts`

Currently this test has its own fixture setup. Refactor to use shared module:

```typescript
import { setupTestFixtures, cleanupTestFixtures, TEST_ORGS, TEST_USERS } from '../fixtures';

describe('Job Cancellation System', () => {
  let worker: any;

  beforeAll(async () => {
    // Connect Redis
    const redis = getRedisClient();
    await redis.connect();

    // ‚≠ê REPLACE: Custom setup with shared fixtures
    await setupTestFixtures();

    // Start worker
    worker = getWorker(1);
  }, 15000);

  afterAll(async () => {
    // Clean up jobs
    await cleanupAllJobs();
    await cleanupJobStatusDB();

    await stopWorker(false);
    await closeQueue();
    const redis = getRedisClient();
    await redis.quit();

    // ‚≠ê REPLACE: Custom cleanup with shared fixtures
    await cleanupTestFixtures();
  }, 10000);

  // ‚≠ê UPDATE: Use TEST_ORGS.premium.id instead of hardcoded ID
  // ‚≠ê UPDATE: Use TEST_USERS.admin.id, TEST_USERS.instructor1.id, etc.
});
```

---

## Implementation Checklist

- [ ] **Task 1**: Create `tests/fixtures/index.ts` with shared test data
  - [ ] Define TEST_ORGS, TEST_USERS, TEST_COURSES constants
  - [ ] Implement setupTestFixtures()
  - [ ] Implement cleanupTestFixtures()
  - [ ] Implement cleanupTestJobs()

- [ ] **Task 2**: Update `tests/orchestrator/worker.test.ts`
  - [ ] Import shared fixtures
  - [ ] Add setupTestFixtures() to beforeAll
  - [ ] Add cleanupTestJobs() to afterEach
  - [ ] Add cleanupTestFixtures() to afterAll
  - [ ] Replace hardcoded IDs with TEST_ORGS/TEST_USERS/TEST_COURSES

- [ ] **Task 3**: Update `tests/integration/bullmq.test.ts`
  - [ ] Import shared fixtures
  - [ ] Add setupTestFixtures() to beforeAll
  - [ ] Add cleanupTestJobs() to afterEach
  - [ ] Add cleanupTestFixtures() to afterAll
  - [ ] Replace hardcoded IDs with shared constants

- [ ] **Task 4**: Refactor `tests/integration/job-cancellation.test.ts`
  - [ ] Remove custom fixture setup
  - [ ] Use shared setupTestFixtures()
  - [ ] Replace hardcoded IDs with shared constants
  - [ ] Verify all 5 tests still pass

- [ ] **Task 5**: Run full test suite
  - [ ] `pnpm test` - should have 0 failures
  - [ ] Verify no foreign key violations
  - [ ] Verify no timeouts
  - [ ] All 186 tests should pass

---

## Expected Outcome

After implementing all fixes:

```
Test Files  13 passed (13)
Tests       186 passed (186)
Duration    ~60s
```

**Zero failures, zero foreign key violations, zero timeouts.**

---

## Files to Create/Modify

### New Files:

1. `tests/fixtures/index.ts` - Shared test data and setup functions

### Modified Files:

1. `tests/orchestrator/worker.test.ts` - Use shared fixtures
2. `tests/integration/bullmq.test.ts` - Use shared fixtures
3. `tests/integration/job-cancellation.test.ts` - Refactor to use shared fixtures

---

## Notes

### Why This Approach is Better

1. **DRY (Don't Repeat Yourself)**: Test fixtures defined once, used everywhere
2. **Consistency**: All tests use same stable IDs
3. **Maintainability**: Change test data in one place
4. **Reliability**: Proper setup/teardown prevents test pollution
5. **Debugging**: Easy to identify which test data is being used

### Database Schema Dependencies

Make sure test fixtures respect foreign key constraints:

```
organizations (no dependencies)
  ‚Üì
users (depends on organizations)
  ‚Üì
courses (depends on organizations, users)
  ‚Üì
job_status (depends on organizations, courses, users)
```

Cleanup must happen in reverse order.

---

## Risk Assessment

**Low Risk**:

- Changes are isolated to test files
- No production code changes
- Existing passing tests (127) should remain passing

**Medium Risk**:

- Need to ensure proper cleanup between tests
- Shared fixtures might cause test pollution if not cleaned properly

**Mitigation**:

- Use `afterEach` to clean up jobs
- Use stable, predictable UUIDs
- Test fixtures are upserted (idempotent)

---

## Agent Prompt for Next Session

```
Implement shared test fixtures to fix 35 failing tests.

Current Status:
- Job cancellation tests: 5/5 passing ‚úÖ
- Other tests: 35/161 failing ‚ùå
- Root cause: Missing test organizations/users/courses causing foreign key violations

Required Implementation:

1. Create tests/fixtures/index.ts:
   - Define TEST_ORGS, TEST_USERS, TEST_COURSES constants
   - Implement setupTestFixtures() function
   - Implement cleanupTestFixtures() function
   - Implement cleanupTestJobs() function

2. Update tests/orchestrator/worker.test.ts:
   - Import and use shared fixtures
   - Replace hardcoded IDs with shared constants
   - Add proper setup/cleanup hooks

3. Update tests/integration/bullmq.test.ts:
   - Import and use shared fixtures
   - Replace hardcoded IDs with shared constants
   - Add proper setup/cleanup hooks

4. Refactor tests/integration/job-cancellation.test.ts:
   - Remove duplicate fixture code
   - Use shared fixtures module
   - Verify 5/5 tests still pass

5. Run full test suite:
   - Execute: pnpm test
   - Expected: 186 passed, 0 failed
   - Verify no foreign key violations
   - Verify no timeouts

Refer to: /home/me/code/megacampus2/docs/T044.3-FIX-OTHER-TESTS.md

Success criteria: All 186 tests passing with zero errors.
```

---

**End of Document**
