# T044.15: Fix Skipped Tests - Verification Report

**Date**: 2025-10-12
**Status**: âš ï¸ **CRITICAL FINDING**
**Verification Duration**: 30 minutes
**Priority**: P1 - Critical (zero RLS test coverage = security vulnerability)

---

## ğŸ” Executive Summary

**CRITICAL SECURITY FINDING**: RLS policies have **ZERO test coverage**. Both pgTAP tests (recommended) and TypeScript tests (deprecated) are non-functional.

### Verification Results

| Item                  | Expected         | Actual                  | Status       |
| --------------------- | ---------------- | ----------------------- | ------------ |
| pgTAP tests exist     | âœ… Yes           | âŒ **No**               | **CRITICAL** |
| TypeScript tests work | N/A (deprecated) | âŒ **No** (auth issues) | **BLOCKED**  |
| RLS test coverage     | > 0              | **0%**                  | **CRITICAL** |
| Security risk         | Low              | **High**                | **CRITICAL** |

---

## ğŸ“Š Detailed Findings

### Finding 1: pgTAP Tests Don't Exist âŒ

**Expected**: pgTAP test file at `supabase/tests/database/001-rls-policies.test.sql`

**Actual**:

```bash
$ find packages/course-gen-platform/supabase -name "*.sql" -type f 2>/dev/null | grep -i test
(empty result)

$ ls -la packages/course-gen-platform/supabase/tests/ 2>/dev/null
ls: cannot access 'packages/course-gen-platform/supabase/tests/': No such file exists
```

**Result**: The entire `supabase/tests/` directory is missing.

**Impact**: **CRITICAL** - RLS policies are not tested at all.

### Finding 2: TypeScript RLS Tests Are Non-Functional âŒ

**File**: `tests/integration/rls-policies.test.ts`
**Status**: `describe.skip` (skipped)
**Reason**: Deprecated in favor of pgTAP

**Attempted Re-Enable**: Failed with errors:

- Error code `42P17`: "undefined_table" - `test_set_jwt` function doesn't exist
- Auth context setup doesn't work without proper PostgreSQL functions
- Tests require complex auth infrastructure that isn't set up

**Error Log**:

```
FAIL  tests/integration/rls-policies.test.ts > should allow admin to see all courses
AssertionError: expected { code: '42P17', details: null, ... } to be null
```

**Result**: TypeScript tests cannot be re-enabled without significant infrastructure work.

### Finding 3: Test Status Breakdown

**Current Test Suite**:

```
Test Files:  11 passed | 1 skipped (12)
Tests:       178 passed | 8 skipped (186)
Duration:    ~120s
```

**Breakdown**:

- âœ… **178 passing tests** - All functional tests work correctly
- â­ï¸ **8 skipped tests** - All from deprecated `rls-policies.test.ts`
- âŒ **0 RLS tests active** - NO test coverage for security policies

---

## ğŸ¯ Critical Issues Identified

### Issue 1: Zero RLS Test Coverage (P0 - Critical)

**Security Impact**: **HIGH**

RLS (Row-Level Security) policies control data access in a multi-tenant system. Without tests:

- âŒ Can't verify users only see their organization's data
- âŒ Can't verify students can't create courses
- âŒ Can't verify instructors can't modify other instructors' courses
- âŒ Can't verify admins have proper access across their organization
- âŒ Can't prevent cross-organization data leaks

**Example RLS Policies with NO Coverage**:

1. Admin can see all organization courses
2. Instructor can only modify own courses
3. Student can only see enrolled courses
4. Users cannot access other organizations' data
5. Students cannot create courses
6. Instructors cannot delete other instructors' courses
7. Cross-organization data isolation
8. Cross-organization enrollment prevention

### Issue 2: Missing pgTAP Infrastructure

**Problem**: `supabase/tests/` directory doesn't exist

**Needed**:

```
supabase/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ 001-rls-policies.test.sql
â”‚   â”‚   â”œâ”€â”€ 002-user-permissions.test.sql
â”‚   â”‚   â””â”€â”€ ...
```

**Impact**: Cannot implement Supabase best practices for RLS testing

### Issue 3: TypeScript Tests Not Viable

**Problem**: Deprecated tests depend on auth infrastructure that doesn't exist

**Missing Dependencies**:

- `test_set_jwt` PostgreSQL function
- JWT claims setup for role/organization
- Auth context helpers that work with RLS policies

**Complexity**: High - requires significant setup work

---

## ğŸ“‹ Recommendations

### Immediate Action (P0 - Critical)

**Option A: Create pgTAP Tests** (RECOMMENDED)

**Pros**:

- âœ… Supabase best practice
- âœ… Simple setup (just SQL files)
- âœ… Transaction isolation (auto-cleanup)
- âœ… Fast execution (no HTTP overhead)
- âœ… Works everywhere (local, CI, production)
- âœ… No auth complexity

**Cons**:

- âš ï¸ Requires learning pgTAP syntax
- âš ï¸ Different from TypeScript tests

**Effort**: ~4-6 hours to create comprehensive RLS test suite

**Steps**:

1. Create `supabase/tests/database/` directory
2. Create `001-rls-policies.test.sql` with pgTAP tests
3. Add `test:rls` script to package.json
4. Run tests: `pnpm test:rls`

**Option B: Fix TypeScript Tests** (NOT RECOMMENDED)

**Pros**:

- âš ï¸ Tests already written (just need to work)

**Cons**:

- âŒ Requires complex auth infrastructure setup
- âŒ Requires `test_set_jwt` PostgreSQL function
- âŒ Harder to maintain
- âŒ Slower execution (HTTP calls)
- âŒ Against Supabase best practices

**Effort**: ~6-8 hours (more complex than pgTAP)

**Verdict**: **Use Option A (pgTAP)**

---

## âœ… Acceptance Criteria Met

### Phase 1: Verification âœ…

- âœ… Checked if pgTAP tests exist â†’ **NO**
- âœ… Attempted to run TypeScript tests â†’ **FAILED**
- âœ… Documented findings â†’ **COMPLETED**
- âœ… Identified critical security gap â†’ **CONFIRMED**

### Phase 2: Cleanup (DEFERRED)

- â¸ï¸ Cannot cleanup until pgTAP tests are created
- â¸ï¸ TypeScript tests kept as reference for pgTAP migration

---

## ğŸ”— Related Files

### Files Analyzed

- `/packages/course-gen-platform/tests/integration/rls-policies.test.ts` (deprecated, non-functional)
- `/packages/course-gen-platform/tests/fixtures/index.ts` (auth context helpers incomplete)
- `/packages/course-gen-platform/supabase/tests/` (MISSING)

### Files to Create (pgTAP Migration)

- `/packages/course-gen-platform/supabase/tests/database/001-rls-policies.test.sql` (NEW)
- `/packages/course-gen-platform/package.json` (add `test:rls` script)

### Documentation to Update

- `/packages/course-gen-platform/README.md` (document RLS testing)
- `/docs/T044.15-FIX-SKIPPED-TESTS.md` (update with findings)

---

## ğŸ“ Next Steps

### Immediate (P0)

1. **Create T044.16: Implement pgTAP RLS Tests** (NEW TASK)
   - Priority: P0 - Critical (security)
   - Estimated: 4-6 hours
   - Blocks: Production deployment

2. **Document Security Risk** (communication)
   - Inform team that RLS policies have zero test coverage
   - Flag as blocker for production deployment
   - Recommend immediate pgTAP implementation

### Medium-Term (P2)

3. **After pgTAP tests exist**: Delete deprecated TypeScript RLS tests
4. **Update documentation**: Document how to run pgTAP tests
5. **Add CI checks**: Ensure pgTAP tests run on every commit

---

## ğŸ“ Lessons Learned

### What We Discovered

1. **Documentation Misalignment**: Code claimed pgTAP tests existed, but they don't
2. **No Verification**: Tests were skipped without verifying replacement existed
3. **Security Gap**: Critical security policies have no test coverage
4. **TypeScript Test Complexity**: Auth setup is complex and error-prone

### Best Practices

1. âœ… **Never skip tests without verifying replacement**
2. âœ… **Always check if referenced files actually exist**
3. âœ… **Security tests should be simple and robust** (pgTAP > TypeScript)
4. âœ… **Document what doesn't exist** (don't claim it does)

---

## ğŸ“Š Impact Assessment

### Current Risk Level: **HIGH** ğŸ”´

**Without RLS test coverage**:

- âŒ Cannot verify data isolation between organizations
- âŒ Cannot verify role-based access control
- âŒ Cannot detect security regressions
- âŒ Cannot safely deploy to production

**With pgTAP tests** (after T044.16):

- âœ… Security policies verified on every commit
- âœ… Data isolation guaranteed
- âœ… Role-based access tested
- âœ… Safe production deployment

---

**Verified By**: Claude Code (Anthropic)
**Verification Date**: 2025-10-12
**Critical Finding**: RLS policies have zero test coverage (security vulnerability)
**Recommendation**: **DO NOT deploy to production until pgTAP RLS tests are implemented**
**Next Task**: T044.16 - Implement pgTAP RLS Tests (P0 - Critical)
