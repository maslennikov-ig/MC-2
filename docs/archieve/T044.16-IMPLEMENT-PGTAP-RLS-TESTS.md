# T044.16: Implement pgTAP RLS Tests (UPDATED AFTER RESEARCH)

**Priority**: P0 - Critical (security vulnerability)
**Status**: ğŸ”´ **READY TO START**
**Created**: 2025-10-12
**Updated**: 2025-10-12 (After comprehensive research)
**Parent Task**: T044 (Testing Infrastructure)
**Blocks**: Production deployment
**Estimated Effort**: 3-4 hours (reduced after finding test helpers)
**Impact**: **Closes critical security gap - RLS policy verification**

---

## ğŸ”¬ Research Summary

**Research Duration**: 45 minutes
**Sources**: Supabase official docs, Context7, GitHub (Basejump Test Helpers)
**Key Finding**: Use **Supabase Test Helpers** to simplify RLS testing

### Key Discoveries

1. âœ… **Supabase CLI already installed** (`supabase@2.48.3` in devDependencies)
2. âœ… **test:rls script exists** in package.json
3. âŒ **Supabase not initialized** (`supabase/config.toml` missing)
4. âœ… **Test Helpers available** from Basejump (simplifies auth setup)
5. âœ… **Official pgTAP docs updated** (within last week)

### Best Practices (from Research)

**Use Supabase Test Helpers** instead of manual JWT setup:

- âŒ **DON'T**: `set_config('request.jwt.claims', ...)`
- âœ… **DO**: `tests.create_supabase_user()` + `tests.authenticate_as()`

**Benefits**:

- No manual JWT string construction
- No auth context complexity
- Cleaner, more readable tests
- Maintained by Supabase community

---

## ğŸ“‹ Implementation Plan (Revised)

### Phase 1: Supabase Initialization (15 minutes)

**Step 1.1**: Initialize Supabase in package directory

```bash
cd packages/course-gen-platform
supabase init
```

**Expected Output**:

```
Finished supabase init.
Created supabase/config.toml
```

**Step 1.2**: Verify initialization

```bash
ls -la supabase/
# Should show:
# config.toml
# migrations/
# seed.sql (optional)
```

**Step 1.3**: Link to existing Supabase project (if needed)

```bash
# If you have a remote Supabase project
supabase link --project-ref <your-project-ref>

# OR use local only
# (No linking needed for local testing)
```

---

### Phase 2: Test Helpers Setup (20 minutes)

**Step 2.1**: Create test directory structure

```bash
mkdir -p supabase/tests
```

**Step 2.2**: Install Supabase Test Helpers

Create `supabase/tests/000-setup-test-helpers.sql`:

```sql
/**
 * Supabase Test Helpers Setup
 *
 * This file installs test helper functions that simplify RLS testing.
 * Source: https://github.com/usebasejump/supabase-test-helpers
 *
 * Must be run FIRST before any other tests (hence 000 prefix).
 */

-- Install pgTAP extension
create extension if not exists pgtap with schema extensions;

-- Create tests schema for helper functions
create schema if not exists tests;

/**
 * Helper: Create Supabase User
 *
 * Creates a test user in auth.users with optional metadata.
 * Returns the user's UUID for use in tests.
 *
 * @param identifier - Unique identifier for the user (e.g., 'test_admin')
 * @param email - Optional email (defaults to identifier@test.com)
 * @param phone - Optional phone number
 * @param metadata - Optional JSONB metadata
 * @returns UUID of created user
 */
create or replace function tests.create_supabase_user(
  identifier text,
  email text default null,
  phone text default null,
  metadata jsonb default null
) returns uuid as $$
declare
  user_id uuid;
  user_email text;
begin
  -- Generate email if not provided
  user_email := coalesce(email, identifier || '@test.com');

  -- Create user in auth.users
  insert into auth.users (
    id,
    email,
    phone,
    email_confirmed_at,
    phone_confirmed_at,
    raw_user_meta_data,
    raw_app_meta_data,
    created_at,
    updated_at,
    aud,
    role
  ) values (
    gen_random_uuid(),
    user_email,
    phone,
    now(),
    case when phone is not null then now() else null end,
    coalesce(metadata, '{}'::jsonb),
    '{"provider":"email","providers":["email"]}'::jsonb,
    now(),
    now(),
    'authenticated',
    'authenticated'
  ) returning id into user_id;

  -- Store identifier mapping for easy lookup
  insert into tests.identifiers (identifier, user_id)
  values (identifier, user_id);

  return user_id;
end;
$$ language plpgsql;

/**
 * Helper: Get Supabase User ID
 *
 * Retrieves user UUID by identifier.
 *
 * @param identifier - User identifier used in create_supabase_user
 * @returns UUID of user
 */
create or replace function tests.get_supabase_uid(identifier text)
returns uuid as $$
  select user_id from tests.identifiers where identifiers.identifier = $1;
$$ language sql;

/**
 * Helper: Authenticate As User
 *
 * Sets auth context to specified user for RLS testing.
 *
 * @param identifier - User identifier
 */
create or replace function tests.authenticate_as(identifier text)
returns void as $$
declare
  user_id uuid;
begin
  user_id := tests.get_supabase_uid(identifier);

  if user_id is null then
    raise exception 'User with identifier % not found', identifier;
  end if;

  -- Set auth context
  perform set_config('request.jwt.claim.sub', user_id::text, true);
  perform set_config('request.jwt.claim.role', 'authenticated', true);
  perform set_config('role', 'authenticated', true);
end;
$$ language plpgsql;

/**
 * Helper: Authenticate As Service Role
 *
 * Sets auth context to service role (bypass RLS).
 */
create or replace function tests.authenticate_as_service_role()
returns void as $$
begin
  perform set_config('request.jwt.claim.sub', null, true);
  perform set_config('request.jwt.claim.role', 'service_role', true);
  perform set_config('role', 'service_role', true);
end;
$$ language plpgsql;

/**
 * Helper: Clear Authentication
 *
 * Resets auth context to anonymous.
 */
create or replace function tests.clear_authentication()
returns void as $$
begin
  perform set_config('request.jwt.claim.sub', null, true);
  perform set_config('request.jwt.claim.role', 'anon', true);
  perform set_config('role', 'anon', true);
end;
$$ language plpgsql;

/**
 * Helper: Check RLS Enabled
 *
 * Verifies that RLS is enabled on specified table.
 *
 * @param schema_name - Schema name (e.g., 'public')
 * @param table_name - Table name (e.g., 'courses')
 * @returns boolean - true if RLS enabled
 */
create or replace function tests.rls_enabled(schema_name text, table_name text)
returns boolean as $$
  select relrowsecurity
  from pg_class
  join pg_namespace on pg_namespace.oid = pg_class.relnamespace
  where pg_namespace.nspname = schema_name
    and pg_class.relname = table_name;
$$ language sql;

/**
 * Helper: Freeze Time
 *
 * Overrides now() for testing time-dependent logic.
 *
 * @param frozen_time - Timestamp to freeze to
 */
create or replace function tests.freeze_time(frozen_time timestamp with time zone)
returns void as $$
begin
  create or replace function public.now()
  returns timestamp with time zone as $inner$
    select frozen_time;
  $inner$ language sql;
end;
$$ language plpgsql;

/**
 * Helper: Unfreeze Time
 *
 * Restores original now() function.
 */
create or replace function tests.unfreeze_time()
returns void as $$
begin
  create or replace function public.now()
  returns timestamp with time zone as $inner$
    select clock_timestamp();
  $inner$ language sql;
end;
$$ language plpgsql;

-- Create identifier mapping table
create table if not exists tests.identifiers (
  identifier text primary key,
  user_id uuid not null unique
);

-- Grant necessary permissions
grant usage on schema tests to postgres, anon, authenticated, service_role;
grant all on all tables in schema tests to postgres, anon, authenticated, service_role;
grant all on all functions in schema tests to postgres, anon, authenticated, service_role;
grant all on all sequences in schema tests to postgres, anon, authenticated, service_role;
```

**Step 2.3**: Create verification test

Create `supabase/tests/001-verify-test-helpers.test.sql`:

```sql
begin;

select plan(3);

-- Test 1: Verify pgTAP is installed
select has_extension('pgtap', 'pgTAP extension should be installed');

-- Test 2: Verify tests schema exists
select has_schema('tests', 'tests schema should exist for helper functions');

-- Test 3: Verify create_supabase_user function exists
select has_function(
  'tests',
  'create_supabase_user',
  ARRAY['text', 'text', 'text', 'jsonb'],
  'tests.create_supabase_user function should exist'
);

select * from finish();
rollback;
```

---

### Phase 3: Implement RLS Tests (1.5-2 hours)

**Step 3.1**: Create main RLS test file

Create `supabase/tests/002-rls-policies.test.sql`:

```sql
/**
 * RLS Policies Test Suite
 *
 * Comprehensive tests for Row Level Security policies across all tables.
 *
 * Test Scenarios:
 * 1. Admin access (all organization data)
 * 2. Instructor access (own courses + read all org courses)
 * 3. Student access (enrolled courses only)
 * 4. Organization data isolation (no cross-org access)
 * 5. Role-based permissions (create/update/delete)
 *
 * Total Tests: 24
 */

begin;

select plan(24);

-- ============================================================================
-- Test Data Setup
-- ============================================================================

-- Create test organizations
insert into public.organizations (id, name, tier, storage_quota_bytes, storage_used_bytes)
values
  ('00000000-0000-0000-0000-111111111111', 'Test Org 1', 'premium', 10737418240, 0),
  ('00000000-0000-0000-0000-222222222222', 'Test Org 2', 'standard', 1073741824, 0);

-- Create test users using helper functions
select tests.create_supabase_user('admin1', 'admin1@test.com');
select tests.create_supabase_user('instructor1', 'instructor1@test.com');
select tests.create_supabase_user('instructor2', 'instructor2@test.com');
select tests.create_supabase_user('student1', 'student1@test.com');
select tests.create_supabase_user('admin2', 'admin2@test.com');
select tests.create_supabase_user('student2', 'student2@test.com');

-- Link users to database
insert into public.users (id, email, role, organization_id)
values
  -- Org 1 users
  (tests.get_supabase_uid('admin1'), 'admin1@test.com', 'admin', '00000000-0000-0000-0000-111111111111'),
  (tests.get_supabase_uid('instructor1'), 'instructor1@test.com', 'instructor', '00000000-0000-0000-0000-111111111111'),
  (tests.get_supabase_uid('instructor2'), 'instructor2@test.com', 'instructor', '00000000-0000-0000-0000-111111111111'),
  (tests.get_supabase_uid('student1'), 'student1@test.com', 'student', '00000000-0000-0000-0000-111111111111'),
  -- Org 2 users
  (tests.get_supabase_uid('admin2'), 'admin2@test.com', 'admin', '00000000-0000-0000-0000-222222222222'),
  (tests.get_supabase_uid('student2'), 'student2@test.com', 'student', '00000000-0000-0000-0000-222222222222');

-- Create test courses
insert into public.courses (id, title, slug, user_id, organization_id, status, settings)
values
  -- Org 1 courses
  ('00000000-0000-0000-0000-333333333331', 'Org1 Course 1', 'org1-course-1', tests.get_supabase_uid('instructor1'), '00000000-0000-0000-0000-111111111111', 'published', '{}'),
  ('00000000-0000-0000-0000-333333333332', 'Org1 Course 2', 'org1-course-2', tests.get_supabase_uid('instructor1'), '00000000-0000-0000-0000-111111111111', 'published', '{}'),
  ('00000000-0000-0000-0000-333333333333', 'Org1 Course 3', 'org1-course-3', tests.get_supabase_uid('instructor2'), '00000000-0000-0000-0000-111111111111', 'draft', '{}'),
  -- Org 2 courses
  ('00000000-0000-0000-0000-444444444441', 'Org2 Course 1', 'org2-course-1', tests.get_supabase_uid('admin2'), '00000000-0000-0000-0000-222222222222', 'published', '{}');

-- Create enrollments
insert into public.course_enrollments (user_id, course_id, status)
values
  -- Student 1 enrolled in 2 courses
  (tests.get_supabase_uid('student1'), '00000000-0000-0000-0000-333333333331', 'active'),
  (tests.get_supabase_uid('student1'), '00000000-0000-0000-0000-333333333332', 'active'),
  -- Student 2 enrolled in 1 course
  (tests.get_supabase_uid('student2'), '00000000-0000-0000-0000-444444444441', 'active');

-- ============================================================================
-- Scenario 1: Admin Access
-- ============================================================================

-- Test 1: Admin sees all courses in their organization
select tests.authenticate_as('admin1');

select results_eq(
  'SELECT COUNT(*)::int FROM courses WHERE organization_id = ''00000000-0000-0000-0000-111111111111''',
  ARRAY[3],
  'Scenario 1.1: Admin sees all 3 courses in their organization'
);

-- Test 2: Admin cannot see other organization courses
select is_empty(
  'SELECT * FROM courses WHERE organization_id = ''00000000-0000-0000-0000-222222222222''',
  'Scenario 1.2: Admin cannot see courses from other organizations'
);

-- Test 3: Admin can see all users in their organization
select results_eq(
  'SELECT COUNT(*)::int FROM users WHERE organization_id = ''00000000-0000-0000-0000-111111111111''',
  ARRAY[4],
  'Scenario 1.3: Admin sees all 4 users in their organization'
);

-- ============================================================================
-- Scenario 2: Instructor Read Access
-- ============================================================================

-- Test 4: Instructor can read all courses in their organization
select tests.authenticate_as('instructor1');

select results_eq(
  'SELECT COUNT(*)::int FROM courses WHERE organization_id = ''00000000-0000-0000-0000-111111111111''',
  ARRAY[3],
  'Scenario 2.1: Instructor sees all 3 courses in their organization'
);

-- Test 5: Instructor cannot see other organization courses
select is_empty(
  'SELECT * FROM courses WHERE organization_id = ''00000000-0000-0000-0000-222222222222''',
  'Scenario 2.2: Instructor cannot see courses from other organizations'
);

-- ============================================================================
-- Scenario 3: Instructor Write Access
-- ============================================================================

-- Test 6: Instructor can update own courses
select tests.authenticate_as('instructor1');

update courses
set title = 'Updated Title'
where id = '00000000-0000-0000-0000-333333333331';

select results_eq(
  'SELECT title FROM courses WHERE id = ''00000000-0000-0000-0000-333333333331''',
  ARRAY['Updated Title'],
  'Scenario 3.1: Instructor can update own courses'
);

-- Test 7: Instructor cannot update other instructor courses
update courses
set title = 'Hacked Title'
where id = '00000000-0000-0000-0000-333333333333';

select results_eq(
  'SELECT title FROM courses WHERE id = ''00000000-0000-0000-0000-333333333333''',
  ARRAY['Org1 Course 3'],
  'Scenario 3.2: Instructor cannot update other instructors courses'
);

-- Test 8: Instructor can delete own courses
delete from courses where id = '00000000-0000-0000-0000-333333333332';

select is_empty(
  'SELECT * FROM courses WHERE id = ''00000000-0000-0000-0000-333333333332''',
  'Scenario 3.3: Instructor can delete own courses'
);

-- Test 9: Instructor cannot delete other instructor courses
delete from courses where id = '00000000-0000-0000-0000-333333333333';

select isnt_empty(
  'SELECT * FROM courses WHERE id = ''00000000-0000-0000-0000-333333333333''',
  'Scenario 3.4: Instructor cannot delete other instructors courses'
);

-- ============================================================================
-- Scenario 4: Student Read Access
-- ============================================================================

-- Test 10: Student sees only enrolled courses
select tests.authenticate_as('student1');

select results_eq(
  'SELECT COUNT(*)::int FROM courses',
  ARRAY[2],
  'Scenario 4.1: Student sees only their 2 enrolled courses'
);

-- Test 11: Student cannot see non-enrolled courses (same org)
select is_empty(
  'SELECT * FROM courses WHERE id = ''00000000-0000-0000-0000-333333333333''',
  'Scenario 4.2: Student cannot see non-enrolled courses in same org'
);

-- Test 12: Student cannot see other organization courses
select tests.authenticate_as('student1');

select is_empty(
  'SELECT * FROM courses WHERE organization_id = ''00000000-0000-0000-0000-222222222222''',
  'Scenario 4.3: Student cannot see courses from other organizations'
);

-- ============================================================================
-- Scenario 5: Student Cannot Create Courses
-- ============================================================================

-- Test 13: Student INSERT is blocked
select tests.authenticate_as('student1');

prepare student_insert_course as
  insert into courses (title, slug, user_id, organization_id, status, settings)
  values ('Unauthorized Course', 'unauthorized', tests.get_supabase_uid('student1'), '00000000-0000-0000-0000-111111111111', 'draft', '{}');

select throws_ok(
  'student_insert_course',
  '42501', -- insufficient_privilege
  null,
  'Scenario 5.1: Student cannot create courses (insufficient privilege)'
);

-- Test 14: Student cannot impersonate instructor
prepare student_impersonate as
  insert into courses (title, slug, user_id, organization_id, status, settings)
  values ('Impersonation Attempt', 'impersonate', tests.get_supabase_uid('instructor1'), '00000000-0000-0000-0000-111111111111', 'draft', '{}');

select throws_ok(
  'student_impersonate',
  '42501',
  null,
  'Scenario 5.2: Student cannot create courses with instructor user_id'
);

-- ============================================================================
-- Scenario 6: Student Cannot Modify Courses
-- ============================================================================

-- Test 15: Student UPDATE affects 0 rows
select tests.authenticate_as('student1');

update courses
set title = 'Hacked Title'
where id = '00000000-0000-0000-0000-333333333331';

-- Course should remain unchanged (student is enrolled but cannot modify)
select results_eq(
  'SELECT title FROM courses WHERE id = ''00000000-0000-0000-0000-333333333331''',
  ARRAY['Updated Title'], -- From instructor update in Scenario 3
  'Scenario 6.1: Student cannot modify enrolled courses'
);

-- Test 16: Student DELETE affects 0 rows
delete from courses where id = '00000000-0000-0000-0000-333333333331';

select isnt_empty(
  'SELECT * FROM courses WHERE id = ''00000000-0000-0000-0000-333333333331''',
  'Scenario 6.2: Student cannot delete courses'
);

-- ============================================================================
-- Scenario 7: Organization Data Isolation
-- ============================================================================

-- Test 17: Org 1 admin cannot access Org 2 courses
select tests.authenticate_as('admin1');

select is_empty(
  'SELECT * FROM courses WHERE id = ''00000000-0000-0000-0000-444444444441''',
  'Scenario 7.1: Org 1 admin cannot access Org 2 courses by ID'
);

-- Test 18: Org 1 instructor cannot access Org 2 courses
select tests.authenticate_as('instructor1');

select is_empty(
  'SELECT * FROM courses WHERE organization_id = ''00000000-0000-0000-0000-222222222222''',
  'Scenario 7.2: Org 1 instructor cannot access Org 2 courses'
);

-- Test 19: Org 1 student cannot access Org 2 courses
select tests.authenticate_as('student1');

select is_empty(
  'SELECT * FROM courses WHERE organization_id = ''00000000-0000-0000-0000-222222222222''',
  'Scenario 7.3: Org 1 student cannot access Org 2 courses'
);

-- Test 20: Org 2 admin only sees Org 2 data
select tests.authenticate_as('admin2');

select results_eq(
  'SELECT DISTINCT organization_id::text FROM courses',
  ARRAY['00000000-0000-0000-0000-222222222222'],
  'Scenario 7.4: Org 2 admin only sees Org 2 courses'
);

-- ============================================================================
-- Scenario 8: Cross-Organization Enrollment Prevention
-- ============================================================================

-- Test 21: Student from Org 2 cannot see Org 1 courses
select tests.authenticate_as('student2');

select is_empty(
  'SELECT * FROM courses WHERE id = ''00000000-0000-0000-0000-333333333331''',
  'Scenario 8.1: Org 2 student cannot see Org 1 courses'
);

-- Test 22: Student from Org 2 cannot enroll in Org 1 courses
prepare cross_org_enrollment as
  insert into course_enrollments (user_id, course_id, status)
  values (tests.get_supabase_uid('student2'), '00000000-0000-0000-0000-333333333331', 'active');

select throws_ok(
  'cross_org_enrollment',
  '42501',
  null,
  'Scenario 8.2: Org 2 student cannot enroll in Org 1 courses'
);

-- Test 23: Instructor from Org 1 cannot modify Org 2 courses
select tests.authenticate_as('instructor1');

update courses
set title = 'Cross-org Hack'
where id = '00000000-0000-0000-0000-444444444441';

select results_eq(
  'SELECT title FROM courses WHERE id = ''00000000-0000-0000-0000-444444444441''',
  ARRAY['Org2 Course 1'],
  'Scenario 8.3: Org 1 instructor cannot modify Org 2 courses'
);

-- Test 24: Admin from Org 1 cannot delete Org 2 data
select tests.authenticate_as('admin1');

delete from courses where id = '00000000-0000-0000-0000-444444444441';

select isnt_empty(
  'SELECT * FROM courses WHERE id = ''00000000-0000-0000-0000-444444444441''',
  'Scenario 8.4: Org 1 admin cannot delete Org 2 courses'
);

-- ============================================================================
-- Cleanup and Finish
-- ============================================================================

select * from finish();
rollback; -- Automatic cleanup - no manual teardown needed!
```

---

### Phase 4: Run and Verify (30 minutes)

**Step 4.1**: Run all tests

```bash
cd packages/course-gen-platform
pnpm test:rls
```

**Expected Output**:

```
1..27
ok 1 - pgTAP extension should be installed
ok 2 - tests schema should exist for helper functions
ok 3 - tests.create_supabase_user function should exist
ok 4 - Scenario 1.1: Admin sees all 3 courses in their organization
ok 5 - Scenario 1.2: Admin cannot see courses from other organizations
ok 6 - Scenario 1.3: Admin sees all 4 users in their organization
...
ok 27 - Scenario 8.4: Org 1 admin cannot delete Org 2 courses
```

**Step 4.2**: Debug failing tests (if any)

Common issues:

- RLS policies not enabled â†’ Check `alter table X enable row level security;`
- Auth context not set â†’ Verify test helpers are installed
- Data not created â†’ Check insert statements for constraint violations

**Debugging Commands**:

```sql
-- Check if RLS is enabled
select tests.rls_enabled('public', 'courses');

-- Check current auth context
select current_setting('request.jwt.claim.sub', true);
select current_setting('role', true);

-- Check test data exists
select count(*) from public.organizations;
select count(*) from auth.users;
```

---

### Phase 5: Documentation (20 minutes)

**Step 5.1**: Update README

Add to `packages/course-gen-platform/README.md`:

```markdown
## Testing

### TypeScript Tests (Unit & Integration)

\`\`\`bash
pnpm test # Run all TypeScript tests
pnpm test:watch # Watch mode
\`\`\`

### RLS Policy Tests (pgTAP)

\`\`\`bash
pnpm test:rls # Run RLS policy tests
\`\`\`

**Test Coverage**:

- âœ… Multi-tenant data isolation
- âœ… Role-based access control (admin/instructor/student)
- âœ… Cross-organization data protection
- âœ… CRUD permissions per role
- âœ… Enrollment access controls

**Test Files**:

- `supabase/tests/000-setup-test-helpers.sql` - Test helper functions
- `supabase/tests/001-verify-test-helpers.test.sql` - Verify helpers work
- `supabase/tests/002-rls-policies.test.sql` - Main RLS test suite (24 tests)

### Run All Tests

\`\`\`bash
pnpm test:all # Run both TypeScript and pgTAP tests
\`\`\`
```

**Step 5.2**: Document test helpers

Create `supabase/tests/README.md`:

```markdown
# Supabase Test Suite

## Overview

This directory contains pgTAP tests for database Row Level Security (RLS) policies.

## Test Files

| File                               | Description           | Tests      |
| ---------------------------------- | --------------------- | ---------- |
| `000-setup-test-helpers.sql`       | Test helper functions | Setup only |
| `001-verify-test-helpers.test.sql` | Verify helpers work   | 3 tests    |
| `002-rls-policies.test.sql`        | Main RLS test suite   | 24 tests   |

## Running Tests

\`\`\`bash

# From package directory

pnpm test:rls

# Or directly with Supabase CLI

supabase test db --workdir packages/course-gen-platform
\`\`\`

## Test Helpers

### User Management

\`\`\`sql
-- Create test user
select tests.create_supabase_user('admin1', 'admin1@test.com');

-- Get user ID
select tests.get_supabase_uid('admin1');
\`\`\`

### Authentication

\`\`\`sql
-- Authenticate as user
select tests.authenticate_as('admin1');

-- Authenticate as service role (bypass RLS)
select tests.authenticate_as_service_role();

-- Clear authentication
select tests.clear_authentication();
\`\`\`

### RLS Verification

\`\`\`sql
-- Check if RLS enabled
select tests.rls_enabled('public', 'courses');
\`\`\`

## Adding New Tests

1. Create new file: `NNN-test-name.test.sql`
2. Start with `begin;`
3. Declare plan: `select plan(N);`
4. Write tests using pgTAP functions
5. End with `select * from finish();`
6. Rollback: `rollback;`

Example:
\`\`\`sql
begin;
select plan(2);

-- Test 1
select tests.authenticate_as('admin1');
select ok(
(select count(\*) from courses) > 0,
'Admin can see courses'
);

-- Test 2
select tests.clear_authentication();
select is_empty(
'select \* from courses',
'Anonymous cannot see courses'
);

select \* from finish();
rollback;
\`\`\`

## Resources

- [pgTAP Documentation](https://pgtap.org/)
- [Supabase Testing Guide](https://supabase.com/docs/guides/local-development/testing/overview)
- [Test Helpers Source](https://github.com/usebasejump/supabase-test-helpers)
```

---

## âœ… Acceptance Criteria (Revised)

### Must Have (P0) âœ…

- [ ] Supabase initialized (`supabase/config.toml` exists)
- [ ] Test directory created (`supabase/tests/`)
- [ ] Test helpers installed (`000-setup-test-helpers.sql`)
- [ ] Helper verification test passes (`001-verify-test-helpers.test.sql`)
- [ ] Main RLS test suite implemented (`002-rls-policies.test.sql`)
- [ ] All 24 test scenarios pass (100% success rate)
- [ ] Tests use helper functions (not manual `set_config`)
- [ ] `pnpm test:rls` command works
- [ ] Auto-cleanup works (ROLLBACK)

### Should Have (P1)

- [ ] README updated with RLS testing instructions
- [ ] Test helpers documented (`supabase/tests/README.md`)
- [ ] Each test has descriptive comments
- [ ] Deprecated TypeScript tests removed

### Nice to Have (P2)

- [ ] CI/CD integration
- [ ] Additional edge case tests
- [ ] Performance benchmarks

---

## ğŸ” Key Differences from Original Plan

### What Changed After Research

1. **Use Test Helpers** âœ…
   - Original: Manual JWT claims via `set_config`
   - Updated: `tests.create_supabase_user()` + `tests.authenticate_as()`

2. **Simplified Setup** âœ…
   - Original: Complex JWT string construction
   - Updated: Helper functions handle auth context

3. **Better Test Structure** âœ…
   - Original: One large file
   - Updated: Separate setup file + verification + main tests

4. **Reduced Effort** âœ…
   - Original: 4-6 hours
   - Updated: 3-4 hours (thanks to helpers)

5. **Official Patterns** âœ…
   - Original: Custom approach
   - Updated: Follows Supabase/Basejump conventions

---

## ğŸ“š Resources Used in Research

### Official Documentation

- [Supabase Testing Overview](https://supabase.com/docs/guides/local-development/testing/overview)
- [Advanced pgTAP Testing](https://supabase.com/docs/guides/local-development/testing/pgtap-extended)
- [pgTAP Extension Docs](https://supabase.com/docs/guides/database/extensions/pgtap)

### Community Tools

- [Supabase Test Helpers (GitHub)](https://github.com/usebasejump/supabase-test-helpers)
- [Basejump Testing Guide](https://usebasejump.com/blog/testing-on-supabase-with-pgtap)

### Examples

- [Blair Jordan's Medium Article](https://blair-devmode.medium.com/testing-row-level-security-rls-policies-in-postgresql-with-pgtap-a-supabase-example-b435c1852602)
- [GitHub Gist](https://gist.github.com/mansueli/ede3563e5dec3e3d4beb88dcaaf66879)

---

## ğŸ¯ Success Metrics

### Before This Task

```
RLS Test Coverage:     0% âŒ
Test Infrastructure:   Manual JWT setup (complex)
Production Readiness:  BLOCKED ğŸ”´
Security Risk:         HIGH ğŸ”´
```

### After This Task (Target)

```
RLS Test Coverage:     100% âœ…
Test Infrastructure:   Test Helpers (simple)
Production Readiness:  UNBLOCKED âœ…
Security Risk:         LOW âœ…
pgTAP Tests:          24+ scenarios passing
Test Execution:       < 5 seconds
```

---

**Created By**: Claude Code (Anthropic)
**Research Date**: 2025-10-12
**Updated After**: Comprehensive research (Supabase docs, Context7, GitHub)
**Priority**: P0 - Critical (security vulnerability)
**Estimated Effort**: 3-4 hours (reduced from 4-6 hours)
**Complexity**: Low-Medium (thanks to test helpers)
**Impact**: **Critical - Closes security gap and enables safe production deployment**
