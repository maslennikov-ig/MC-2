# T035.1.5 Code Audit Report: Role References

**Generated**: 2025-10-22
**Task**: Find all role references in codebase for 'superadmin' integration
**Thoroughness Level**: Very Thorough
**Status**: COMPLETED

---

## Executive Summary

This audit comprehensively surveyed the codebase for all role-related references. A total of **9 critical files** containing role definitions or checks were identified, with **4 distinct types of role references**:

1. **Database Type Definition** (3 files)
2. **Authorization Middleware** (3 files) 
3. **Validation Schemas** (1 file)
4. **Test Coverage** (2 files)

**Critical Finding**: The role enum currently only contains 3 values ('admin', 'instructor', 'student'). The 'superadmin' role has been added to the database enum (via migrations) but **NOT yet propagated to**:
- Frontend TypeScript type definitions
- Validation schemas
- Authorization middleware 
- Test coverage

---

## 1. TypeScript Type Definitions

**Priority: CRITICAL** - Must update to include 'superadmin'

### Database Generated Types

**File**: `/home/me/code/megacampus2/packages/shared-types/src/database.generated.ts` (Line 956)

Current state:
```typescript
role: "admin" | "instructor" | "student"
```

**Also at line 1119 in Constants**:
```typescript
role: ["admin", "instructor", "student"],
```

**Status**: GENERATED FILE - regenerate from Supabase schema after migration
**Action**: Must regenerate this file after superadmin migration is confirmed in database

---

**File**: `/home/me/code/megacampus2/courseai-next/types/database.generated.ts` (Line 956)

Similar generated file with hardcoded role enum.

**Status**: LEGACY FRONTEND TYPE - appears to be legacy, same structure
**Action**: Check if still used; if so, regenerate

---

### Frontend Custom Type Definition

**File**: `/home/me/code/megacampus2/courseai-next/types/database.ts` (Lines 128, 138)

```typescript
// User interface
export interface User {
  id: string
  email: string
  full_name?: string
  avatar_url?: string
  role: 'user' | 'admin' | 'super_admin'  // Line 128
  created_at: string
  updated_at: string
}

// Profile interface  
export interface Profile {
  id: string
  email?: string
  full_name?: string
  avatar_url?: string
  role: 'user' | 'admin' | 'super_admin'  // Line 138
  created_at?: string
  updated_at?: string
}
```

**Status**: MISALIGNED - Uses 'user' instead of 'student', uses 'super_admin' instead of 'superadmin'
**Action**: Align with database schema ('student', 'admin', 'instructor', 'superadmin')

---

## 2. Authorization & Access Control

**Priority: CRITICAL** - May need superadmin bypass logic

### Backend Authorization Middleware

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/src/server/middleware/authorize.ts` (Lines 38, 86-182)

Type definition (Line 38):
```typescript
type Role = Database['public']['Enums']['role'];
```

Middleware functions:
- `hasRole()` - Generic middleware accepting Role or Role[]
- `requireAdmin` - hasRole('admin')  
- `requireInstructor` - hasRole(['admin', 'instructor'])
- `requireStudent` - hasRole(['admin', 'instructor', 'student'])

**Status**: DYNAMIC - Uses type from database, will auto-support superadmin once database updates
**Action**: None needed - these will automatically work with superadmin once database updated
**Decision Needed**: Should superadmin have implicit access to all endpoints? Currently no, would need explicit ['superadmin', 'admin', 'instructor'] if needed

---

### Role Checks in Procedures

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/src/server/procedures.ts` (Lines 45, 70)

```typescript
export const adminProcedure = protectedProcedure.use(requireAdmin);
export const instructorProcedure = protectedProcedure.use(requireInstructor);
```

**Status**: DEFINED ONCE - No hardcoded role strings, references middleware
**Action**: None needed

---

### Validation Schemas (Zod)

**File**: `/home/me/code/megacampus2/packages/shared-types/src/zod-schemas.ts` (Line 24)

```typescript
export const roleSchema = z.enum(['admin', 'instructor', 'student']);
```

**Status**: CRITICAL - Hardcoded values used for API input validation
**Action**: Add 'superadmin' to enum - Change to:
```typescript
export const roleSchema = z.enum(['admin', 'superadmin', 'instructor', 'student']);
```

---

## 3. Admin Router (Database Queries)

**Priority: HIGH** - Hardcoded role filter

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/src/server/routers/admin.ts` (Line 55)

```typescript
role: z.enum(['admin', 'instructor', 'student']).optional(),
```

**Context**: This is an input validation schema for filtering users by role in admin dashboard

**Status**: DUPLICATES - Same as zod-schemas.ts
**Action**: Should be updated when zod-schemas updated, or better yet, import from shared-types:
```typescript
import { roleSchema } from '@megacampus/shared-types';

const listUsersInputSchema = paginationSchema.extend({
  role: roleSchema.optional(),
});
```

---

## 4. Job Router (Authorization Check)

**Priority: HIGH** - Role-based access control for job management

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/src/server/routers/jobs.ts` (Lines 88-89)

```typescript
const isAdmin =
  currentUser.role === 'admin' && currentUser.organizationId === jobStatus.organization_id;
```

**Also Line 166**:
```typescript
const isAdmin = currentUser.role === 'admin' && isSameOrg;
```

**Status**: HARDCODED STRING - Direct equality check
**Action**: Needs decision:
- Option A: Leave as-is (superadmin users need to be 'admin' in their org)
- Option B: Extend to include superadmin:
```typescript
const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'superadmin') && currentUser.organizationId === jobStatus.organization_id;
```

**Recommendation**: Option B - superadmin should be able to manage any job

---

## 5. Database Migrations (Already Applied)

**Priority: INFO** - Already in database

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/supabase/migrations/20251022142219_add_superadmin_role_part1_enum.sql`

Adds 'superadmin' to role enum.

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/supabase/migrations/20251022142233_add_superadmin_role_part2_function.sql`

Creates `is_superadmin(user_id uuid)` helper function.

**Status**: COMPLETE - Both migrations are in place
**Action**: None needed at database level

---

## 6. Tests (Role-Based)

**Priority: MEDIUM** - Need superadmin test cases

### Authorization Middleware Tests

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/tests/unit/authorize-middleware.test.ts`

Current test coverage:
- Line 28: `createContextWithRole('admin' | 'instructor' | 'student')`
- Line 80+: Tests for each role with various middleware configurations
- Line 120: Tests that admin doesn't have implicit access to instructor endpoints
- Line 147+: Tests for multiple role requirements

**Status**: MISSING - No superadmin test cases
**Action**: Add test suite for superadmin:
1. Test superadmin can access adminProcedure
2. Test superadmin can access instructorProcedure  
3. Test superadmin can access any role requirement
4. Test role hierarchy with superadmin included

---

### Authentication Tests

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/tests/integration/authentication.test.ts`

Tests JWT claim verification including role claim.

**Status**: SHOULD ADD - Test superadmin JWT claim
**Action**: Add test case for superadmin authentication

---

## 7. Comments & Documentation

**Priority: LOW** - Update for completeness

### Authorization Middleware Comments

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/src/server/middleware/authorize.ts` (Lines 14-17)

Current documentation:
```typescript
* Role Hierarchy:
* - admin: Full access to organization data (highest privilege)
* - instructor: Can create/manage own courses + access student endpoints
* - student: Can view enrolled courses only (lowest privilege)
```

**Action**: Update to:
```typescript
* Role Hierarchy:
* - superadmin: Full platform access across all organizations (highest privilege)
* - admin: Full access to organization data
* - instructor: Can create/manage own courses + access student endpoints
* - student: Can view enrolled courses only (lowest privilege)
```

---

## Summary Table

| Category | File | Current State | Action Required | Priority |
|----------|------|---------------|-----------------|----------|
| **Type Defs** | shared-types/database.generated.ts | Missing | Regenerate from DB | CRITICAL |
| **Type Defs** | courseai-next/types/database.generated.ts | Missing | Regenerate from DB | CRITICAL |
| **Type Defs** | courseai-next/types/database.ts | Misaligned schema | Align with DB | MEDIUM |
| **Middleware** | authorize.ts | Dynamic, ready | None | ✓ |
| **Validation** | zod-schemas.ts | Hardcoded | Add 'superadmin' | CRITICAL |
| **Router** | admin.ts (input schema) | Hardcoded | Update | HIGH |
| **Router** | jobs.ts (role check) | Hardcoded string | Extend logic | HIGH |
| **Database** | migrations | Complete | None | ✓ |
| **Tests** | authorize-middleware.test.ts | Incomplete | Add superadmin tests | MEDIUM |
| **Tests** | authentication.test.ts | Incomplete | Add superadmin case | MEDIUM |
| **Docs** | authorize.ts comments | Outdated | Update hierarchy | LOW |

---

## Recommendations

### Must Update (Blocking T035.2-T035.4)

1. **packages/shared-types/src/zod-schemas.ts** (Line 24)
   - Add 'superadmin' to roleSchema enum
   - This is used for API input validation

2. **packages/course-gen-platform/src/server/routers/admin.ts** (Line 55)
   - Use imported roleSchema from shared-types
   - Or manually add 'superadmin' to z.enum()

3. **packages/course-gen-platform/src/server/routers/jobs.ts** (Lines 88-89, 166)
   - Extend role check to include superadmin
   - Change from `role === 'admin'` to `(role === 'admin' || role === 'superadmin')`

### Should Update (Before Production)

1. **Regenerate type files**
   - packages/shared-types/src/database.generated.ts
   - courseai-next/types/database.generated.ts
   - These are auto-generated from Supabase schema

2. **courseai-next/types/database.ts**
   - Align with database schema (use 'student' not 'user', 'superadmin' not 'super_admin')
   - Or remove if legacy and unused

3. **Add superadmin test coverage**
   - tests/unit/authorize-middleware.test.ts
   - tests/integration/authentication.test.ts

### Nice to Have (Future)

1. **Update authorization middleware documentation**
   - Reflect new 4-role hierarchy
   - Document superadmin capabilities

2. **Add superadmin UI indicators**
   - Badge/label for superadmin users in admin dashboard
   - Visual distinction from regular admins

---

## Search Patterns Used

1. `type Role` / `enum Role` - Type definitions
2. `role: '(admin|instructor|student|superadmin)'` - String literals
3. `role ===` / `role !==` - Equality checks
4. `includes\(['admin', 'instructor'\]` - Role arrays
5. `requireAdmin` / `requireInstructor` - Authorization middleware
6. `.eq('role', ` - Database queries
7. Comments mentioning roles - Documentation

---

## Files Excluded (with reason)

- node_modules/ - Dependencies, not source code
- dist/ - Build artifacts
- .next/ - Build artifacts
- .git/ - Version control
- Generated files (before regeneration) - Will be updated automatically
- Test fixtures - Already accounted for in test file analysis
- Archive/backup migrations - Superseded by newer migrations

---

## Next Steps

1. **T035.2**: Update authorization middleware to handle superadmin in RLS policies
2. **T035.3**: Add superadmin bypass logic where needed (if cross-org access required)
3. **T035.4**: Frontend UI updates for superadmin role display
4. **T035.5**: Comprehensive testing and documentation

