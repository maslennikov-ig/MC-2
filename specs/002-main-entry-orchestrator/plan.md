# Implementation Plan: Stage 1 - Main Entry Orchestrator

**Branch**: `002-main-entry-orchestrator` | **Date**: 2025-10-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-main-entry-orchestrator/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Replace the n8n Main Entry workflow with a backend code-based orchestrator that:
1. **API Architecture**: tRPC-first approach with `generation.initiate` endpoint (T011-T019 logic consolidated)
2. **Multi-Client Support**: TypeScript clients use tRPC, PHP/Ruby/Python LMS systems call via standard HTTP POST
3. **Frontend Compatibility**: Next.js route (`/api/coursegen/generate`) is thin proxy to tRPC
4. Enforces per-user tier-based concurrency limits (FREE=1, PREMIUM=5)
5. Queues appropriate BullMQ jobs (DOCUMENT_PROCESSING or STRUCTURE_ANALYSIS) with priority based on user tier
6. Updates course progress via idempotent RPC function with retry/compensation pattern (Saga pattern)
7. Logs all operations using Pino structured JSON logger
8. Tracks critical events in `system_metrics` table for Stage 8 monitoring

**Technical Approach**:
- **tRPC Router**: All business logic in `packages/course-gen-platform/src/server/routers/generation.ts` (T011-T019)
- **Next.js Proxy**: Thin compatibility layer (<20 lines) at `courseai-next/app/api/coursegen/generate/route.ts`
- **Fire-and-forget**: < 500ms response validates requests, checks concurrency, queues jobs, updates progress
- **Saga Pattern**: Exponential backoff retries (3x) with job rollback on RPC failure
- **Worker Fallback**: Orphaned job recovery checks step 1 status on job start

**Architecture Decision (T033)**: Single source of truth in tRPC router eliminates code duplication (Next.js route reduced from 375 lines to 57 lines). LMS systems call tRPC directly via HTTP POST. Optional REST wrapper can be added later if partners request RESTful endpoints.

---

## Technical Context

**Language/Version**: TypeScript 5.9.3, Node.js 20+
**Primary Dependencies**:
- **Pino 9.6.0** (structured JSON logging, NEW)
- BullMQ 5.1.0 (job queue, existing)
- Supabase JS 2.39.0 (database/auth, existing)
- tRPC 11.0.0-rc.364 (type-safe APIs, existing)
- Redis (ioredis 5.3.2, existing)
- Zod 3.22.4 (validation, existing)

**Storage**: PostgreSQL (Supabase managed) with new `system_metrics` table and `update_course_progress` RPC function

**Testing**:
- Unit tests: Vitest (existing)
- Integration tests: Vitest with Supabase local
- Contract tests: JSON schema validation
- E2E tests: Manual testing against BullBoard dashboard

**Target Platform**: Linux server (Docker containers), Node.js runtime

**Project Type**: Web application (Next.js frontend + tRPC backend monorepo)

**Performance Goals**:
- Endpoint latency P95 < 500ms
- RPC execution < 100ms
- Concurrency check < 1ms (Redis)
- Total orchestration overhead < 300ms

**Constraints**:
- Frontend compatibility required (no breaking changes to `generation_progress` JSONB structure)
- Russian language step names (n8n parity)
- Migration-first deployment (RPC before backend code)
- Hardcoded limits in Stage 1 (dynamic tuning deferred to Stage 8)

**Scale/Scope**:
- FREE tier: 1 concurrent job, priority 1
- BASIC tier: 2 concurrent jobs, priority 3
- STANDARD tier: 3 concurrent jobs, priority 5
- TRIAL tier: 5 concurrent jobs, priority 5
- PREMIUM tier: 5 concurrent jobs, priority 10
- Global limit: 3 concurrent jobs (Stage 1), 3-10 dynamic (Stage 8)

---

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

### âœ… I. Reliability First

**Compliance**: Fully compliant

- âœ… Saga pattern implemented for RPC failures (retry 3x with exponential backoff, rollback job on failure)
- âœ… Worker fallback recovery for orphaned jobs (step 1 completion check)
- âœ… Idempotent RPC design allows safe retries
- âœ… Progress persisted at each stage (JSONB updates atomic)
- âœ… System metrics table tracks all failures (job_rollback, orphaned_job_recovery)

### âœ… II. Atomicity & Modularity

**Compliance**: Fully compliant

- âœ… Concurrency tracker: 150 lines (single responsibility)
- âœ… Retry utility: 30 lines (pure function)
- âœ… API endpoint: ~200 lines (orchestration logic only)
- âœ… Worker recovery: ~50 lines (separate concern)
- âœ… Pino logger: Drop-in replacement (30 lines)

**Modules**:
- `src/shared/concurrency/tracker.ts` - Concurrency tracking
- `src/shared/utils/retry.ts` - Retry logic
- `app/api/coursegen/generate/route.ts` - API endpoint
- `src/orchestrator/handlers/base-handler.ts` - Worker recovery
- `src/shared/logger/index.ts` - Structured logging

### âœ… III. Spec-Driven Development

**Compliance**: Fully compliant

- âœ… Feature spec: `spec.md` (complete)
- âœ… Implementation plan: `plan.md` (this file)
- âœ… Research findings: `research.md` (all unknowns resolved)
- âœ… Data model: `data-model.md` (entities, schema, migrations)
- âœ… API contracts: `contracts/api-endpoint.md`, `contracts/rpc-update-course-progress.md`
- âœ… Quickstart: `quickstart.md` (local dev setup)
- â³ Tasks: `tasks.md` (generated via `/speckit.tasks`)

### âœ… IV. Incremental Testing

**Compliance**: Fully compliant

- âœ… Unit tests planned for concurrency tracker, retry util, API validation
- âœ… Integration tests planned for full orchestration flow (endpoint â†’ job â†’ progress update)
- âœ… Contract tests planned for JSON schema validation (200, 401, 403, 404, 429, 500 responses)
- âœ… RPC function tests planned using pgTAP (SQL unit tests)
- âœ… Manual E2E testing via BullBoard dashboard

### âœ… V. Observability & Monitoring

**Compliance**: Fully compliant

- âœ… Pino structured JSON logging (level, timestamp, context)
- âœ… Child loggers with context propagation (requestId, userId, tier, courseId, jobId)
- âœ… System metrics table for critical events (job_rollback, orphaned_job_recovery, concurrency_limit_hit)
- âœ… Log levels: debug (dev only), info, warn, error
- âœ… Correlation IDs via nanoid() for request tracing

### âœ… VI. Multi-Tenancy & Scalability

**Compliance**: Fully compliant

- âœ… JWT authentication validates user identity
- âœ… Course ownership verified (RLS + application layer)
- âœ… Per-user concurrency limits enforced (tier-based)
- âœ… Queue priorities based on subscription tier
- âœ… Redis counters enable horizontal scaling
- âœ… BullMQ supports distributed workers

### âš ï¸ VII. AI Model Flexibility

**Compliance**: Not applicable (Stage 1 has no AI model calls)

- â„¹ï¸ Stage 1 is pure orchestration (no prompts, no AI calls)
- â„¹ï¸ AI model usage begins in Stage 2+ (document processing, summarization)
- âœ… Architecture supports future flexibility (workers call AI modules)

---

## Project Structure

### Documentation (this feature)

```
specs/002-main-entry-orchestrator/
â”œâ”€â”€ plan.md                  # âœ… This file (/speckit.plan output)
â”œâ”€â”€ research.md              # âœ… Phase 0 output (research findings)
â”œâ”€â”€ data-model.md            # âœ… Phase 1 output (entities, schema)
â”œâ”€â”€ quickstart.md            # âœ… Phase 1 output (local dev guide)
â”œâ”€â”€ contracts/               # âœ… Phase 1 output
â”‚   â”œâ”€â”€ api-endpoint.md      #    POST /api/coursegen/generate contract
â”‚   â””â”€â”€ rpc-update-course-progress.md  # RPC function contract
â””â”€â”€ tasks.md                 # â³ Phase 2 output (/speckit.tasks - NOT created yet)
```

### Source Code (repository root)

```
# Web application structure (Next.js frontend + tRPC backend)

courseai-next/                           # Next.js frontend
â”œâ”€â”€ app/api/coursegen/generate/
â”‚   â””â”€â”€ route.ts                         # ðŸ†• NEW: API endpoint
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ supabase/
â”‚       â””â”€â”€ server.ts                    # Existing: Auth helpers
â””â”€â”€ supabase/migrations/
    â”œâ”€â”€ {timestamp}_create_system_metrics.sql        # ðŸ†• NEW: system_metrics table
    â””â”€â”€ {timestamp}_create_update_course_progress_rpc.sql  # ðŸ†• NEW: RPC function

packages/course-gen-platform/            # Backend tRPC server
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ orchestrator/
â”‚   â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â”‚   â”œâ”€â”€ base-handler.ts          # âœï¸ MODIFIED: Add step 1 recovery
â”‚   â”‚   â”‚   â””â”€â”€ document-processing.ts   # âœï¸ MODIFIED: Add orphan detection
â”‚   â”‚   â”œâ”€â”€ queue.ts                     # Existing: BullMQ queue
â”‚   â”‚   â””â”€â”€ worker.ts                    # Existing: Job processor
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”œâ”€â”€ concurrency/
â”‚   â”‚   â”‚   â””â”€â”€ tracker.ts               # ðŸ†• NEW: Concurrency enforcement
â”‚   â”‚   â”œâ”€â”€ logger/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                 # âœï¸ MODIFIED: Replace with Pino
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â””â”€â”€ retry.ts                 # ðŸ†• NEW: Retry with backoff
â”‚   â”‚   â””â”€â”€ types/
â”‚   â”‚       â”œâ”€â”€ system-metrics.ts        # ðŸ†• NEW: Metrics types
â”‚   â”‚       â””â”€â”€ concurrency.ts           # ðŸ†• NEW: Concurrency types
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ index.ts                     # Existing: tRPC server

packages/shared-types/                   # Shared TypeScript types
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ bullmq-jobs.ts                   # Existing: Job types (no changes)
â”‚   â””â”€â”€ index.ts                         # Existing: Exports

tests/                                   # Integration tests
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ orchestrator/
â”‚   â”‚   â””â”€â”€ generate-endpoint.test.ts    # ðŸ†• NEW: E2E orchestration tests
â”‚   â””â”€â”€ fixtures/
â”‚       â””â”€â”€ test-courses.ts              # ðŸ†• NEW: Test data
â””â”€â”€ unit/
    â”œâ”€â”€ concurrency-tracker.test.ts      # ðŸ†• NEW: Concurrency tests
    â””â”€â”€ retry-util.test.ts               # ðŸ†• NEW: Retry logic tests
```

**Structure Decision**: Web application (Option 2) selected because project has distinct Next.js frontend (courseai-next) and Express/tRPC backend (packages/course-gen-platform). Frontend handles UI and pages, backend handles API logic, job orchestration, and workers. This separation enables independent scaling and deployment.

**New Files**: 8 new files
**Modified Files**: 2 existing files
**Database Migrations**: 2 new migrations

---

## Orchestration Strategy

_Added by Phase 0 of /speckit.plan - Used by /speckit.tasks to generate Phase 0 delegation plan_

### Available Subagents

Subagents available in `.claude/agents/`:

- âœ… **database-architect** - Database migrations, RPC functions, schema design, PostgreSQL expertise
- âœ… **api-builder** - tRPC/REST endpoints, Next.js App Router, authentication, API validation
- âœ… **infrastructure-specialist** - Redis, BullMQ, worker config, queue management, concurrency
- âœ… **fullstack-nextjs-specialist** - Complex Next.js frontend + backend integration, React patterns
- âœ… **integration-tester** - E2E workflow testing, contract validation, acceptance tests
- âœ… **code-reviewer** - Quality validation, constitution compliance checks, best practices

### Executor Assignment Rules

**Phase 0 of /speckit.tasks will use these rules to annotate tasks with MANDATORY executor directives:**

| Task Domain | Complexity | Executor | Rationale |
|-------------|------------|----------|-----------|
| Database migrations | All | database-architect | Specialized SQL/migration expertise required for ENUM types, JSONB operations |
| RPC functions (update_course_progress) | All | database-architect | Complex JSONB manipulation, idempotency patterns, performance optimization |
| API endpoint (POST /api/coursegen/generate) | Complex | api-builder | Authentication (JWT), authorization, Zod validation, error handling, Saga pattern |
| Worker updates (step 1 recovery) | Small changes | MAIN | Minor edits to existing handler files (<50 lines) |
| Frontend changes (Authorization header) | Simple edits | MAIN | Header additions, URL updates, error messages |
| Utilities - Type definitions | All | MAIN | Simple TypeScript interfaces and enums |
| Utilities - Pino logger | Simple | MAIN | Drop-in replacement, ~30 lines, documented in quickstart |
| Utilities - Concurrency tracker | Complex | infrastructure-specialist OR MAIN | Redis Lua scripts, atomic operations (consider specialist if >150 lines) |
| Utilities - Retry logic | Simple | MAIN | Pure function, <50 lines, well-documented pattern |
| Polish/validation tasks | All | MAIN | Code cleanup, linting, quickstart testing, n8n parity verification |

**Decision Heuristic**:
- **Use specialist subagent** if: >200 lines, complex domain logic, external integrations, security-critical
- **Use MAIN agent** if: <100 lines, type definitions, simple edits, validation/cleanup tasks

### Parallelization Strategy

**Parallel Groups** (tasks that MUST run together for efficiency):

- **PARALLEL-GROUP-A** (Foundational Phase - After migrations):
  - T006: Replace logger with Pino (edit `logger/index.ts`)
  - T007: Create system metrics types (create `types/system-metrics.ts`)
  - T008: Create concurrency types (create `types/concurrency.ts`)
  - **Reason**: All create/edit different files, no dependencies, can run concurrently

- **PARALLEL-GROUP-B** (Polish Phase):
  - T027: Error handling improvements (review/edit multiple files)
  - T028: Pino log level configuration (environment variable setup)
  - T030: Code cleanup and formatting (linting, type-check across codebase)
  - T031: n8n parity checklist verification (validation only)
  - **Reason**: Different domains (error handling, logging, formatting, validation), no file conflicts

**Sequential Blocks** (tasks that MUST run alone):

- **Database Migrations (BLOCKING)**:
  - T003 â†’ T004 â†’ T005 (create system_metrics â†’ create RPC â†’ apply migrations)
  - **Reason**: Migration order matters, RPC depends on table existing, apply depends on both SQL files
  - **Blocks**: All of Phase 3-5 (user stories) until complete

- **API Endpoint Incremental Build**:
  - T011 â†’ T012 â†’ T013 â†’ T014 â†’ T015 â†’ T016 â†’ T017 â†’ T018 â†’ T019
  - **Reason**: Building single file `route.ts` incrementally (skeleton â†’ auth â†’ ownership â†’ concurrency â†’ branching â†’ job â†’ RPC â†’ rollback â†’ success)
  - **Alternative**: Could batch T011-T015 (validation layer), then T016-T019 (business logic layer) if team has 2 developers

- **Worker Lifecycle Updates**:
  - T020 â†’ T021 â†’ T022 (orphan detection â†’ lifecycle calls â†’ cleanup)
  - **Reason**: Adding to same handler file, each task builds on previous

**Blocking Tasks** (prevent next phase from starting):

- **Phase 2 (Foundational) â†’ BLOCKS â†’ Phase 3-5 (User Stories)**:
  - All foundational tasks (T003-T010) must complete before any user story work can begin
  - Specifically: Database migrations (T003-T005) and concurrency tracker (T010) are hard blockers
  - **Reason**: User stories depend on database schema, RPC function, and concurrency enforcement

- **Individual Blockers**:
  - T005 (Apply migrations) â†’ BLOCKS â†’ T006-T010 (can't create types for table that doesn't exist)
  - T008 (Concurrency types) â†’ BLOCKS â†’ T010 (concurrency tracker needs type definitions)
  - T010 (Concurrency tracker) â†’ BLOCKS â†’ Phase 3 (API endpoint needs concurrency.checkAndReserve())

### Git Branch Strategy

**Branch Name**: `002-main-entry-orchestrator` (from plan.md header)

**Phase 0 Task T-000 Instructions**:
1. Check if branch exists: `git branch --list 002-main-entry-orchestrator`
2. If not exists: `git checkout -b 002-main-entry-orchestrator`
3. If exists: `git checkout 002-main-entry-orchestrator`
4. Verify clean: `git status` (should show "nothing to commit")

**Commit Strategy**:
- Small atomic commits per task or logical group
- Phase checkpoints: Commit after each phase completion
- Critical checkpoints: After T005 (migrations applied), after T019 (API endpoint complete)

---

## Complexity Tracking

_Fill ONLY if Constitution Check has violations that must be justified_

**No violations** - All principles compliant. This section intentionally left empty.

---

## Phase 0: Research & Technical Decisions

**Status**: âœ… Complete

**Output**: [research.md](./research.md)

### Research Questions Resolved

1. âœ… **Pino Logger Implementation** â†’ Drop-in replacement with child logger pattern, 10x faster than Winston
2. âœ… **System Metrics Table Design** â†’ Event-based table with JSONB metadata, indexed by event_type and severity
3. âœ… **RPC `update_course_progress` Implementation** â†’ Idempotent PostgreSQL function with atomic JSONB updates
4. âœ… **Concurrency Limit Enforcement** â†’ Redis counters with Lua scripts for atomic check-and-reserve
5. âœ… **Dynamic Global Concurrency (Stage 8 Preview)** â†’ Hardcoded limit 3 in Stage 1, dynamic 3-10 in Stage 8
6. âœ… **Saga Pattern Implementation** â†’ Try-catch with explicit rollback in orchestrator, fallback in worker

### Key Technical Decisions

- **Logging**: Pino 9.6.0 (vs Winston) - 10x faster, zero-cost disabled levels, native child logger support
- **Concurrency**: Redis Lua scripts (vs database queries) - O(1) atomic operations, <1ms latency
- **Progress Updates**: PostgreSQL RPC function (vs client-side) - Single round-trip, atomic JSONB manipulation
- **Error Recovery**: Saga pattern with compensation - Orchestrator retries 3x, worker recovers orphaned jobs
- **Metrics Storage**: PostgreSQL `system_metrics` table - Queryable for Stage 8 dashboard, no external APM cost

---

## Phase 1: Design & Contracts

**Status**: âœ… Complete

**Outputs**:
- [data-model.md](./data-model.md)
- [contracts/api-endpoint.md](./contracts/api-endpoint.md)
- [contracts/rpc-update-course-progress.md](./contracts/rpc-update-course-progress.md)
- [quickstart.md](./quickstart.md)

### Data Model Summary

**Entities**:
1. **User** (existing, Supabase Auth) - `user_metadata.tier` determines limits
2. **Course** (existing) - `generation_progress` JSONB stores progress
3. **System Metrics** (NEW) - `system_metrics` table for critical events
4. **BullMQ Job** (existing, extended) - Redis-backed queue
5. **Redis Counters** (NEW) - `concurrency:user:{userId}`, `concurrency:global`

**Database Changes**:
- âœ… New table: `system_metrics` (event logging)
- âœ… New RPC: `update_course_progress(p_course_id, p_step_id, p_status, p_message, ...)`
- âœ… No changes to existing tables

**Migrations**: 2 new SQL files in `courseai-next/supabase/migrations/`

### API Contracts Summary

**Endpoint**: `POST /api/coursegen/generate`

**Request**:
```typescript
{
  courseId: string (UUID),
  webhookUrl?: string | null
}
// Headers: Authorization: Bearer {JWT}
```

**Responses**:
- `200 OK` - Success: `{ success: true, jobId: string }`
- `400 Bad Request` - Invalid payload
- `401 Unauthorized` - Missing/invalid JWT
- `403 Forbidden` - Course ownership violation
- `404 Not Found` - Course doesn't exist
- `429 Too Many Requests` - Concurrency limit hit
- `500 Internal Server Error` - RPC failure after retries

**RPC Function**: `update_course_progress(...) RETURNS JSONB`

**Parameters**: course_id, step_id (1-5), status, message, error details, metadata

**Behavior**: Atomically updates `generation_progress` JSONB, calculates percentage, sets timestamps

---

## Implementation Roadmap

### Pre-Implementation Checklist

- [x] Phase 0: Research complete
- [x] Phase 1: Design and contracts complete
- [x] Technical context filled
- [x] Constitution check passed
- [x] Data model documented
- [x] API contracts defined
- [ ] Tasks generated via `/speckit.tasks` â† **Next step**

### Implementation Phases (from tasks.md)

â³ **To be generated by `/speckit.tasks` command**

Expected phases:
1. **Database Setup** - Migrations (system_metrics, RPC function)
2. **Core Utilities** - Pino logger, retry util, concurrency tracker
3. **API Endpoint** - JWT validation, concurrency checks, job queueing, saga pattern
4. **Worker Updates** - Orphan detection, step 1 recovery, metrics logging
5. **Testing** - Unit tests, integration tests, contract tests
6. **Deployment** - Migration-first strategy, parallel with n8n

---

## Testing Strategy

### Unit Tests

**Modules to Test**:
- âœ… Concurrency Tracker - `checkAndReserve()`, `release()`, Redis Lua script
- âœ… Retry Utility - Backoff logic, attempt counting, error handling
- âœ… API Validation - Zod schema, UUID format, JWT extraction
- âœ… RPC Function - Step validation, percentage calculation, JSONB updates

**Framework**: Vitest (existing in Stage 0)

**Coverage Target**: 80%+ for new code

### Integration Tests

**Scenarios**:
1. âœ… End-to-end orchestration: API â†’ concurrency check â†’ job queue â†’ RPC â†’ success
2. âœ… Concurrency limits: FREE user submits 2 jobs, 2nd rejected with 429
3. âœ… RPC failure compensation: Simulate RPC failure, verify job rollback and metrics
4. âœ… Worker orphan recovery: Skip step 1 RPC, verify worker completes it
5. âœ… Priority queueing: Submit jobs from different tiers, verify processing order

**Framework**: Vitest + Supabase local + Redis

**Environment**: Docker Compose with isolated database/Redis instances

### Contract Tests

**Validation**:
- âœ… 200 OK response matches schema
- âœ… 429 Too Many Requests includes details object
- âœ… 500 Internal Server Error message in Russian
- âœ… RPC return value matches `GenerationProgress` type

**Framework**: JSON Schema validation library

### Manual E2E Testing

**Tools**:
- BullBoard dashboard (verify job creation and priority)
- PostgreSQL client (verify progress updates)
- Redis CLI (verify counter increments)
- Pino logs (verify structured JSON)

**Test Cases**:
1. âœ… Submit course generation via frontend
2. âœ… Monitor BullBoard for job status
3. âœ… Poll `/api/courses/[slug]/check-status` for progress
4. âœ… Verify Russian step names in UI
5. âœ… Trigger concurrency limit, verify 429 error
6. âœ… Manually delete Redis counter mid-job, verify worker recovery

---

## Deployment Plan

### Migration Strategy

**Phase 1: Deploy Migrations**
```bash
cd courseai-next
supabase migration up --project-ref production-ref
# Verify RPC function exists
psql -c "SELECT proname FROM pg_proc WHERE proname = 'update_course_progress';"
```

**Phase 2: Deploy Backend Code**
```bash
cd packages/course-gen-platform
pnpm build
docker build -t course-gen-backend:stage1 .
docker push ...
kubectl apply -f k8s/backend-deployment.yaml
```

**Phase 3: Deploy Frontend (Update Env Variable)**
```bash
# Update frontend environment variable
N8N_WEBHOOK_URL=https://api.megacampusai.com/api/coursegen/generate
# Deploy frontend
cd courseai-next
pnpm build
docker build -t courseai-frontend:stage1 .
docker push ...
kubectl apply -f k8s/frontend-deployment.yaml
```

**Phase 4: Parallel Operation (1 Week)**
- Both n8n and new backend active
- Monitor system_metrics for errors
- Compare n8n vs backend success rates
- Verify frontend compatibility

**Phase 5: Cutover**
- Switch 100% traffic to new backend
- Disable n8n workflow (keep as backup)
- Monitor for 24 hours
- Sunset n8n if stable

### Rollback Plan

**If backend fails in production**:
1. Revert frontend env variable to n8n URL
2. Redeploy frontend (< 5 minutes)
3. n8n resumes handling requests
4. Investigate backend logs and fix
5. Re-deploy after fix verified in staging

**Database rollback** (if needed):
```sql
-- Rollback migrations (in reverse order)
DROP FUNCTION IF EXISTS update_course_progress;
DROP TABLE IF EXISTS system_metrics;
DROP TYPE IF EXISTS metric_severity;
DROP TYPE IF EXISTS metric_event_type;
```

---

## Risks & Mitigation

### Risk 1: RPC Performance Bottleneck

**Probability**: Low
**Impact**: High
**Mitigation**:
- RPC function optimized for single UPDATE (no N+1 queries)
- Indexed by primary key (UUID)
- Tested with pg_stat_statements for query plan
- Fallback: Worker can skip RPC and update via Supabase client (slower but functional)

### Risk 2: Redis Single Point of Failure

**Probability**: Medium
**Impact**: High
**Mitigation**:
- Redis persistence enabled (RDB snapshots)
- Redis Sentinel for failover (Stage 2+)
- Counters reconcile every 5 minutes (compare with BullMQ active jobs)
- TTL on user keys (1 hour) auto-cleans orphaned counters

### Risk 3: Frontend Incompatibility

**Probability**: Low
**Impact**: Medium
**Mitigation**:
- Contract tests validate `generation_progress` JSONB structure
- Russian step names hardcoded (verified in spec)
- Manual QA testing with existing frontend before deployment
- Parallel operation with n8n ensures rollback option

### Risk 4: Concurrency Counter Drift

**Probability**: Medium
**Impact**: Low
**Mitigation**:
- Worker `finally` block always releases slot
- TTL on user keys (1 hour) auto-expires
- Reconciliation cron job every 5 minutes (compare Redis vs BullMQ)
- Admin dashboard displays counter values for manual inspection

---

## Success Criteria

### Functional

- [x] API endpoint accepts requests with JWT auth
- [x] Concurrency limits enforced (user tier + global)
- [x] Correct job type queued (based on files presence)
- [x] Job priority matches user tier
- [x] Progress updated via RPC with retry
- [x] Worker recovers orphaned jobs (step 1 fallback)
- [x] System metrics logged for failures

### Performance

- [ ] Endpoint P95 latency < 500ms (target from spec)
- [ ] RPC execution < 100ms
- [ ] Concurrency check < 1ms (Redis)
- [ ] No degradation vs n8n baseline

### Reliability

- [ ] Saga pattern tested: RPC failure â†’ job rollback
- [ ] Worker recovery tested: missing step 1 â†’ auto-complete
- [ ] Zero data loss during failures
- [ ] All critical events in system_metrics

### Observability

- [ ] Pino logs output structured JSON
- [ ] Child loggers propagate context (requestId, userId, tier, courseId, jobId)
- [ ] System metrics queryable in database
- [ ] BullBoard dashboard shows job priorities

---

## Dependencies

### Stage 0 Prerequisites (Verified Complete)

- âœ… BullMQ integration with job types defined
- âœ… `courses` table with `generation_progress` JSONB column
- âœ… Redis instance running and connected
- âœ… tRPC server with middleware
- âœ… Supabase Auth with JWT validation
- âœ… BullBoard admin dashboard

### Stage 1 Requirements (To Be Implemented)

- âŒ Database migration: `system_metrics` table
- âŒ Database migration: `update_course_progress` RPC function
- âŒ Pino logger installed and configured
- âŒ Concurrency tracker module
- âŒ API endpoint `/api/coursegen/generate`
- âŒ JWT Bearer token validation middleware
- âŒ Worker orphan recovery logic
- âŒ Retry utility with exponential backoff
- âŒ System metrics logging helper

### External Dependencies

- **Supabase** - Database and Auth (existing)
- **Redis** - Job queue and concurrency counters (existing)
- **Next.js Frontend** - Minor change: add `Authorization` header (minimal effort)

**Blocking Dependencies**: None - all prerequisites from Stage 0 are complete

---

## Open Questions

**Status**: âœ… All resolved (see research.md)

No open questions remain. All technical unknowns were answered in Phase 0 research:
1. âœ… Pino implementation strategy
2. âœ… System metrics schema
3. âœ… RPC function design
4. âœ… Concurrency enforcement approach
5. âœ… Dynamic concurrency (deferred to Stage 8)
6. âœ… Saga pattern implementation

---

## Next Steps

1. âœ… Phase 0 research complete
2. âœ… Phase 1 design and contracts complete
3. **â³ Generate tasks** â†’ Run `/speckit.tasks` to create implementation task breakdown
4. Begin implementation following tasks.md
5. Run unit tests for each module
6. Run integration tests for full flow
7. Deploy migrations to staging
8. Deploy backend to staging
9. Test with frontend in staging
10. Deploy to production (parallel with n8n)
11. Monitor for 1 week
12. Cutover and sunset n8n

**Command to proceed**: `/speckit.tasks`

---

## References

- **Feature Spec**: [spec.md](./spec.md)
- **Research Findings**: [research.md](./research.md)
- **Data Model**: [data-model.md](./data-model.md)
- **API Contract**: [contracts/api-endpoint.md](./contracts/api-endpoint.md)
- **RPC Contract**: [contracts/rpc-update-course-progress.md](./contracts/rpc-update-course-progress.md)
- **Quickstart Guide**: [quickstart.md](./quickstart.md)
- **Constitution**: `.specify/memory/constitution.md`
- **BullMQ Docs**: https://docs.bullmq.io/
- **Pino Docs**: https://getpino.io/
- **Supabase RPC**: https://supabase.com/docs/guides/database/functions

---

**Plan Version**: 1.0
**Created**: 2025-10-20
**Last Updated**: 2025-10-20
**Status**: âœ… Complete - Ready for task generation
