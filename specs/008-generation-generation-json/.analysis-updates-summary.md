# Specification Analysis Updates - Summary

**Date**: 2025-11-06
**Feature**: Generation Phase - Course Structure JSON Generation (008-generation-generation-json)
**Analysis Report**: Cross-artifact consistency check (spec.md, plan.md, tasks.md)

---

## Updates Applied

### ✅ 1. Token Budget Consolidation (D1 - HIGH)

**Problem**: Token budget thresholds duplicated across spec.md, plan.md, tasks.md with conflicting values.

**Solution**: Created single source of truth document.

**Files Changed**:
- **NEW**: `.tmp/current/plans/.token-budget-allocation.md` (comprehensive token budget strategy)
- **UPDATED**: `spec.md` FR-014 — now references `.token-budget-allocation.md` for detailed budget breakdown
- **UPDATED**: Edge cases (spec.md:100) — already correct, kept as-is (input >108K OR total >115K)

**Key Constants Defined**:
```
TOTAL_PER_BATCH_BUDGET = 120K tokens (input + output combined)
MAX_INPUT_TOKENS_PER_BATCH = 90K tokens
MAX_OUTPUT_TOKENS_PER_BATCH = 30K tokens
RAG_MAX_TOKENS = 40K tokens (with dynamic adjustment)
GEMINI_TRIGGER_INPUT_THRESHOLD = 108K tokens (90% of 120K)
GEMINI_TRIGGER_TOTAL_THRESHOLD = 115K tokens (96% of 120K, safety margin)
```

---

### ✅ 2. Style Integration Validation (U2 - HIGH)

**Problem**: FR-030 requires style propagation to lesson technical specifications (lesson_objectives, key_topics), but T021 didn't explicitly validate this.

**Solution**: Added explicit instruction in T021 buildBatchPrompt to apply style to lesson-level fields.

**Files Changed**:
- **UPDATED**: `tasks.md` T021 — added "FR-030 Style Integration Validation" section

**Implementation Guidance**:
```markdown
- **FR-030 Style Integration Validation**: Explicitly instruct LLM to apply style to lesson_objectives and key_topics:
  - Example prompt addition: "Generate lesson_objectives in {style} style (e.g., storytelling: use narrative verbs like 'explore', 'discover'; academic: use formal verbs like 'analyze', 'evaluate')"
  - Ensures style propagates to lesson technical specifications for Stage 6 consistency
```

---

### ✅ 3. Gemini Fallback Triggers Standardization (I1 - HIGH)

**Problem**: Inconsistent trigger conditions across documents (some mentioned only input >108K, others mentioned both conditions).

**Solution**: Standardized to BOTH conditions throughout all documents.

**Files Changed**:
- **UPDATED**: `spec.md` FR-014 — references `.token-budget-allocation.md` with both triggers
- **ALREADY CORRECT**: `spec.md:100` Edge Cases — already mentions both conditions
- **UPDATED**: `.token-budget-allocation.md` — comprehensive trigger logic with code example

**Trigger Logic** (TypeScript):
```typescript
function shouldUseGemini(inputTokens: number, outputTokens: number): boolean {
  const totalTokens = inputTokens + outputTokens;

  // Condition 1: Input alone exceeds 90% threshold
  if (inputTokens > 108000) {
    return true;
  }

  // Condition 2: Total tokens exceed 96% threshold (safety margin)
  if (totalTokens > 115000) {
    return true;
  }

  return false;
}
```

---

### ✅ 4. RAG Context Overflow Handling (U3 - MEDIUM)

**Problem**: FR-004 mentions "RAG context capped at 40K tokens" but overflow handling not explicitly described.

**Solution**: Added detailed truncation strategy in T022.

**Files Changed**:
- **UPDATED**: `tasks.md` T022 — added "Overflow handling" section with truncation logic

**Implementation**:
```markdown
- **Overflow handling** (if top 5 chunks >40K tokens):
  - Truncate to first 40K tokens (prioritize highest-ranked chunks from cosine similarity)
  - Log: { ragTokens: actualSize, cappedTo: 40000, chunksIncluded: N, chunksTotal: 5 }
  - Rationale: Top-ranked chunks already prioritized by Qdrant cosine similarity
```

**Dynamic Adjustment**:
```typescript
const maxRAG = 90000 - (baseTokens + styleTokens + analyzeTokens + sectionTokens);
ragTokens = Math.min(ragTokens, Math.max(0, maxRAG));
```

---

### ✅ 5. Field Length Constraints Update (U4 - MEDIUM)

**Problem**: Maximum field lengths too restrictive (course_title max 300, lesson_title max 200, etc.).

**Solution**: Increased all maximum lengths by 3-5x while keeping minimums.

**Files Changed**:
- **UPDATED**: `spec.md` FR-022 — updated with new min/max values
- **UPDATED**: `data-model.md` — updated all Zod schemas with increased maximums

**Changes Summary**:

| Field | Old Max | New Max | Multiplier |
|-------|---------|---------|------------|
| course_title | 300 | 1000 | 3.3x |
| course_description | 1000 | 3000 | 3x |
| course_overview | 3000 | 10000 | 3.3x |
| target_audience | 500 | 1500 | 3x |
| section_title | 200 | 600 | 3x |
| section_description | 600 | 2000 | 3.3x |
| lesson_title | 200 | 500 | 2.5x |
| lesson_objectives (each) | 200 | 600 | 3x |
| key_topics (each) | 100 | 300 | 3x |
| learning_outcomes (each) | 200 | 600 | 3x |
| prerequisites (each) | 200 | 600 | 3x |
| exercise_title | 100 | 300 | 3x |
| exercise_description | 500 | 1500 | 3x |
| assessment_description | 500 | 1500 | 3x |
| course_tags (each) | 50 | 150 | 3x |

**Rationale**: Provide LLMs with flexibility to generate comprehensive, detailed content without artificial length constraints. Minimums enforce quality baseline.

---

### ✅ 6. Performance Goals Update (I2 - MEDIUM)

**Problem**: SC-003 stated "metadata <10s" but qwen3-max model is 2-3x slower than OSS 120B.

**Solution**: Removed strict per-phase timing, kept total pipeline target.

**Files Changed**:
- **UPDATED**: `spec.md` SC-003 — updated with model-specific timing ranges

**New SC-003**:
```markdown
SC-003: Course structure generation completes within 150 seconds for standard courses
(8 sections, 20-30 lessons), measured from job start to database commit.
Metadata generation timing varies by model: OSS 20B (~5-8s), OSS 120B (~8-12s),
qwen3-max (~15-25s due to 2-3x slower latency per research.md).
Total pipeline target: <150s regardless of metadata model choice.
```

---

### ✅ 7. Style Validation Simplification (C5 - REMOVED)

**Problem**: SC-008 required "95%+ style adherence measured by manual review sampling" — deemed over-engineering.

**Solution**: Simplified to trust LLM without automated measurement.

**Files Changed**:
- **UPDATED**: `spec.md` SC-008 — removed "95%" metric, changed to manual validation only

**New SC-008**:
```markdown
SC-008: System correctly applies selected style (manual validation via sampling,
no automated measurement required — trust LLM to follow style prompts from style-prompts.ts)
```

---

## Issues Confirmed as Non-Issues

### ✅ U1 — FR-026 Section Regeneration

**Status**: **NOT A PROBLEM** — Tasks T039-A and T039-B already exist in tasks.md (lines 967-1003)

**Evidence**:
- T039-A: SectionRegenerationService implementation
- T039-B: generation.regenerateSection tRPC endpoint

**Conclusion**: FR-026 fully covered, removed from issues list.

---

### ✅ A2 — Quality Scores Definition

**Status**: **NOT A PROBLEM** — Already defined in data-model.md (lines 202-211)

**Evidence**:
```typescript
export const QualityScoresSchema = z.object({
  metadata_similarity: z.number().min(0).max(1)
    .describe('Semantic similarity score for metadata (Jina-v3)'),
  sections_similarity: z.array(z.number().min(0).max(1))
    .describe('Semantic similarity scores per section batch'),
  overall: z.number().min(0).max(1)
    .describe('Overall quality score (weighted average)'),
});
```

**Conclusion**: quality_scores clearly defined with Jina-v3 cosine similarity (0-1 range), removed from issues list.

---

### ✅ D2, I3 — Model Selection Strategy

**Status**: **CORRECTLY DEFERRED** — Strategy determined via RT-001 research task (T001-R)

**Reasoning**: Model selection (qwen3-max vs OSS 120B vs OSS 20B for metadata) cannot be decided until RT-001 research completes (MANDATORY for production). Current development baseline (OSS 20B) will be replaced by RT-001 findings before production deployment.

**Conclusion**: No changes needed, architecture correctly defers decision to research phase.

---

### ✅ C4 — E2E Multi-Model Test

**Status**: **REMOVED** — Cannot test model selection until RT-001 completes

**Reasoning**: E2E test for multi-model orchestration requires knowing final model selection strategy. Writing test before RT-001 would create brittle, incorrect test expectations.

**Conclusion**: Test should be added AFTER RT-001 findings are applied (post T001-R-IMPL), removed from current issues.

---

## Final Status Summary

| Issue ID | Category | Severity | Status | Action |
|----------|----------|----------|--------|--------|
| **D1** | Duplication | HIGH | ✅ RESOLVED | Created `.token-budget-allocation.md`, updated spec.md FR-014 |
| **U2** | Underspecification | HIGH | ✅ RESOLVED | Added FR-030 validation to tasks.md T021 |
| **I1** | Inconsistency | HIGH | ✅ RESOLVED | Standardized Gemini triggers (input >108K OR total >115K) |
| **U3** | Underspecification | MEDIUM | ✅ RESOLVED | Added RAG truncation logic to tasks.md T022 |
| **U4** | Underspecification | MEDIUM | ✅ RESOLVED | Increased field max lengths 3-5x in spec.md + data-model.md |
| **I2** | Inconsistency | MEDIUM | ✅ RESOLVED | Updated SC-003 with model-specific timing |
| **C5** | Coverage Gap | LOW | ✅ RESOLVED | Simplified SC-008, removed automated style measurement |
| **U1** | Underspecification | HIGH | ✅ NON-ISSUE | Tasks T039-A/B already exist |
| **A2** | Ambiguity | MEDIUM | ✅ NON-ISSUE | quality_scores defined in data-model.md |
| **D2** | Duplication | MEDIUM | ✅ NON-ISSUE | Correctly deferred to RT-001 |
| **I3** | Inconsistency | MEDIUM | ✅ NON-ISSUE | Correctly deferred to RT-001 |
| **C4** | Coverage Gap | LOW | ✅ NON-ISSUE | Test after RT-001, not before |

---

## Remaining Work Before Implementation

### MANDATORY (0 critical issues)

✅ **All critical issues resolved**

### RECOMMENDED (optional improvements)

The following medium/low priority findings from the original analysis report can be addressed during implementation but do NOT block starting development:

- **C1**: Add FR-019 JSON repair failure test cases to T025
- **C2**: Make FR-024 status='generation_failed' explicit in T034 error handling
- **C3**: Add SC-009 JSON repair success rate measurement (10 test cases, ≥8 pass = 80%)
- **C6**: Add multilingual test (Russian course title) to T023/T024
- **T1**: Standardize terminology (analysis_result vs Analyze results) across docs
- **T2-T3**: Minor terminology clarifications (course_structure DB vs CourseStructure TS)

---

## Files Modified

### Primary Artifacts
1. `specs/008-generation-generation-json/spec.md` — FR-014, FR-022, SC-003, SC-008 updated
2. `specs/008-generation-generation-json/tasks.md` — T021 (style validation), T022 (RAG overflow) updated
3. `specs/008-generation-generation-json/data-model.md` — All Zod schemas updated with 3-5x max lengths

### New Files
4. `.tmp/current/plans/.token-budget-allocation.md` — Token budget strategy (single source of truth)
5. `specs/008-generation-generation-json/.analysis-updates-summary.md` — This file

---

## Next Steps

1. **Review this summary** with team/stakeholders
2. **Verify all changes** align with project requirements
3. **Begin Phase 0** of tasks.md (Git branch + orchestration planning)
4. **Execute RT-001** research task (qwen3-max strategy) as first priority in Phase 1
5. **Proceed with implementation** following updated spec.md, tasks.md, data-model.md

---

## Version Control

**Commit Message Suggestion**:
```
docs(spec-008): resolve analysis findings - token budget, field lengths, style validation

- Create token budget strategy document (.tmp/current/plans/.token-budget-allocation.md)
- Standardize Gemini fallback triggers (input >108K OR total >115K)
- Add FR-030 style validation to T021 buildBatchPrompt
- Add RAG overflow handling (truncate to 40K) to T022
- Increase field max lengths 3-5x for flexibility (FR-022)
- Update SC-003 with model-specific timing (remove strict 10s limit)
- Simplify SC-008 style validation (manual only, no automated measurement)

Resolves: D1 (duplication), U2 (underspec), I1 (inconsistency), U3 (RAG), U4 (field lengths), I2 (performance), C5 (style)
Verified: U1, A2, D2, I3, C4 already correct or properly deferred to RT-001
```

---

**Generated**: 2025-11-06
**Author**: Claude Code (Specification Analysis Agent)
**Review Status**: Awaiting stakeholder approval
