# План финальных доработок: Celestial Redesign

**Приоритет:** Высокий
**Цель:** Исправить логику группировки, отображение прогресса, макет и состав виджетов.

## 1. Группировка процессов (Документы)
**Проблема:** На 2-м этапе (обработка документов) логи идут "кашей", не группируются по файлам.
**Решение:**
- В `ActiveStageCard.tsx` улучшить логику группировки.
- Для `stage_2`: извлекать имя файла или ID документа из `trace.input_data` или `trace.output_data` (поля `file_name`, `document_id`, `path`).
- Использовать это значение как ключ для группировки в `ParallelProcessGroup`.
- Отображать имя файла в заголовке группы.

## 2. Макет и Виджеты
**Проблема:**
- Контент узкий (хотя просили `max-w-screen-2xl`, видимо нужно еще шире или `container` ограничивает).
- Виджеты "Стоимость" и "Модель" не нужны.
- Нет виджета "Секции" (Модули).
- Счетчик уроков показывает "0/5" или "5" до того, как уроки известны.
**Решение:**
- **Layout:** Убрать `max-w-6xl` из контейнера, использовать `w-full px-4` или `max-w-[95%]`.
- **Widgets:**
  - Удалить `Cost` и `Model`.
  - Добавить `Sections` (Секции/Модули).
  - Логика `Lessons`: показывать "—" или "?", пока `lessons_total` <= 0 или пока не наступил этап генерации структуры.
- **Steps:** Исправить отображение "1 из 5" -> "1 из 6". Проверить `total_steps` в `GenerationProgress`.

## 3. Исправление прогресса (6 шагов)
**Проблема:** Отображается "5 шагов", хотя мы добавили 6-й (Инициализацию).
**Причина:** Скорее всего в базе данных или в дефолтном стейте `total_steps` жестко задано как 5 или 6, но UI считает иначе.
**Решение:**
- В `utils.ts` убедиться, что `STAGE_CONFIG` используется для подсчета общего количества шагов.
- В `StatsGrid.tsx` брать общее количество из конфига, а не из `progress.total_steps` (если оно там устаревшее), или явно обновлять его.

## План действий (Субагент)
1.  **Analyze**: Посмотреть структуру `trace` для stage 2 (попытаться найти логику извлечения имени файла).
2.  **Fix Layout**: `GenerationProgressContainerEnhanced.tsx` -> `max-w-full`.
3.  **Fix Widgets**: `StatsGrid.tsx` -> убрать лишнее, добавить секции, поправить логику уроков/шагов.
4.  **Fix Grouping**: `ActiveStageCard.tsx` -> логика группировки для Stage 2.
