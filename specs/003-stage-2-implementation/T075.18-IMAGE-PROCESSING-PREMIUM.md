# T075.18: Image Processing Research & Implementation (PREMIUM)

**Task ID**: T075.18-IMAGE-PROCESSING
**Parent**: T075 (RAG Implementation)
**Tier**: PREMIUM only
**Priority**: Medium (Stage 3 enhancement)
**Status**: ⏸️ Deferred to Stage 3
**Created**: 2025-10-27

---

## Executive Summary

Research and implement optimal solution for processing images within documents (PDF, DOCX, PPTX) and standalone image files (PNG, JPG, GIF) for PREMIUM tier users. The goal is to extract semantic meaning from images to enhance course generation quality.

**Key Question**: What is the best approach for image processing in educational content?

**Options to Investigate**:
1. Vision API (OpenAI GPT-4o, Jina Vision, etc.)
2. Open-source OCR models (Tesseract, EasyOCR, PaddleOCR)
3. Docling built-in image extraction + description
4. Hybrid approach (OCR + Vision API)

---

## Current State

### STANDARD Tier Behavior
- **Files**: PDF, DOCX, PPTX, HTML, TXT, MD (max 10 MB)
- **Image Handling**: Images **ignored/removed** during Docling processing
- **OCR**: Tesseract/EasyOCR for text-based scanned PDFs (no image semantics)
- **User Warning**: "Files with images require PREMIUM tier"

### PREMIUM Tier Target
- **Files**: All formats + standalone images (PNG, JPG, GIF, SVG, WEBP) up to 100 MB
- **Image Handling**: Extract semantic descriptions for educational context
- **Use Cases**:
  - Diagrams and flowcharts in PDF textbooks
  - Screenshots in technical documentation
  - Infographics in presentations
  - Mathematical formulas as images
  - Scientific visualizations

---

## Research Phase (3-5 days)

### Option 1: Vision API (Cloud Services)

**Candidates**:
1. **OpenAI GPT-4o Vision**
   - Pros: High quality, multilingual, understands context
   - Cons: Expensive ($0.01-0.05 per image), API dependency
   - Use case: Complex diagrams, educational illustrations

2. **Jina AI Vision**
   - Pros: Specialized for document understanding, cheaper
   - Cons: Less mature than GPT-4o
   - Use case: Document-embedded images

3. **Google Cloud Vision AI**
   - Pros: Good OCR + object detection, competitive pricing
   - Cons: Google dependency, complex pricing
   - Use case: Mixed text/image content

4. **Anthropic Claude 3 Vision**
   - Pros: High quality, good at educational content
   - Cons: Expensive, newer API
   - Use case: Complex academic diagrams

**Research Questions**:
- Cost per 1000 images for typical educational content?
- Quality comparison for technical diagrams vs. general images?
- API latency and timeout risks for large files?
- Multi-language support for non-English content?

---

### Option 2: Open-Source OCR Models

**Candidates**:
1. **Tesseract + EasyOCR** (already in Docling)
   - Pros: Free, fast, good for text extraction
   - Cons: No semantic understanding, text-only
   - Use case: Scanned text images

2. **PaddleOCR**
   - Pros: Better accuracy for non-English text, formula recognition
   - Cons: Heavier model, slower processing
   - Use case: Mathematical formulas, multilingual text

3. **Nougat** (Meta)
   - Pros: Specialized for academic PDFs, LaTeX output for formulas
   - Cons: Large model, GPU recommended
   - Use case: Scientific papers with equations

**Research Questions**:
- Can extract meaningful descriptions beyond text?
- Performance on diagrams, flowcharts, infographics?
- Memory and CPU requirements for production?

---

### Option 3: Docling Built-in Image Processing

**Current Capabilities**:
- Docling can extract images from PDFs
- Returns image bytes + position metadata
- No semantic description (just raw image data)

**Potential Enhancement**:
- Integrate lightweight vision model into Docling container
- Process images during document conversion
- Return descriptions alongside markdown

**Research Questions**:
- What lightweight vision models can run in Docling container?
- Performance impact on document processing time?
- Quality sufficient for educational content?

---

### Option 4: Hybrid Approach (RECOMMENDED STARTING POINT)

**Strategy**:
1. **Phase 1**: Docling extracts images → saves to temp storage
2. **Phase 2**: Classify image types:
   - **Text images** → OCR (Tesseract/PaddleOCR)
   - **Diagrams/Charts** → Vision API (GPT-4o/Jina)
   - **Decorative images** → Skip or minimal description
3. **Phase 3**: Embed descriptions into markdown context

**Benefits**:
- Cost-effective (use OCR when sufficient)
- High quality for complex images (Vision API)
- Flexible (can switch providers)

**Research Questions**:
- How to classify image types reliably?
- Optimal cost/quality tradeoff?
- Integration complexity vs. pure Vision API?

---

## Research Deliverables

### 1. Comparative Analysis Document

**File**: `docs/investigations/image-processing-solutions-comparison.md`

**Contents**:
```markdown
# Image Processing Solutions Comparison

## Executive Summary
- Recommended solution: [...]
- Cost estimate: $X per 1000 images
- Expected quality: [benchmarks]

## Solutions Evaluated

### 1. OpenAI GPT-4o Vision
- **Cost**: $X per image
- **Quality**: [samples with scores]
- **Latency**: Xms per image
- **Pros/Cons**: [...]

### 2. Jina AI Vision
- [...]

### 3. PaddleOCR
- [...]

### 4. Hybrid Approach
- [...]

## Benchmarks
- 50 test images (diagrams, charts, formulas, screenshots)
- Quality scores (1-10) for each solution
- Cost breakdown per tier usage

## Recommendation
- **PREMIUM tier**: Use [solution]
- **Rationale**: [...]
- **Fallback**: [alternative if API fails]
```

---

### 2. Cost Analysis

| Solution | Cost per Image | Cost per 1000 Images | Quality Score (1-10) | Latency |
|----------|----------------|---------------------|---------------------|---------|
| GPT-4o Vision | $0.01-0.05 | $10-50 | 9/10 | 2-5s |
| Jina Vision | $0.001-0.01 | $1-10 | 7/10 | 1-3s |
| Google Vision | $0.001-0.005 | $1-5 | 8/10 | 1-2s |
| Claude 3 Vision | $0.02-0.08 | $20-80 | 9/10 | 3-6s |
| PaddleOCR | Free | Free | 5/10 (text only) | 0.5-1s |
| Hybrid | $0.005-0.02 | $5-20 | 8/10 | 2-4s |

**PREMIUM Tier Budget**:
- $149/month revenue
- Target: <$10/month per org on image processing
- Allows: ~500-2000 images/month (depending on solution)

---

### 3. Prototype Implementation

**Proof of Concept**:
```typescript
// packages/course-gen-platform/src/shared/images/processor.ts

export interface ImageDescription {
  type: 'diagram' | 'chart' | 'formula' | 'screenshot' | 'decorative';
  description: string;
  confidence: number;
  provider: 'gpt4o' | 'jina' | 'paddle-ocr' | 'docling';
}

export async function describeImage(
  imagePath: string,
  options?: {
    provider?: 'auto' | 'gpt4o' | 'jina' | 'paddle-ocr';
    context?: string; // Document context for better descriptions
  }
): Promise<ImageDescription> {
  // TODO: Implement based on research findings
}
```

---

## Implementation Phase (after research)

### Phase 1: Vision API Integration (3-5 days)

**Based on research recommendation**:

1. **Setup API Client** (1 day)
   - Configure selected provider (GPT-4o, Jina, or other)
   - Implement retry logic and error handling
   - Add rate limiting and cost tracking

2. **Integrate with Docling** (2 days)
   - Extract images during document processing
   - Send to Vision API for description
   - Embed descriptions in markdown output

3. **Testing** (1-2 days)
   - Test with various image types (diagrams, charts, formulas)
   - Validate description quality for educational content
   - Performance testing (latency, cost)

### Phase 2: Tier Enforcement (1 day)

4. **File Validation**
   - Detect images in uploaded files (PDF, DOCX, PPTX)
   - Reject STANDARD tier uploads with images
   - Allow PREMIUM tier uploads with images

5. **User Messaging**
   - Clear error: "This file contains images. Please upgrade to PREMIUM tier."
   - UI warning before upload: "Files with images require PREMIUM tier"

### Phase 3: Quality Optimization (2-3 days)

6. **Context-Aware Descriptions**
   - Pass document title/headers to Vision API
   - Improve description relevance for course generation

7. **Image Type Classification**
   - Classify images (diagram, chart, formula, etc.)
   - Skip decorative images (reduce costs)

8. **Fallback Strategy**
   - If Vision API fails → use OCR as fallback
   - Graceful degradation (process without images if needed)

**Total Estimated Time**: 6-9 days (after research)

---

## Success Criteria

### Research Phase
1. ✅ Comparative analysis document completed
2. ✅ Cost estimates for PREMIUM tier budget validated
3. ✅ Recommended solution selected with clear rationale
4. ✅ Prototype demonstrates feasibility

### Implementation Phase
5. ✅ PREMIUM tier can upload files with images (PDF, DOCX, PPTX, PNG, JPG, GIF)
6. ✅ STANDARD tier rejects files with images (clear error message)
7. ✅ Image descriptions embedded in markdown context
8. ✅ Quality meets expectations for educational content (>7/10 score)
9. ✅ Cost stays within budget (<$10/org/month for typical usage)
10. ✅ Processing time acceptable (<30 seconds per image)

---

## Risk Assessment

**Risk 1**: Vision API costs exceed budget
**Mitigation**:
- Implement intelligent image filtering (skip decorative images)
- Use hybrid approach (OCR for simple images, Vision API for complex)
- Set monthly usage limits per organization

**Risk 2**: Vision API latency causes timeout
**Mitigation**:
- Process images asynchronously (after markdown conversion)
- Set reasonable timeout (30s per image)
- Fallback to no-image processing if timeout

**Risk 3**: Description quality insufficient for course generation
**Mitigation**:
- Extensive testing with educational content
- Context-aware prompts to Vision API
- Allow manual image description override

**Risk 4**: Provider API changes or deprecation
**Mitigation**:
- Abstraction layer (easy to swap providers)
- Support multiple providers as fallback
- Monitor provider announcements

---

## Testing Strategy

### Research Phase Testing
- **50 diverse images**: diagrams, charts, formulas, screenshots, infographics
- **Quality scoring**: Manual evaluation (1-10) by domain expert
- **Cost tracking**: Monitor API usage for realistic estimates
- **Latency measurement**: Average time per image across providers

### Implementation Phase Testing
- **STANDARD tier**: Reject PDFs with embedded images
- **PREMIUM tier**: Process PDFs with 1-10 images
- **Standalone images**: Upload PNG, JPG, GIF files
- **Error handling**: API failures, timeout, invalid images
- **Cost monitoring**: Track actual costs vs. budget

---

## Alternative Solutions (Deferred)

### GPU-Accelerated Local Models
- **Example**: BLIP-2, LLaVA (open-source vision-language models)
- **Pros**: No API costs, full control
- **Cons**: Requires GPU infrastructure, slower than cloud APIs
- **Verdict**: Consider for Stage 4 if API costs too high

### Pre-trained Image Classifiers
- **Example**: ResNet, EfficientNet for image classification
- **Pros**: Fast, cheap
- **Cons**: Only classification (no descriptions)
- **Verdict**: Useful for filtering decorative images

---

## Related Tasks

- **T075**: RAG Implementation (parent task)
- **T074.1.2**: Docling MCP Server Integration (✅ completed)
- **T075.17**: PDF Chunking (deferred to Stage 2)
- **T075.9-PREMIUM**: Reranking (deferred to Stage 3)

---

## References

- **Pricing Tiers**: `docs/PRICING-TIERS.md` (line 52: Image processing for PREMIUM)
- **Docling Documentation**: [https://docling-project.github.io/docling/](https://docling-project.github.io/docling/)
- **OpenAI Vision API**: [https://platform.openai.com/docs/guides/vision](https://platform.openai.com/docs/guides/vision)
- **Jina AI**: [https://jina.ai/](https://jina.ai/)
- **PaddleOCR**: [https://github.com/PaddlePaddle/PaddleOCR](https://github.com/PaddlePaddle/PaddleOCR)

---

## Next Steps

1. **Stage 3**: Begin research phase (3-5 days)
2. Create comparative analysis document
3. Select optimal solution based on cost/quality tradeoff
4. Prototype integration with Docling
5. Validate with PREMIUM tier users (beta testing)
6. Roll out to production

**NOTE**: This task is deferred until PREMIUM tier has significant user base and demand for image processing is validated.
