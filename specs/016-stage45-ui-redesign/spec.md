# Feature Specification: Редизайн интерфейса результатов Stage 4-5

**Feature Branch**: `016-stage45-ui-redesign`
**Created**: 2025-12-05
**Status**: Draft
**Input**: Редизайн UI Stage 4-5 для создателей курсов: человеко-понятные названия фаз, редактирование результатов анализа и структуры курса, inline-перегенерация через AI чат

## Контекст и проблема

Текущий интерфейс отображения результатов анализа (Stage 4) и генерации структуры курса (Stage 5) ориентирован на разработчиков, а не на конечных пользователей — методологов, инструкторов и создателей курсов.

**Целевая аудитория:**
- **Методологи** — специалисты по разработке образовательных программ
- **Инструкторы** — преподаватели, создающие курсы
- **Создатели курсов** — эксперты предметной области без технического бэкграунда

**Текущие проблемы:**

| Проблема | Влияние на пользователя |
|----------|------------------------|
| Технические названия "Attempt 1, 2, 3" | Непонятно, какой этап обработки происходит |
| Вывод в формате JSON | Нечитаемо для нетехнических пользователей |
| Результаты только для чтения | Невозможно исправить ошибки AI |
| Скрытый чат для перегенерации | Неочевидно, как попросить AI переделать результат |
| Ручное открытие панели | Пользователь должен сам искать результаты |

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Просмотр результатов анализа (Priority: P1)

Как создатель курса, я хочу видеть результаты анализа моих материалов в понятном человеческом виде, чтобы понимать, как система интерпретировала мой контент.

**Why this priority**: Это базовый функционал — пользователь должен понимать, что система сделала с его материалами. Без этого невозможно принять решение о дальнейших действиях.

**Independent Test**: Загрузить материалы курса, дождаться завершения анализа, открыть панель результатов и убедиться, что информация читаема и понятна без технических знаний.

**Acceptance Scenarios**:

1. **Given** анализ материалов завершён, **When** пользователь открывает панель Stage 4, **Then** он видит результаты на русском языке в структурированном виде с понятными заголовками секций.

2. **Given** панель результатов анализа открыта, **When** пользователь просматривает секцию "Классификация курса", **Then** он видит категорию курса, уровень уверенности системы и контекстные сообщения (мотиваторы, важность темы).

3. **Given** панель результатов анализа открыта, **When** пользователь просматривает секцию "Рекомендуемая структура", **Then** он видит количество уроков, секций, рекомендуемую длительность и разбивку по модулям.

4. **Given** панель результатов анализа открыта, **When** пользователь видит название этапа обработки, **Then** оно содержит понятное описание ("Классификация", "Планирование объёма"), а не техническое "Attempt 1".

---

### User Story 2 — Просмотр структуры курса (Priority: P1)

Как создатель курса, я хочу видеть сгенерированную структуру курса в виде дерева секций и уроков, чтобы оценить логику построения программы.

**Why this priority**: Структура курса — ключевой артефакт, от которого зависит качество обучения. Пользователь должен видеть её чётко.

**Independent Test**: Завершить генерацию структуры, открыть панель Stage 5, убедиться, что видна иерархия секций → уроков с метаданными.

**Acceptance Scenarios**:

1. **Given** генерация структуры завершена, **When** пользователь открывает панель Stage 5, **Then** он видит название курса, описание и целевую аудиторию.

2. **Given** панель структуры открыта, **When** пользователь просматривает секции, **Then** каждая секция показывает название, количество уроков и общую длительность.

3. **Given** панель структуры открыта, **When** пользователь раскрывает секцию, **Then** он видит список уроков с названиями, длительностью, целями обучения и ключевыми темами.

4. **Given** панель структуры открыта, **When** пользователь видит урок, **Then** отображается порядковый номер урока (1.1, 1.2, 2.1...) для понимания места в программе.

---

### User Story 3 — Редактирование результатов анализа (Priority: P2)

Как методолог, я хочу корректировать результаты анализа AI, чтобы исправить ошибки и адаптировать рекомендации под специфику курса.

**Why this priority**: AI может ошибаться. Эксперт должен иметь возможность корректировать результаты без перезапуска всего процесса.

**Independent Test**: Открыть результат анализа, изменить значение поля, убедиться, что изменение сохранилось.

**Acceptance Scenarios**:

1. **Given** результат анализа отображается, **When** пользователь кликает на текстовое поле, **Then** оно становится редактируемым.

2. **Given** пользователь редактирует поле, **When** он закончил ввод и покинул поле, **Then** изменения автоматически сохраняются без нажатия кнопки.

3. **Given** изменения сохраняются, **When** процесс сохранения запущен, **Then** пользователь видит индикатор "Сохранение..." → "Сохранено".

4. **Given** результат содержит список элементов (ключевые концепции, типы заданий), **When** пользователь хочет изменить список, **Then** он может добавлять и удалять элементы через понятный интерфейс.

5. **Given** результат содержит выбор из предустановленных значений (сложность, аудитория), **When** пользователь хочет изменить значение, **Then** он видит выпадающий список с понятными вариантами.

---

### User Story 4 — Редактирование структуры курса (Priority: P2)

Как инструктор, я хочу корректировать сгенерированную структуру курса, чтобы адаптировать её под мои потребности.

**Why this priority**: Структура курса редко генерируется идеально с первого раза. Редактирование критично для практического использования.

**Independent Test**: Открыть структуру курса, изменить название урока и его цели обучения, убедиться в сохранении.

**Acceptance Scenarios**:

1. **Given** структура курса отображается, **When** пользователь кликает на название урока, **Then** он может отредактировать название.

2. **Given** пользователь редактирует урок, **When** он изменяет цели обучения, **Then** они сохраняются автоматически.

3. **Given** пользователь изменяет длительность урока, **When** изменение сохранено, **Then** общая длительность секции и курса пересчитывается автоматически.

4. **Given** пользователь хочет удалить урок, **When** он нажимает кнопку удаления, **Then** урок удаляется без ограничений (минимум 10 уроков применяется только к AI-генерации).

---

### User Story 5 — Перегенерация отдельного блока через AI (Priority: P2)

Как создатель курса, я хочу попросить AI переделать конкретный блок результата, не перезапуская весь процесс анализа.

**Why this priority**: Полная перегенерация занимает много времени. Точечные изменения экономят время и деньги.

**Independent Test**: Открыть результат, нажать кнопку перегенерации на конкретном блоке, ввести инструкцию, получить обновлённый результат.

**Acceptance Scenarios**:

1. **Given** результат анализа отображается, **When** пользователь наводит на блок, **Then** появляется кнопка "Перегенерировать".

2. **Given** пользователь нажал "Перегенерировать", **When** открывается мини-чат, **Then** пользователь видит поле ввода для инструкции AI.

3. **Given** мини-чат открыт, **When** пользователь видит быстрые действия, **Then** доступны кнопки "Упростить", "Расширить", "Сократить", "Добавить примеры", "Добавить профессионализм".

4. **Given** пользователь ввёл инструкцию и отправил, **When** AI генерирует новый вариант, **Then** пользователь видит индикатор загрузки и может отменить операцию.

5. **Given** новый вариант сгенерирован, **When** пользователь просматривает результат, **Then** он видит:
   - Добавленные и удалённые концепции
   - Показатель согласованности (Alignment Score 1-5)
   - Индикатор сохранения уровня Bloom's
   - Кнопки "Принять", "Редактировать", "Отменить"

---

### User Story 6 — Автоматическое открытие результатов (Priority: P3)

Как пользователь, я хочу, чтобы панель результатов открывалась автоматически при завершении этапа, чтобы не искать её вручную.

**Why this priority**: Улучшение UX, но не блокирует основной функционал.

**Independent Test**: Запустить генерацию, дождаться завершения Stage 4 или 5, убедиться, что панель открылась автоматически.

**Acceptance Scenarios**:

1. **Given** идёт обработка Stage 4, **When** обработка завершается успешно, **Then** панель с результатами открывается автоматически с плавной анимацией.

2. **Given** идёт обработка Stage 5, **When** обработка завершается успешно, **Then** панель с результатами открывается автоматически.

3. **Given** панель открылась автоматически, **When** пользователь просматривает контент, **Then** фокус устанавливается на первый редактируемый элемент.

---

### User Story 7 — Индикация зависимостей и устаревших данных (Priority: P3)

Как методолог, я хочу видеть, какие элементы курса связаны друг с другом, чтобы понимать последствия изменений.

**Why this priority**: Продвинутый функционал для обеспечения консистентности курса. Важно, но не блокирует базовое использование.

**Independent Test**: Изменить цель обучения модуля, убедиться, что зависимые уроки помечены как требующие проверки.

**Acceptance Scenarios**:

1. **Given** пользователь изменил цель обучения модуля, **When** изменение сохранено, **Then** зависимые уроки помечаются визуальным индикатором:
   - Зелёная рамка — элемент согласован
   - Жёлтая рамка — рекомендуется проверка
   - Красная рамка — требуется обязательная проверка

2. **Given** элемент помечен индикатором, **When** пользователь наводит на индикатор, **Then** он видит пояснение, почему элемент требует внимания, и какой родительский элемент был изменён.

3. **Given** элемент требует проверки, **When** пользователь видит доступные действия, **Then** он может выбрать "Обновить автоматически", "Проверить вручную" или "Игнорировать".

---

### User Story 8 — Предупреждение о каскадных изменениях (Priority: P3)

Как методолог, я хочу получать предупреждение перед изменением ключевых элементов, чтобы понимать масштаб последствий.

**Why this priority**: Защита от случайных изменений с большим влиянием. Важно для production-use.

**Independent Test**: Попытаться изменить цель обучения курса, увидеть предупреждение о количестве затронутых элементов.

**Acceptance Scenarios**:

1. **Given** пользователь изменяет цель обучения курса, **When** он пытается сохранить изменение, **Then** появляется диалог с информацией о затронутых элементах (X уроков, Y упражнений).

2. **Given** диалог предупреждения открыт, **When** пользователь выбирает действие, **Then** доступны варианты: "Обновить только цель", "Обновить всё автоматически", "Проверить каждый элемент".

3. **Given** изменение имеет критическое влияние (много зависимостей), **When** диалог отображается, **Then** он имеет визуально выделенный стиль "опасной зоны".

---

### Edge Cases

- **Что происходит при потере соединения во время сохранения?** — Система показывает ошибку и предлагает повторить. Несохранённые изменения не теряются.

- **Что если AI не может перегенерировать блок?** — Система показывает понятное сообщение об ошибке и предлагает попробовать с другой формулировкой.

- **Что если пользователь закрывает панель во время перегенерации?** — Операция отменяется, предыдущее значение сохраняется.

- **Что если два пользователя редактируют одновременно?** — Последнее сохранение побеждает (silent overwrite). Уведомление о перезаписи не отображается. Пользователи видят актуальные данные при обновлении страницы.

- **Что если курс содержит более 100 уроков?** — Интерфейс остаётся отзывчивым благодаря постепенной загрузке контента.

---

## Requirements *(mandatory)*

### Functional Requirements

**Отображение результатов:**

- **FR-001**: Система ДОЛЖНА отображать результаты анализа (Stage 4) в структурированном виде с понятными заголовками секций на русском языке.

- **FR-002**: Система ДОЛЖНА отображать структуру курса (Stage 5) в виде иерархии: секции → уроки → детали урока.

- **FR-003**: Система ДОЛЖНА показывать названия этапов обработки в понятном виде ("Классификация", "Планирование объёма") вместо технических идентификаторов.

- **FR-004**: Система ДОЛЖНА автоматически открывать панель результатов при успешном завершении Stage 4 или Stage 5.

**Редактирование:**

- **FR-005**: Пользователь ДОЛЖЕН иметь возможность редактировать текстовые поля результатов анализа.

- **FR-006**: Пользователь ДОЛЖЕН иметь возможность добавлять и удалять элементы списков (ключевые концепции, типы заданий).

- **FR-007**: Пользователь ДОЛЖЕН иметь возможность выбирать значения из предустановленных вариантов для перечислимых полей.

- **FR-008**: Система ДОЛЖНА автоматически сохранять изменения через 1 секунду после окончания ввода.

- **FR-009**: Система ДОЛЖНА отображать статус сохранения: "Сохранение..." → "Сохранено".

- **FR-010**: Система ДОЛЖНА пересчитывать вычисляемые значения (длительность секции, курса) при изменении длительности уроков.

- **FR-011**: AI-генерация (Stage 5) ДОЛЖНА создавать минимум 10 уроков. Пользователь может удалять уроки без ограничений при ручном редактировании.

- **FR-011a**: Система ДОЛЖНА показывать confirmation dialog перед удалением урока, только если урок содержит контент (цели обучения, ключевые темы). Пустые уроки удаляются без подтверждения.

- **FR-011b**: Система ДОЛЖНА предоставлять кнопку "+ Урок" / "+ Секция" для добавления новых элементов. При нажатии открывается чат с вопросом "Какой урок/секцию добавить?", AI генерирует элемент в стиле курса.

**Перегенерация:**

- **FR-012**: Система ДОЛЖНА предоставлять кнопку перегенерации для каждого редактируемого блока.

- **FR-013**: Система ДОЛЖНА открывать мини-чат под блоком при нажатии на кнопку перегенерации.

- **FR-014**: Система ДОЛЖНА предоставлять быстрые действия: "Упростить", "Расширить", "Сократить", "Добавить примеры", "Добавить профессионализм".

- **FR-015**: Система ДОЛЖНА перегенерировать только выбранный блок, не затрагивая остальные.

- **FR-016**: Система ДОЛЖНА показывать семантическое сравнение изменений после перегенерации:
  - Добавленные и удалённые концепции (concepts added/removed)
  - Показатель согласованности (Alignment Score) по шкале 1-5
  - Индикатор сохранения уровня Bloom's Taxonomy
  - Кнопки "Принять", "Редактировать", "Отменить"

- **FR-017**: Пользователь ДОЛЖЕН иметь возможность принять или отклонить результат перегенерации.

**Зависимости и каскадные изменения:**

- **FR-018**: Система ДОЛЖНА отслеживать зависимости между элементами курса (цели обучения → уроки → контент).

- **FR-019**: Система ДОЛЖНА помечать зависимые элементы визуальными индикаторами при изменении родительского элемента:
  - Зелёный индикатор — элемент согласован с родителем
  - Жёлтый индикатор — изменение родительского элемента (название, описание, длительность), рекомендуется проверка
  - Красный индикатор — изменение Learning Objective (цели обучения), требуется обязательная проверка

- **FR-020**: Система ДОЛЖНА показывать предупреждение с количеством затронутых элементов при изменении ключевых элементов (цели обучения курса/модуля).

- **FR-021**: Система ДОЛЖНА предоставлять варианты обработки каскадных изменений: обновить только текущий элемент, обновить всё автоматически, проверить каждый элемент.

**Общий чат:**

- **FR-022**: Система ДОЛЖНА отображать общий чат перегенерации (RefinementChat) в раскрытом виде по умолчанию для быстрого доступа к AI-функциям.

**Локализация:**

- **FR-023**: Все тексты интерфейса ДОЛЖНЫ быть на русском языке как основном с возможностью переключения на английский.

**Доступность (Accessibility):**

- **FR-024**: Система ДОЛЖНА поддерживать навигацию с клавиатуры (Tab для перехода между элементами, Enter для активации, Escape для отмены).

- **FR-025**: Система ДОЛЖНА предоставлять ARIA-метки для всех интерактивных элементов.

- **FR-026**: Система ДОЛЖНА обеспечивать видимый фокус на активном элементе.

**Авторизация:**

- **FR-027**: Система ДОЛЖНА разрешать редактирование результатов Stage 4/5 только владельцу курса (course.user_id === userId).

- **FR-028**: Система ДОЛЖНА предоставлять read-only доступ к результатам для администраторов организации (мониторинг без редактирования).

**Token-based Billing для AI-перегенерации [v2]:**

- **FR-029 [v2]**: Система ДОЛЖНА показывать оценку стоимости перегенерации в токенах перед отправкой запроса.

- **FR-030 [v2]**: Система ДОЛЖНА проверять баланс токенов пользователя/организации перед выполнением перегенерации.

- **FR-031 [v2]**: Система ДОЛЖНА блокировать перегенерацию при недостаточном балансе токенов с понятным сообщением.

- **FR-032 [v2]**: Система ДОЛЖНА показывать soft warning при низком балансе токенов (< 10% от лимита).

**Производительность для больших курсов:**

- **FR-033**: Система ДОЛЖНА использовать виртуализацию (@tanstack/react-virtual) для списков секций при количестве > 20.

- **FR-034**: Система ДОЛЖНА использовать виртуализацию для списков уроков внутри секции при количестве > 15.

- **FR-035**: Система ДОЛЖНА загружать детальный контент урока только при раскрытии элемента (lazy render).

### Key Entities

- **Результат анализа (AnalysisResult)**: Структурированный результат Stage 4, содержащий 6 секций:
  - Классификация курса (CourseClassification)
  - Анализ темы (TopicAnalysis)
  - Рекомендуемая структура (RecommendedStructure)
  - Педагогическая стратегия (PedagogicalStrategy)
  - Рекомендации по генерации (GenerationRecommendations)
  - Связь документов (DocumentRelations)

- **Структура курса (CourseStructure)**: Иерархический результат Stage 5, содержащий метаданные курса, секции, уроки с целями обучения и ключевыми темами.

- **Этап обработки (Phase)**: Отдельный шаг в процессе анализа или генерации с понятным названием и описанием.

- **Граф зависимостей (DependencyGraph)**: Связи между элементами курса с типами отношений:
  - PARENT_OF — родительский элемент (курс → модуль → урок)
  - ALIGNS_TO — элемент реализует цель обучения
  - ASSESSES — элемент оценивает достижение цели
  - PREREQUISITE_FOR — элемент является предпосылкой для другого

- **Типы редакторов (EditorTypes)**: Типы полей для редактирования контента:
  - Текст (text) — однострочное текстовое поле
  - Многострочный текст (textarea) — многострочный редактор
  - Теги (chips) — добавление/удаление элементов списка
  - Выбор (select) — выпадающий список предустановленных значений
  - Число (number) — числовое поле с валидацией
  - Переключатель (toggle) — бинарный выбор вкл/выкл

- **Стратегия контекста (Context Strategy)**: Система оптимизации контекста для AI-перегенерации с 4 уровнями:
  - Atomic (локальное поле) — минимальный контекст, ~200 tokens
  - Local (секция/урок) — контекст ближайших элементов, ~1,000 tokens
  - Structural (модуль) — контекст структуры курса, ~2,500 tokens
  - Global (курс) — полный контекст курса, ~5,000 tokens

- **Общий чат перегенерации (RefinementChat)**: Расширенный чат для взаимодействия с AI по всему курсу, доступный в раскрытом виде по умолчанию

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

**Понятность интерфейса:**

- **SC-001**: 90% нетехнических пользователей понимают результаты анализа без дополнительных пояснений (проверяется пользовательским тестированием).

- **SC-002**: Время на ознакомление с результатами анализа сокращается на 50% по сравнению с текущим JSON-интерфейсом.

**Эффективность редактирования:**

- **SC-003**: Пользователь может отредактировать и сохранить любое поле за менее чем 5 секунд.

- **SC-004**: 95% операций сохранения завершаются успешно без повторных попыток.

**Эффективность перегенерации:**

- **SC-005**: Время перегенерации отдельного блока не превышает 10 секунд в 90% случаев.

- **SC-006**: Пользователь может инициировать перегенерацию блока не более чем за 3 клика.

**Отзывчивость интерфейса:**

- **SC-007**: Панель результатов открывается за менее чем 1 секунду.

- **SC-008**: Интерфейс остаётся отзывчивым при работе с курсами, содержащими до 100 уроков.

**Пользовательский опыт:**

- **SC-009**: Автоматическое открытие панели результатов работает в 100% случаев успешного завершения Stage 4/5.

- **SC-010**: 80% пользователей предпочитают новый интерфейс старому JSON-представлению (проверяется опросом).

---

## Assumptions

- Пользователи имеют базовое понимание структуры онлайн-курсов (секции, уроки, цели обучения).
- Соединение с интернетом стабильно в большинстве случаев использования.
- AI-модель способна перегенерировать блоки контента с учётом контекста курса.
- Существующие данные (AnalysisResult, CourseStructure) уже хранятся в системе и доступны для отображения.

---

## Out of Scope

- Полный редизайн всего процесса генерации курса (только Stage 4-5).
- Множественная локализация (только RU/EN).
- Совместное редактирование в реальном времени несколькими пользователями.
- Версионирование изменений и откат к предыдущим версиям (за исключением отката перегенерации).
- Интеграция с внешними системами управления обучением (LMS).
- **[Deferred to v2]** Token-based billing для AI-перегенерации (FR-029-032): оценка стоимости, проверка баланса, блокировка при недостатке, soft warning. В v1 перегенерация без ограничений.

---

## Clarifications

### Session 2025-12-05

- Q: Должен ли пользователь получать уведомление при перезаписи его изменений другим пользователем? → A: Нет, используется silent overwrite (last-write-wins без уведомления)
- Q: По какому критерию различать жёлтый и красный уровни Stale Data Indicators? → A: LO-based — красный индикатор только при изменении Learning Objective, жёлтый для остальных изменений родительских элементов
- Q: Должно ли ограничение "минимум 10 уроков" применяться к ручному редактированию пользователем? → A: Нет. AI-генерация сохраняет минимум 10 уроков как quality bar, но пользователь может удалять уроки без ограничений
- Q: Нужно ли подтверждение перед удалением урока? → A: Smart confirmation — dialog только если урок содержит контент (цели, темы), иначе удаляем сразу
- Q: Как пользователь может добавлять новые уроки/секции? → A: AI-assisted add — кнопка "+ Урок" открывает чат с вопросом "Какой урок добавить?", AI генерирует урок в стиле курса
- Q: Кто может редактировать результаты Stage 4/5? → A: Только владелец курса (course.user_id === userId). Admins организации — read-only доступ для мониторинга
- Q: Есть ли rate limiting для AI-перегенерации? → A: Token-based billing: оценка стоимости перед запросом, проверка баланса, блокировка при недостаточном балансе, soft warning при < 10% лимита. Нет лимита на количество запросов в минуту
- Q: Какая стратегия для курсов с 100+ уроками? → A: Виртуализация (@tanstack/react-virtual) + lazy render: секции virtualized при > 20, уроки при > 15, контент загружается при раскрытии

### Session 2025-12-05 (Analysis Review)

- Q: Как должна работать проверка баланса токенов при перегенерации (FR-029-032)? → A: **Deferred to v2**. В текущей итерации перегенерация работает без ограничений. Token billing (estimation, balance check, blocking) будет добавлен в следующей итерации. FR-029-032 перемещены в Out of Scope для v1.

- Q: Как админы организации должны видеть результаты Stage 4/5 (FR-028)? → A: **Reusable read-only mode**. Существует отдельная админка, куда нужно интегрировать просмотр. Best practice для production:
  1. Те же компоненты (AnalysisResultView, CourseStructureView) с пропом `readOnly={true}`
  2. Backend возвращает `canEdit: boolean` на основе роли (owner vs admin)
  3. Frontend скрывает кнопки редактирования/перегенерации если `!canEdit`
  4. API endpoints проверяют роль и отклоняют мутации для non-owners с 403

- Q: Как пользователь переключает язык интерфейса (FR-023)? → A: **UI Switcher**. Кнопка RU/EN в header или settings. Выбор сохраняется в localStorage и применяется ко всем компонентам Stage 4/5
