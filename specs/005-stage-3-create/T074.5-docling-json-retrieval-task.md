# Task: T074.5 - Fix DoclingDocument Stub Issue (Technical Debt)

**Priority**: P1 (Important - Blocks Premium/Standard tier quality features)
**Type**: Bug Fix / Technical Debt
**Estimated Effort**: 2-3 days
**Status**: ‚úÖ COMPLETED (2025-10-28)
**Created**: 2025-10-28
**Completed**: 2025-10-28
**Related**: [GitHub PR Comment - markdown-converter.ts:209-213](https://github.com)

## ‚úÖ Implementation Summary

**Solution**: Extended MCP integration using existing `save_docling_document` tool + Docker volume mount.

**Artifacts**:
- [Implementation Report](../../docs/investigations/T074.5-mcp-json-export-implementation.md)
- [Updated Reference](../../docs/DOCLING-MCP-REFERENCE.md)
- [Client Implementation](../../packages/course-gen-platform/src/shared/docling/client.ts#L493-L610)
- [Markdown Converter Fix](../../packages/course-gen-platform/src/shared/embeddings/markdown-converter.ts#L199-L214)
- [Integration Tests](../../packages/course-gen-platform/tests/integration/docling-json-export.test.ts)

**Benefits**:
- ‚úÖ No MCP server fork required (uses original image)
- ‚úÖ Full metadata: texts[], pictures[], tables[], pages{}
- ‚úÖ Preserves caching via document_key
- ‚úÖ Easy upgrades (no custom maintenance)

**Test Results**: 3/3 tests passed ‚úÖ

---

## üìã Problem Statement

### Issue Description

The markdown conversion pipeline currently creates an **empty stub** for `DoclingDocument` instead of retrieving the real structured data from Docling MCP server. This affects document metadata quality for Standard and Premium tiers.

**Current behavior** (markdown-converter.ts:209-223):
```typescript
// ‚ùå PROBLEM: Creates empty stub
const doclingDoc: DoclingDocument = {
  schema_version: '2.0',
  name: filePath,
  pages: [],        // Empty - no real pages
  texts: [],        // Empty - no text elements
  pictures: [],     // Empty - no images
  tables: [],       // Empty - no tables
  metadata: {
    page_count: 1,  // Hardcoded - not real count
    // ...
  },
};
```

### Impact Analysis

This stub causes **cascading failures** in downstream systems:

1. **`extractImageMetadata()`** ‚Üí Returns `[]` (no images found)
   - File: `packages/course-gen-platform/src/shared/embeddings/markdown-converter.ts:350-364`
   - Result: Premium tier cannot extract OCR text or image metadata

2. **`extractDocumentStructure()`** ‚Üí Cannot find real page numbers
   - File: `packages/course-gen-platform/src/shared/embeddings/markdown-converter.ts:372-435`
   - Result: Incorrect page number attribution for sections

3. **`embedOCRTextInMarkdown()`** ‚Üí No OCR text to embed
   - File: `packages/course-gen-platform/src/shared/embeddings/markdown-converter.ts:453-471`
   - Result: Missing OCR text from images

4. **Summary metadata** ‚Üí All zeros
   - `images_extracted: 0` (should be actual count)
   - `tables_extracted: 0` (should be actual count)
   - `pages_processed: 1` (hardcoded, should be real page count)

5. **Tier-specific features broken**:
   - **Standard tier**: Cannot extract OCR from images
   - **Premium tier**: Cannot process images, missing advanced metadata
   - File: `packages/course-gen-platform/src/orchestrator/handlers/document-processing.ts:391-457`

### Root Cause

Docling MCP server **does NOT provide** a tool to retrieve full DoclingDocument JSON:

- ‚úÖ `convert_document_into_docling_document` ‚Üí Returns only `document_key` (string)
- ‚úÖ `export_docling_document_to_markdown` ‚Üí Returns markdown (string)
- ‚ùå `export_docling_document_to_json` ‚Üí **Does NOT exist**

**References**:
- Current implementation: `packages/course-gen-platform/src/shared/docling/client.ts:338-346`
- Documentation: `docs/DOCLING-MCP-REFERENCE.md:104-107`
- TODO comment in code: `markdown-converter.ts:203,208`

---

## üéØ Success Criteria

### Functional Requirements

- [ ] `convertDocumentToMarkdown()` returns **real DoclingDocument** with populated fields:
  - `pages[]` - actual page data with dimensions
  - `texts[]` - text elements with types, fonts, bboxes
  - `pictures[]` - images with OCR text, captions, formats
  - `tables[]` - table structures with cells
  - `metadata.page_count` - real count (not hardcoded `1`)

- [ ] `extractImageMetadata()` returns **non-empty array** for PDFs with images
- [ ] `embedOCRTextInMarkdown()` successfully embeds OCR text from images
- [ ] Standard/Premium tiers process documents with **correct metadata**

### Test Requirements

- [ ] Integration test: Convert 5-page PDF with 3 images ‚Üí verify all fields populated
- [ ] Unit test: `extractImageMetadata()` returns 3 `ImageMetadata` objects
- [ ] Unit test: `extractDocumentStructure()` detects 5 pages (not `1`)
- [ ] Contract test: Standard tier extracts OCR text from images
- [ ] Contract test: Premium tier extracts full image metadata

---

## üîç Research: Available Solutions

### Option A: Add `export_docling_document_to_json` Tool to Docling MCP (Recommended ‚≠ê)

**Description**: Contribute upstream to docling-mcp project

**Implementation**:
```python
# In docling-mcp server (Python)
@server.call_tool()
async def export_docling_document_to_json(document_key: str) -> dict:
    """Export full DoclingDocument structure as JSON"""
    doc = cache.get(document_key)
    if not doc:
        raise ValueError(f"Document not found: {document_key}")

    # Use Docling's native serialization
    return doc.model_dump(mode='json')  # or doc.to_json()
```

**TypeScript Client Integration**:
```typescript
// packages/course-gen-platform/src/shared/docling/client.ts

async convertToDoclingDocument(filePath: string): Promise<DoclingDocument> {
  // Step 1: Convert document
  const convertResult = await this.client.callTool({
    name: 'convert_document_into_docling_document',
    arguments: { source: filePath }
  });

  const { document_key } = parseToolResponse(convertResult);

  // Step 2: Export JSON (NEW TOOL)
  const exportResult = await this.client.callTool({
    name: 'export_docling_document_to_json',
    arguments: { document_key }
  });

  const doclingDoc = parseToolResponse<DoclingDocument>(exportResult);
  return doclingDoc;
}
```

**Pros**:
- ‚úÖ Proper architectural solution
- ‚úÖ Full metadata available
- ‚úÖ All Premium features work
- ‚úÖ Reuses MCP caching

**Cons**:
- ‚ö†Ô∏è Requires upstream PR to docling-mcp project
- ‚ö†Ô∏è Wait time for merge/release (1-2 weeks)
- ‚ö†Ô∏è Need to maintain fork if PR not accepted

**Timeline**: 3-5 days (2 days PR, 1-3 days merge wait)

---

### Option B: Use Docling Python API Directly (Bypass MCP)

**Description**: Call Docling Python library via child process

**Implementation**:
```typescript
// packages/course-gen-platform/src/shared/docling/python-bridge.ts

import { spawn } from 'child_process';

export async function convertWithPythonAPI(filePath: string): Promise<DoclingDocument> {
  return new Promise((resolve, reject) => {
    const python = spawn('python3', [
      '-c',
      `
from docling.document_converter import DocumentConverter
import json

converter = DocumentConverter()
result = converter.convert("${filePath}")
doc_json = result.document.export_to_json()
print(json.dumps(doc_json))
      `
    ]);

    let output = '';
    python.stdout.on('data', (data) => output += data);
    python.on('close', (code) => {
      if (code === 0) {
        resolve(JSON.parse(output));
      } else {
        reject(new Error('Python conversion failed'));
      }
    });
  });
}
```

**Pros**:
- ‚úÖ Full control over Docling
- ‚úÖ No upstream dependency
- ‚úÖ Immediate implementation

**Cons**:
- ‚ö†Ô∏è Loses MCP caching benefits
- ‚ö†Ô∏è Additional process overhead
- ‚ö†Ô∏è Complex Python environment management
- ‚ö†Ô∏è Harder to debug

**Timeline**: 1-2 days

---

### Option C: Parse Markdown for Metadata (Temporary Workaround)

**Description**: Extract metadata from markdown output

**Implementation**:
```typescript
// Enhance extractDocumentStructure() to parse markdown
function parseMarkdownMetadata(markdown: string): Partial<DoclingDocument> {
  // Extract images: ![alt](src) patterns
  const images = markdown.match(/!\[([^\]]*)\]\(([^)]+)\)/g) || [];

  // Extract tables: markdown table patterns
  const tables = markdown.match(/\|[^\n]+\|/g) || [];

  // Estimate pages from markdown length (rough heuristic)
  const estimatedPages = Math.ceil(markdown.length / 3000);

  return {
    pictures: images.map((img, i) => ({
      id: `img_${i}`,
      caption: extractCaption(img),
      // No bbox, OCR text, or format available
    })),
    tables: tables.map((tbl, i) => ({
      id: `tbl_${i}`,
      // Limited structure
    })),
    metadata: {
      page_count: estimatedPages,
    }
  };
}
```

**Pros**:
- ‚úÖ Quick implementation (4-6 hours)
- ‚úÖ No external dependencies
- ‚úÖ Works with current MCP setup

**Cons**:
- ‚ùå No OCR text from images
- ‚ùå No bbox coordinates
- ‚ùå No base64 image data
- ‚ùå Approximate metadata only
- ‚ùå Cannot extract font information

**Timeline**: 1 day

---

## üìù Recommended Implementation Plan

### Phase 1: Research & Decision (Day 1 Morning - 2 hours)

**Tasks**:
1. Check docling-mcp GitHub for existing JSON export feature
2. Test if `export_docling_document_to_json` tool exists (likely not)
3. Review docling-mcp contribution guidelines
4. Decide: Option A (upstream PR) vs Option B (Python API)

**Deliverable**: `docs/investigations/docling-json-export-decision.md`

**Decision Criteria**:
- If docling-mcp is actively maintained (commits <30 days) ‚Üí **Option A**
- If upstream PRs are slow (>2 weeks merge time) ‚Üí **Option B**
- If need immediate solution ‚Üí **Option C** (temporary), then **Option A** later

---

### Phase 2: Implementation (Day 1 Afternoon - Day 2 - 1.5 days)

#### Path A: Upstream PR (Recommended)

**Step 1**: Fork docling-mcp repository
```bash
git clone https://github.com/docling-project/docling-mcp.git
cd docling-mcp
git checkout -b feat/add-json-export-tool
```

**Step 2**: Add JSON export tool
- File: `docling_mcp/server.py`
- Add new tool: `export_docling_document_to_json`
- Test locally with MCP inspector

**Step 3**: Submit PR
- Title: "feat: Add export_docling_document_to_json tool for full document retrieval"
- Description: Explain use case, include tests
- Link to this task document

**Step 4**: Update TypeScript client
- File: `packages/course-gen-platform/src/shared/docling/client.ts`
- Implement `convertToDoclingDocument()` method (currently throws error at line 343)
- Update error message (remove "not yet implemented")

**Step 5**: Update markdown-converter
- File: `packages/course-gen-platform/src/shared/embeddings/markdown-converter.ts`
- Replace stub (lines 209-223) with real API call:
```typescript
const doclingDoc = await client.convertToDoclingDocument(filePath, {
  enableOCR: opts.include_ocr,
  extractImages: opts.include_images,
  extractTables: opts.include_tables
});
```
- Remove TODO comments (lines 203, 208)

**Step 6**: Update tests
- File: `packages/course-gen-platform/tests/shared/docling/client.test.ts`
- Add test for `convertToDoclingDocument()` (currently missing)

**Files to modify**:
- `packages/course-gen-platform/src/shared/docling/client.ts` (lines 338-346, 447-471)
- `packages/course-gen-platform/src/shared/embeddings/markdown-converter.ts` (lines 203, 208, 209-223)
- `packages/course-gen-platform/tests/shared/docling/client.test.ts` (new tests)

---

#### Path B: Python API Bridge (Fallback)

**Step 1**: Create Python bridge
- File: `packages/course-gen-platform/src/shared/docling/python-bridge.ts`
- Implement `convertWithPythonAPI()`

**Step 2**: Add Python script
- File: `packages/course-gen-platform/scripts/docling-convert.py`
- Standalone script for document conversion

**Step 3**: Update client to use bridge
- File: `packages/course-gen-platform/src/shared/docling/client.ts`
- Modify `convertToDoclingDocument()` to call Python bridge

**Step 4**: Update environment setup
- Update `docker-compose.yml` to include Python dependencies
- Document Python requirements in README

---

### Phase 3: Testing (Day 2 Afternoon - Day 3 - 1 day)

**Test Files to Create**:
1. `tests/integration/docling-json-retrieval.test.ts` (new)
2. `tests/unit/markdown-converter.test.ts` (update existing)
3. `tests/contract/premium-tier-images.test.ts` (update existing)

**Test Cases**:

```typescript
// tests/integration/docling-json-retrieval.test.ts

describe('Docling JSON Retrieval', () => {
  it('should retrieve full DoclingDocument for PDF with images', async () => {
    const testPdf = 'tests/fixtures/sample-with-images.pdf'; // 5 pages, 3 images

    const result = await convertDocumentToMarkdown(testPdf);

    // Verify DoclingDocument populated
    expect(result.json.pages).toHaveLength(5); // Not 1
    expect(result.json.pictures).toHaveLength(3); // Not []
    expect(result.json.texts.length).toBeGreaterThan(0); // Not []
    expect(result.json.metadata.page_count).toBe(5); // Not 1

    // Verify image metadata extraction
    expect(result.images).toHaveLength(3);
    expect(result.images[0]).toHaveProperty('ocr_text');
    expect(result.images[0]).toHaveProperty('bbox');
  });

  it('should extract table metadata', async () => {
    const testPdf = 'tests/fixtures/sample-with-tables.pdf';

    const result = await convertDocumentToMarkdown(testPdf);

    expect(result.json.tables.length).toBeGreaterThan(0);
    expect(result.json.tables[0]).toHaveProperty('num_rows');
    expect(result.json.tables[0]).toHaveProperty('cells');
  });

  it('should populate metadata statistics', async () => {
    const testPdf = 'tests/fixtures/sample-multipage.pdf';

    const result = await convertDocumentToMarkdown(testPdf);

    expect(result.metadata.pages_processed).toBeGreaterThan(1); // Not 1
    expect(result.metadata.text_elements).toBeGreaterThan(0); // Not 0
  });
});
```

**Run Tests**:
```bash
pnpm test tests/integration/docling-json-retrieval.test.ts
pnpm test tests/unit/markdown-converter.test.ts
pnpm test tests/contract/premium-tier-images.test.ts
```

---

### Phase 4: Validation & Documentation (Day 3 - 0.5 days)

**Tasks**:
1. Update documentation
   - File: `docs/DOCLING-MCP-REFERENCE.md` (lines 102-121)
   - Remove "Not Implemented (T074.5)" section
   - Add "Full DoclingDocument Retrieval" section

2. Update Premium tier docs
   - File: `docs/FUTURE/PREMIUM-docling-advanced-features.md`
   - Update status from "Blocked" to "Ready"

3. Test with real documents
   - Upload 10-page PDF with images to local dev environment
   - Verify Standard tier extracts OCR
   - Verify Premium tier extracts full metadata

4. Update task list
   - File: `specs/005-stage-3-create/tasks.md`
   - Mark T074.5 as complete (or remove from "NEEDS CLARIFICATION")

---

## üì¶ Deliverables Checklist

### Code Changes
- [ ] `packages/course-gen-platform/src/shared/docling/client.ts`
  - [ ] Implement `convertToDoclingDocument()` method
  - [ ] Remove "not yet implemented" error

- [ ] `packages/course-gen-platform/src/shared/embeddings/markdown-converter.ts`
  - [ ] Replace DoclingDocument stub (lines 209-223)
  - [ ] Remove TODO comments (lines 203, 208)

- [ ] Upstream contribution (if Option A):
  - [ ] Fork docling-mcp repository
  - [ ] Add `export_docling_document_to_json` tool
  - [ ] Submit PR with tests

### Tests
- [ ] `tests/integration/docling-json-retrieval.test.ts` (new)
- [ ] `tests/unit/markdown-converter.test.ts` (update)
- [ ] `tests/contract/premium-tier-images.test.ts` (update)

### Documentation
- [ ] `docs/DOCLING-MCP-REFERENCE.md` (update)
- [ ] `docs/investigations/docling-json-export-decision.md` (new)
- [ ] `specs/005-stage-3-create/tasks.md` (update)

---

## üîó Reference Files

### Core Files to Modify
1. **Client**: `packages/course-gen-platform/src/shared/docling/client.ts`
   - Lines 338-346: Remove `throw new Error` for docling_document format
   - Lines 447-471: Implement `convertToDoclingDocument()`

2. **Converter**: `packages/course-gen-platform/src/shared/embeddings/markdown-converter.ts`
   - Lines 203-208: Remove TODO comments
   - Lines 209-223: Replace empty stub with real API call
   - Lines 230-240: Verify `extractImageMetadata()` works with real data

3. **Types**: `packages/course-gen-platform/src/shared/docling/types.ts`
   - Lines 10-31: DoclingDocument interface (reference only)
   - Lines 79-105: DoclingText interface (reference only)
   - Lines 110-131: DoclingPicture interface (reference only)

### Documentation Files
1. **Reference**: `docs/DOCLING-MCP-REFERENCE.md`
   - Lines 34-57: Tool documentation for convert_document_into_docling_document
   - Lines 59-82: Tool documentation for export_docling_document_to_markdown
   - Lines 102-121: Current limitations (needs update)

2. **Premium Features**: `docs/FUTURE/PREMIUM-docling-advanced-features.md`
   - Lines 1-100: Overview of PREMIUM tier requirements
   - Lines 156-163: Vision API integration dependencies

3. **Pricing**: `docs/PRICING-TIERS.md`
   - Document format support by tier
   - OCR and image extraction tiers

### Test Files
1. **Client Tests**: `packages/course-gen-platform/tests/shared/docling/client.test.ts`
   - Existing tests for markdown conversion
   - Add tests for JSON export

2. **Integration Tests**: `packages/course-gen-platform/tests/integration/document-processing-worker.test.ts`
   - Lines with PREMIUM/STANDARD tier tests
   - Verify image extraction works

### Related Investigations
1. `docs/investigations/008-docling-pdf-export-investigation.md`
2. `docs/investigations/docling-optimal-strategies.md`
3. `docs/investigations/docling-cache-pdf-REAL-ISSUE.md`

---

## üö® Risks & Mitigation

### Risk 1: Upstream PR Not Accepted
**Probability**: Low-Medium
**Impact**: High (need fallback)

**Mitigation**:
- Have Option B (Python API) ready as backup
- Implement Option C (markdown parsing) as temporary solution
- Fork docling-mcp and maintain custom version if needed

### Risk 2: Performance Degradation
**Probability**: Low
**Impact**: Medium

**Scenario**: Additional MCP call adds latency

**Mitigation**:
- Current: 2 calls (convert ‚Üí export markdown)
- Proposed: 2 calls (convert ‚Üí export JSON)
- No additional call - just different export format
- Monitor processing times after implementation

### Risk 3: Breaking Changes in Docling API
**Probability**: Low
**Impact**: High

**Mitigation**:
- Pin docling-mcp version in docker-compose.yml
- Test thoroughly before upgrading Docling versions
- Have rollback plan if new version breaks

---

## ‚úÖ Acceptance Criteria

### Must Have
- [ ] `convertDocumentToMarkdown()` returns real DoclingDocument (not stub)
- [ ] Standard tier extracts OCR text from images
- [ ] Premium tier extracts full image metadata
- [ ] All integration tests pass
- [ ] No regression in existing functionality

### Should Have
- [ ] Upstream PR submitted to docling-mcp
- [ ] Documentation updated
- [ ] Performance metrics tracked (latency, memory)

### Nice to Have
- [ ] Caching layer for DoclingDocument JSON
- [ ] Metrics dashboard for metadata quality
- [ ] Automated alerts for stub detection

---

## üìû Support & Questions

**Primary Contact**: Stage 3 Implementation Team
**GitHub Issue**: Link to tracking issue (create if needed)
**Slack Channel**: #megacampus-dev
**Docling MCP**: https://github.com/docling-project/docling-mcp

---

**Created**: 2025-10-28
**Last Updated**: 2025-10-28
**Status**: Ready for Implementation
**Assignee**: TBD (can run in parallel with Stage 3 Research)
