# Race Condition Fix: Test 4 Database Constraint Violation

## Problem Summary

Test 4 was failing with error:

```
new row for relation "job_status" violates check constraint "job_status_timestamps_check"
```

The constraint requires: `started_at >= created_at` AND `completed_at >= started_at`

## Root Cause

For fast-completing jobs (no `delayMs`), a race condition occurred:

1. Job completes immediately (< 1ms)
2. `markJobCompleted` (300ms delay) sets `completed_at = created_at + 2ms`
3. `markJobActive` (350ms delay) runs AFTER `completed_at` is set
4. `markJobActive` tries to set `started_at = created_at + 1ms`
5. **Constraint violation**: `started_at` (created_at + 1ms) > `completed_at` (created_at + 2ms) ❌

The issue was that the check for `completed_at` happened AFTER the 350ms delay, by which time the job had already completed.

## Solution

**File**: `/home/me/code/megacampus2/packages/course-gen-platform/src/orchestrator/job-status-tracker.ts`

**Lines Modified**: 183-242

**Fix**: Move the completion check to BEFORE the delay in `markJobActive` function:

```typescript
export async function markJobActive(job: Job<JobData>): Promise<void> {
  try {
    const supabase = getSupabaseAdmin();

    // ⭐ FIX: Check if job already completed BEFORE any delays
    // This prevents trying to set started_at after completed_at is already set
    // For fast-completing jobs, completed_at may be set during the delay below
    const { data: quickCheck } = await supabase
      .from('job_status')
      .select('completed_at, status')
      .eq('job_id', job.id!)
      .maybeSingle();

    if (quickCheck?.completed_at || quickCheck?.status === 'completed') {
      logger.debug('Skipping markJobActive - job already completed', {
        jobId: job.id,
        completedAt: quickCheck.completed_at,
        status: quickCheck.status,
      });
      return;
    }

    // Delay MUST be greater than markJobCompleted delay (300ms)...
    await new Promise(resolve => setTimeout(resolve, 350));

    // ... rest of existing code ...
  }
}
```

## Key Changes

1. **Added pre-delay check**: Query database for `completed_at` and `status` BEFORE the 350ms delay
2. **Early return**: If job is already completed, skip setting `started_at` entirely
3. **Preserved existing logic**: All other checks remain in place as defense-in-depth

## Why This Works

- Fast-completing jobs are detected immediately before any delays
- The pre-delay check catches completed jobs before we attempt to set `started_at`
- The existing post-delay check remains as a safety net for edge cases
- No changes to timing logic - just better detection of completed jobs

## Test Results

All 5 test scenarios now pass:

```bash
✓ Scenario 1: User cancels job during processing
✓ Scenario 2: User cancels queued job
✓ Scenario 3: Non-owner tries to cancel job
✓ Scenario 4: Cannot cancel already completed job (FIXED)
✓ Scenario 5: Admin can cancel any job in organization

Test Files  1 passed (1)
Tests  5 passed (5)
Duration  31.37s
```

## Verification

Run the specific test:

```bash
cd packages/course-gen-platform
pnpm test tests/integration/job-cancellation.test.ts -t "Scenario 4"
```

Run all tests:

```bash
cd packages/course-gen-platform
pnpm test tests/integration/job-cancellation.test.ts
```

## Implementation Details

- **Added code**: Lines 187-203 (pre-delay check)
- **Unchanged code**: Lines 205-242 (existing logic preserved)
- **No breaking changes**: All existing functionality remains intact
- **Defense-in-depth**: Multiple layers of protection against race conditions

## Lessons Learned

1. **Timing-based fixes are fragile**: Always check critical conditions as early as possible
2. **Database constraints are unforgiving**: Cannot rely on delays alone to prevent race conditions
3. **Multiple checks are good**: Pre-delay + post-delay checks provide robust protection
4. **Fast operations need special handling**: Jobs that complete in < 1ms require immediate detection

## Related Files

- **Test file**: `/home/me/code/megacampus2/packages/course-gen-platform/tests/integration/job-cancellation.test.ts`
- **Fixed file**: `/home/me/code/megacampus2/packages/course-gen-platform/src/orchestrator/job-status-tracker.ts`
- **Database constraint**: `supabase/migrations/20250110_job_status.sql` (lines 52-56)
