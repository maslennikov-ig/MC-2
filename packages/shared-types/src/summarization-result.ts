/**
 * Stage 3 Document Summarization Result Types
 * @module @megacampus/shared-types/summarization-result
 */

import type { SummarizationStrategy } from './summarization-job';

/**
 * Summary metadata stored in file_catalog.summary_metadata JSONB column
 *
 * This interface matches the PostgreSQL JSONB schema for the summary_metadata column.
 * All fields are optional at the database level but will be populated after processing.
 */
export interface SummaryMetadata {
  /** ISO-8601 timestamp when processing completed */
  processing_timestamp: string;

  /** Processing duration in milliseconds */
  processing_duration_ms: number;

  /** Input tokens consumed by LLM */
  input_tokens: number;

  /** Output tokens generated by LLM */
  output_tokens: number;

  /** Total tokens (input + output) */
  total_tokens: number;

  /** Estimated cost in USD */
  estimated_cost_usd: number;

  /** Model identifier used for processing */
  model_used: string;

  /** Quality score (0-1 scale) from quality check */
  quality_score: number;

  /** Whether quality check passed */
  quality_check_passed: boolean;

  /** Number of retry attempts made */
  retry_attempts?: number;

  /** List of strategy changes during retries */
  retry_strategy_changes?: string[];

  /** Detected language (if different from input) */
  detected_language?: string;

  /** Character-to-token ratio for estimation */
  character_to_token_ratio?: number;

  /** Number of chunks processed (hierarchical only) */
  chunk_count?: number;

  /** Chunk size in tokens (hierarchical only) */
  chunk_size_tokens?: number;

  /** Number of hierarchical levels used (hierarchical only) */
  hierarchical_levels?: number;

  /** Budget allocation info from Stage 3 priority-based allocation */
  budget_allocation?: {
    /** Processing mode determined by budget (full_text or summary) */
    mode: 'full_text' | 'summary';
    /** Token budget allocated for this document */
    allocated_budget: number;
    /** Document priority from Stage 2 classification (HIGH or LOW) */
    priority: 'HIGH' | 'LOW';
  };
}

/**
 * Summarization job result returned to BullMQ consumer
 *
 * This interface represents the complete result of a summarization job,
 * which will be written to the file_catalog table.
 */
export interface SummarizationResult {
  /** File catalog entry UUID */
  file_id: string;

  /** Processed content: LLM summary (hierarchical) or full text (full_text) */
  processed_content: string;

  /** Processing strategy used */
  processing_method: SummarizationStrategy;

  /** Detailed metadata about processing */
  summary_metadata: SummaryMetadata;
}
